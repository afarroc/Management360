
<!DOCTYPE html>
<html lang="en">

<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Management360 platform description">
    <meta name="keywords" content="management, platform, business">
    <meta name="author" content="Management360">

    
    <title>Log In</title>

    
    <link rel="icon" href="/static/assets/img/favicon.png">
    <link rel="apple-touch-icon" href="https://cdn.glitch.com/49d34dc6-8fbd-46bb-8221-b99ffd36f1af%2Ftouchicon-180.png?v=1566411949736">

    
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i">
    <link rel="preload" as="style" href="/static/assets/css/style.css">

    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i">
    </noscript>

    
    <link rel="stylesheet" href="/static/assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/assets/vendor/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/assets/vendor/boxicons/css/boxicons.min.css">
    <link rel="stylesheet" href="/static/assets/vendor/remixicon/remixicon.css">
    
    
    <link rel="stylesheet" href="/static/assets/vendor/quill/quill.snow.css">
    <link rel="stylesheet" href="/static/assets/vendor/quill/quill.bubble.css">
    <link rel="stylesheet" href="/static/assets/vendor/simple-datatables/style.css">

    
    <link rel="stylesheet" href="/static/assets/css/style.css">
    <link rel="stylesheet" href="/static/assets/css/alerts-styles.css">
    <link rel="stylesheet" href="/static/assets/css/chat.css">

    
    

    
    
</head>

<body >
    
    
<header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center justify-content-between">
        <a href="/" class="logo d-flex align-items-center">
            <img src="/static/assets/img/logo.png" alt="">
            <span class="d-none d-lg-block">Management360</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->
    <div class="search-bar">
        <form class="search-form d-flex align-items-center" method="GET" action="/search/">
            <input type="text" name="query" placeholder="Search" 
                   title="Enter search keyword" value="">
            <button type="submit" title="Search"><i class="bi bi-search"></i></button>
        </form>
    </div><!-- End Search Bar -->
    <nav class="header-nav ms-auto">
        <ul class="d-flex align-items-center">
            <li class="nav-item d-block d-lg-none">
                <a class="nav-link nav-icon search-bar-toggle " href="#">
                    <i class="bi bi-search"></i>
                </a>
            </li><!-- End Search Icon-->
            <span> &nbsp; &nbsp;</span>
            
            <li class="nav-item">
                <a class="nav-link" href="/accounts/signup/">
                    <i class="bi bi-card-list ps-3"></i>
                    <span>Signup</span>
                </a>
            </li>
            <li class="nav-item" style="margin-right: 20px;">
                <a class="nav-link" href="/accounts/login/">
                    <i class="bi bi-box-arrow-in-right ps-3"></i>
                    <span>Log In</span>
                </a>
            </li>
            
        </ul>
    </nav><!-- End Icons Navigation -->
</header><!-- End Header -->

    
    
<!-- ======= Sidebar ======= -->
<aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item">
    <a class="nav-link " href="/">
        <i class="bi bi-grid"></i>
        <span>Dashboard</span>
    </a>
</li><!-- End Dashboard Nav -->
        
        <li class="nav-item">
    <a class="nav-link collapsed" data-bs-target="#accounts-nav" data-bs-toggle="collapse" href="/accounts/">
        <i class="bi bi-person-gear"></i><span>Account</span><i class="bi bi-chevron-down ms-auto"></i>
    </a>
    <ul id="accounts-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
        <li>
            <a href="/accounts/">
                <i class="bi bi-circle"></i><span>My Account</span>
            </a>
        </li>
        
        <li>
            <a href="/accounts/login/">
                <i class="bi bi-circle"></i><span>Log In</span>
            </a>
        </li>
        <li>
            <a href="/accounts/signup/">
                <i class="bi bi-circle"></i><span>Register</span>
            </a>
        </li>
        <li>
            <a href="/accounts/password-reset/">
                <i class="bi bi-circle"></i><span>Forgot Password</span>
            </a>
        </li>
        
    </ul>
</li><!-- End Account Nav -->
        
<!-- pages.html -->

<li class="nav-heading">Pages</li>


<li class="nav-item">
    <a class="nav-link collapsed" href="/faq/">
        <i class="bi bi-question-circle"></i>
        <span>F.A.Q</span>
    </a>
</li><!-- End F.A.Q Page Nav -->

<li class="nav-item">
    <a class="nav-link collapsed" href="/contact/">
        <i class="bi bi-envelope"></i>
        <span>Contact</span>
    </a>
</li><!-- End Contact Page Nav -->

<li class="nav-item">
    <a class="nav-link collapsed" href="/about/">
        <i class="bi bi-info-circle"></i>
        <span>About</span>
    </a>    

</li><!-- End About Page Nav -->


    </ul>

    <style>
    /* Estilos para los encabezados de secci칩n en la navegaci칩n */
    .nav-heading {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        padding: 0.75rem 1rem 0.25rem 1rem;
        margin: 0.5rem 0 0.25rem 0;
        border-bottom: 1px solid rgba(108, 117, 125, 0.2);
    }

    .nav-heading:first-child {
        margin-top: 0;
    }

    /* Mejorar el espaciado de los elementos de navegaci칩n */
    .sidebar-nav .nav-item .nav-content li {
        margin-bottom: 0.125rem;
    }

    .sidebar-nav .nav-item .nav-content li a {
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .sidebar-nav .nav-item .nav-content li a:hover {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }

    /* Iconos m치s prominentes */
    .sidebar-nav .nav-item .nav-content li a i {
        font-size: 0.8rem;
        width: 16px;
        text-align: center;
        margin-right: 0.5rem;
        opacity: 0.8;
    }

    .sidebar-nav .nav-item .nav-content li a:hover i {
        opacity: 1;
    }
    </style>
</aside><!-- End Sidebar-->
    
    
    <main id="main" class="main">
        
        

        
        
        <div class="container-fluid">
            
            <form id="csrf-form" style="display: none;">
                <input type="hidden" name="csrfmiddlewaretoken" value="bRIXRoeqdX9fgV5mL2RJH51hrnjmkdPmDRJjBGGoQaA61eLhseSAW5PYZF2LL2C6">
            </form>

            
<div class="pagetitle">
    <h1>Log In</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">Log In</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<!-- Messages -->


<section class="section">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Welcome Back!</h2>
                    
                    
                    
                    <form method="post" class="row g-3">
                        <input type="hidden" name="csrfmiddlewaretoken" value="bRIXRoeqdX9fgV5mL2RJH51hrnjmkdPmDRJjBGGoQaA61eLhseSAW5PYZF2LL2C6">
                        
                        <div class="col-12">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" 
                                   name="username" 
                                   class="form-control" 
                                   required
                                   autofocus>
                        </div>
                        
                        <div class="col-12">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" 
                                       name="password" 
                                       class="form-control" 
                                       required
                                       id="password-field">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Log In
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12 text-center mt-3">
                            <p class="mb-2">
                                Don't have an account? 
                                <a href="/accounts/signup/" class="text-decoration-none">Sign Up</a>
                            </p>
                            <p>
                                <a href="/accounts/password-reset/" class="text-decoration-none">
                                    Forgot Password?
                                </a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(function(button) {
        button.addEventListener('click', function() {
            const input = this.previousElementSibling;
            const icon = this.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });
});
</script>


            
            
                
<!-- Panel flotante de chat para incluir en base.html -->
<!-- Bot칩n flotante para restaurar chat -->
<button id="chat-restore-btn" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="display:none;">
    <i class="bi bi-chat-dots"></i>
</button>

<div id="chat-panel" class="docked card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center chat-header">
        <span>
            <i class="bi bi-chat-dots me-2"></i>Chat
            <select id="chat-room-selector" class="form-select form-select-sm d-inline-block w-auto ms-2">
                <option value="" disabled selected>Selecciona una sala...</option>
            </select>
        </span>
        <div class="d-flex gap-1">
            <button id="go-chat-main-btn" class="btn btn-light btn-sm" title="Ir al chat principal">
                <i class="bi bi-box-arrow-up-right"></i>
            </button>
            <button id="toggle-dock-btn" class="btn btn-light btn-sm" title="Acoplar/desacoplar">
                <i class="bi bi-layout-sidebar-inset"></i>
            </button>
            <button id="toggle-chat-panel" class="btn btn-link text-white p-0" style="font-size:1.5rem; line-height:1;">
                &#8211;
            </button>
        </div>
    </div>

    <div id="chat-panel-body" class="chat-panel-body">
        <div id="chat-log">
            <div class="d-flex mb-2 justify-content-end">
                <div class="message-bubble outgoing">
                    <div class="small fw-bold mb-1">You</div>
                    <div class="message-content">춰Bienvenido al chat!</div>
                    <div class="message-time small mt-1 text-muted">Ahora</div>
                </div>
            </div>
            <div id="typing-indicator" class="typing-indicator">
                <span></span><span></span><span></span> escribiendo...
            </div>
        </div>
    </div>

    <div class="chat-info-containers d-flex flex-column">
        <div class="input-group">
            <input id="chat-message-input" type="text" class="form-control" placeholder="Escribe tu mensaje..." autocomplete="off">
            <button id="chat-message-submit" class="btn btn-primary">
                <i class="bi bi-send"></i>
            </button>
        </div>
    </div>
</div>
<script>
    // Force cache refresh - version 1.1
    function setPanelMode(mode) {
        const panel = document.getElementById('chat-panel');
        panel.classList.remove('fullscreen', 'docked');
        panel.classList.add(mode);
    }
    function isMobile() {
        return window.innerWidth <= 600;
    }
    document.addEventListener('DOMContentLoaded', async function() {
    const currentUserId = "";
        const panel = document.getElementById('chat-panel');
        const toggleDockBtn = document.getElementById('toggle-dock-btn');
        const toggleChatPanelBtn = document.getElementById('toggle-chat-panel');
        const restoreBtn = document.getElementById('chat-restore-btn');
        const goChatMainBtn = document.getElementById('go-chat-main-btn');
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-message-input');
    const chatSubmit = document.getElementById('chat-message-submit');
    const roomSelector = document.getElementById('chat-room-selector');

        // Detecta si est치 en la p치gina principal de chat
        function isChatMainPage() {
            return window.location.pathname.startsWith('/chat/room');
        }

        // Estado inicial del panel flotante
        let chatPanelState = localStorage.getItem('chatPanelState') || 'minimized';
        function applyPanelState(state) {
            if (isChatMainPage()) {
                setPanelMode('fullscreen');
                panel.classList.remove('hidden');
                restoreBtn.style.display = 'none';
            } else {
                setPanelMode('docked');
                if (state === 'minimized') {
                    panel.classList.add('hidden');
                    restoreBtn.style.display = 'flex';
                    restoreBtn.style.opacity = '1';
                } else {
                    panel.classList.remove('hidden');
                    restoreBtn.style.display = 'none';
                    restoreBtn.style.opacity = '0';
                }
            }
        }
        applyPanelState(chatPanelState);
        // Siempre mostrar funcionalidades completas en modo docked
        if (isMobile() && !isChatMainPage()) {
            setPanelMode('docked');
            // En m칩vil, mostrar siempre el contenido completo en docked
            const panelBody = document.querySelector('.chat-panel-body');
            const infoContainers = document.querySelector('.chat-info-containers');
            if (panelBody) panelBody.style.display = 'flex';
            if (infoContainers) infoContainers.style.display = 'flex';
        }
        toggleDockBtn.addEventListener('click', function() {
            if (panel.classList.contains('docked')) {
                setPanelMode('fullscreen');
                localStorage.setItem('chatPanelState', 'maximized');
            } else {
                setPanelMode('docked');
                localStorage.setItem('chatPanelState', 'docked');
            }
        });
        toggleChatPanelBtn.addEventListener('click', function() {
            panel.classList.add('hidden');
            restoreBtn.style.display = 'flex';
            restoreBtn.style.opacity = '1';
            localStorage.setItem('chatPanelState', 'minimized');
        });
        restoreBtn.addEventListener('click', function() {
            panel.classList.remove('hidden');
            restoreBtn.style.display = 'none';
            restoreBtn.style.opacity = '0';
            // Si est치 en la p치gina principal de chat, restaurar pantalla completa
            if (isChatMainPage()) {
                setPanelMode('fullscreen');
                localStorage.setItem('chatPanelState', 'maximized');
            } else {
                setPanelMode('docked');
                localStorage.setItem('chatPanelState', 'docked');
            }

            // Reset unread count when panel is restored
            if (typeof lastRoomId !== 'undefined' && lastRoomId) {
                setTimeout(() => resetUnreadCount(lastRoomId), 500);
            }
        });
        window.addEventListener('resize', function() {
            if (isMobile() && !isChatMainPage()) {
                setPanelMode('docked');
                document.querySelector('.chat-panel-body').style.display = 'flex';
                document.querySelector('.chat-info-containers').style.display = 'flex';
            }
        });
        goChatMainBtn.addEventListener('click', function() {
            const currentRoom = roomSelector.value;
            if (currentRoom) {
                window.location.href = `/chat/room/${currentRoom}/`;
            } else {
                window.location.href = '/chat/room';
            }
        });

        // --- Obtener sala por defecto seg칰n historial de 칰ltimo acceso ---
        async function getLastRoom() {
            try {
                const response = await fetch('/chat/api/chat/last-room/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.room_name || 'global';
                }
            } catch (e) {
                console.error('Error fetching last room:', e);
            }
            return 'global';
        }

        let chatSocket = null;
        let reconnectTimeout = null;
        let intentionalClose = false;
        let typingTimeout = null;
        let isTyping = false;
        let isPageVisible = true;
        let unreadMessageCount = 0;
        let isWidgetActive = false;
        let widgetVisibilityObserver = null;
        let readReceiptTimeout = null;
        let lastRoomId = null; // Declare at the beginning to avoid initialization error

        async function loadRoomsAndSelectLast() {
            let lastRoom = await getLastRoom();
            try {
                const response = await fetch('/chat/api/chat/room-list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const data = await response.json();
                    roomSelector.innerHTML = '<option value="" disabled>Selecciona una sala...</option>';
                    data.rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = room.name;
                        roomSelector.appendChild(option);
                    });
                    // Check localStorage first for panel-specific last room
                    let selectedRoom = localStorage.getItem('chatPanelLastRoom') || lastRoom;

                    // Selecciona la sala por defecto si existe
                    if (selectedRoom && data.rooms.some(room => room.id == selectedRoom)) {
                        roomSelector.value = selectedRoom;
                        lastRoomId = selectedRoom;
                        console.log('Panel: Selected stored/last room:', selectedRoom);
                    } else if (lastRoom && data.rooms.some(room => room.id == lastRoom)) {
                        roomSelector.value = lastRoom;
                        lastRoomId = lastRoom;
                        localStorage.setItem('chatPanelLastRoom', lastRoom);
                        console.log('Panel: Selected API last room:', lastRoom);
                    } else if (data.rooms.length > 0) {
                        // Fallback to first available room
                        const firstRoom = data.rooms[0].id;
                        roomSelector.value = firstRoom;
                        lastRoomId = firstRoom;
                        localStorage.setItem('chatPanelLastRoom', firstRoom);
                        console.log('Panel: Selected first available room:', firstRoom);
                    }
                } else {
                    console.error('Panel: Failed to load rooms:', response.status);
                }
            } catch (e) {
                console.error('Panel: Error loading rooms:', e);
            }
        }

        // Ensure lastRoomId is initialized before calling loadRoomsAndSelectLast
        if (typeof lastRoomId === 'undefined') {
            lastRoomId = null;
        }
        await loadRoomsAndSelectLast();

        async function loadHistory(roomId) {
            chatLog.innerHTML = '';
            try {
                const response = await fetch(`/chat/api/chat/room-history/${roomId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data.history)) {
                        data.history.forEach(msg => {
                            const isCurrentUser = msg.user_id == currentUserId;
                            const msgHtml = `<div class="d-flex mb-2 justify-content-${isCurrentUser ? 'end' : 'start'}">
                                <div class="message-bubble px-3 py-2 ${isCurrentUser ? 'outgoing text-white text-end' : 'incoming text-dark text-start'}" style="max-width: 75%; border-radius: 1.2em; background:${isCurrentUser ? '#007bff' : '#f8f9fa'};">
                                    <div class="small fw-bold mb-1">${msg.display_name || 'Usuario'}</div>
                                    <div class="message-content">${msg.content}</div>
                                    <div class="message-time small mt-1 text-muted">${msg.timestamp ? msg.timestamp.substring(11,19) : ''}</div>
                                </div>
                            </div>`;
                            chatLog.insertAdjacentHTML('beforeend', msgHtml);
                        });
                        chatLog.scrollTop = chatLog.scrollHeight;
                    }
                } else {
                    console.error('Panel: Failed to load history:', response.status);
                }
            } catch (e) {
                console.error('Panel: Error loading history:', e);
            }
        }

        function showTypingIndicator(userId, displayName) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (!typingIndicator) return;
            typingIndicator.innerHTML = `<span></span><span></span><span></span> ${displayName} is typing...`;
            typingIndicator.style.display = 'block';
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        function handleHistoryCleared() {
            // Clear all messages from the chat log but keep the typing indicator
            const chatLog = document.getElementById('chat-log');
            const typingIndicator = document.getElementById('typing-indicator');
            chatLog.innerHTML = '';
            if (typingIndicator) {
                chatLog.appendChild(typingIndicator);
            }
            // Show a system message indicating history was cleared
            const systemMessage = document.createElement('div');
            systemMessage.className = 'text-center p-2';
            systemMessage.innerHTML = '<small class="text-muted">Chat history has been cleared</small>';
            chatLog.appendChild(systemMessage);
        }

        function resetUnreadCount(roomId) {
            if (!roomId || typeof roomId === 'undefined') return;

            fetch('/chat/api/chat/reset-unread/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    'room_id': roomId
                }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Panel: Marked ${data.marked_read} messages as read for room ${roomId}`);
                    // Update the notification count in the header
                    if (window.updateNotificationCount) {
                        window.updateNotificationCount();
                    }
                    // Also trigger notification system refresh
                    if (window.NotificationManager && window.NotificationManager.forceRefresh) {
                        window.NotificationManager.forceRefresh();
                    }
                    // Dispatch custom event for other components
                    document.dispatchEvent(new CustomEvent('messagesMarkedAsRead', {
                        detail: { roomId: roomId, count: data.marked_read }
                    }));
                    // Update notification count immediately
                    if (window.updateNotificationFromWidget) {
                        window.updateNotificationFromWidget();
                    }
                    // Reset local unread counter
                    unreadMessageCount = 0;
                }
            })
            .catch(error => console.error('Panel: Error resetting unread count:', error));
        }

        function setupWidgetVisibilityObserver() {
            const panel = document.getElementById('chat-panel');
            if (!panel) return;

            // Disconnect existing observer
            if (widgetVisibilityObserver) {
                widgetVisibilityObserver.disconnect();
            }

            // Create new observer
            widgetVisibilityObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const wasActive = isWidgetActive;
                    isWidgetActive = entry.isIntersecting && isPageVisible && !panel.classList.contains('hidden');

                    console.log('Panel: Widget visibility changed:', {
                        isIntersecting: entry.isIntersecting,
                        isPageVisible,
                        isHidden: panel.classList.contains('hidden'),
                        isWidgetActive
                    });

                    // If widget became active and there are unread messages, mark them as read
                    if (isWidgetActive && !wasActive && unreadMessageCount > 0 && typeof lastRoomId !== 'undefined' && lastRoomId) {
                        console.log('Panel: Widget became visible, marking messages as read');
                        clearTimeout(readReceiptTimeout);
                        readReceiptTimeout = setTimeout(() => {
                            resetUnreadCount(lastRoomId);
                        }, 1000); // Wait 1 second to ensure user is actually reading
                    }
                });
            }, {
                threshold: 0.1, // Consider visible if at least 10% is visible
                rootMargin: '0px'
            });

            widgetVisibilityObserver.observe(panel);
        }

        function updateWidgetActiveState() {
            setupWidgetVisibilityObserver();
        }

        // Handle page visibility changes for smart read receipts
        document.addEventListener('visibilitychange', function() {
            isPageVisible = !document.hidden;
            console.log('Panel: Page visibility changed:', isPageVisible ? 'visible' : 'hidden');
            updateWidgetActiveState();
        });

        // Handle window focus/blur for better activity detection
        window.addEventListener('focus', function() {
            console.log('Panel: Window focused');
            isPageVisible = true;
            updateWidgetActiveState();

            // Mark messages as read when window gains focus and widget is visible
            if (isWidgetActive && unreadMessageCount > 0 && typeof lastRoomId !== 'undefined' && lastRoomId) {
                clearTimeout(readReceiptTimeout);
                readReceiptTimeout = setTimeout(() => {
                    resetUnreadCount(lastRoomId);
                }, 200); // Reduced to 200ms for faster response
            }
        });

        window.addEventListener('blur', function() {
            console.log('Panel: Window blurred');
            isPageVisible = false;
            updateWidgetActiveState();
        });

        // Handle widget state changes (minimize/maximize)
        toggleChatPanelBtn.addEventListener('click', function() {
            setTimeout(updateWidgetActiveState, 100);
        });

        toggleDockBtn.addEventListener('click', function() {
            setTimeout(updateWidgetActiveState, 100);
        });

        restoreBtn.addEventListener('click', function() {
            setTimeout(updateWidgetActiveState, 100);
        });

        // Enhanced mobile touch interactions
        function initializeMobileInteractions() {
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                // Add swipe gesture for chat panel
                let startY = 0;
                let startX = 0;
                let isSwiping = false;

                const chatPanel = document.getElementById('chat-panel');
                const swipeIndicator = document.createElement('div');
                swipeIndicator.className = 'swipe-indicator';
                swipeIndicator.textContent = 'Swipe to close';
                document.body.appendChild(swipeIndicator);

                // Touch start
                chatPanel.addEventListener('touchstart', function(e) {
                    if (chatPanel.classList.contains('fullscreen')) {
                        startY = e.touches[0].clientY;
                        startX = e.touches[0].clientX;
                        isSwiping = true;
                    }
                }, { passive: true });

                // Touch move
                chatPanel.addEventListener('touchmove', function(e) {
                    if (!isSwiping || !chatPanel.classList.contains('fullscreen')) return;

                    const currentY = e.touches[0].clientY;
                    const currentX = e.touches[0].clientX;
                    const deltaY = currentY - startY;
                    const deltaX = Math.abs(currentX - startX);

                    // Only handle vertical swipes
                    if (deltaX < 50 && deltaY > 50) {
                        swipeIndicator.classList.add('show');
                        e.preventDefault(); // Prevent scrolling
                    } else {
                        swipeIndicator.classList.remove('show');
                    }
                }, { passive: false });

                // Touch end
                chatPanel.addEventListener('touchend', function(e) {
                    if (!isSwiping) return;

                    const endY = e.changedTouches[0].clientY;
                    const deltaY = endY - startY;

                    swipeIndicator.classList.remove('show');

                    // If swiped down more than 100px, close fullscreen
                    if (deltaY > 100 && chatPanel.classList.contains('fullscreen')) {
                        setPanelMode('docked');
                        // Add haptic feedback
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }

                    isSwiping = false;
                });

                // Add haptic feedback to buttons
                const buttons = document.querySelectorAll('button');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', function() {
                        this.classList.add('haptic-feedback');
                        if (navigator.vibrate) {
                            navigator.vibrate(10);
                        }
                    });

                    button.addEventListener('touchend', function() {
                        this.classList.remove('haptic-feedback');
                    });
                });

                // Improve scrolling performance on mobile
                const chatLog = document.getElementById('chat-log');
                let scrollTimeout;

                chatLog.addEventListener('scroll', function() {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(function() {
                        // Hide virtual keyboard when scrolling
                        document.activeElement.blur();
                    }, 150);
                }, { passive: true });

                // Handle orientation changes
                window.addEventListener('orientationchange', function() {
                    setTimeout(function() {
                        chatLog.scrollTop = chatLog.scrollHeight;
                        // Recalculate panel position
                        if (chatPanel.classList.contains('docked')) {
                            chatPanel.style.bottom = '20px';
                        }
                    }, 500);
                });

                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // Add pull-to-refresh for chat messages
                let pullStartY = 0;
                let isPulling = false;

                chatLog.addEventListener('touchstart', function(e) {
                    if (chatLog.scrollTop === 0) {
                        pullStartY = e.touches[0].clientY;
                        isPulling = true;
                    }
                }, { passive: true });

                chatLog.addEventListener('touchmove', function(e) {
                    if (!isPulling) return;

                    const pullDistance = e.touches[0].clientY - pullStartY;
                    if (pullDistance > 50) {
                        // Show refresh indicator
                        chatLog.style.transform = `translateY(${Math.min(pullDistance - 50, 60)}px)`;
                        e.preventDefault();
                    }
                }, { passive: false });

                chatLog.addEventListener('touchend', function(e) {
                    if (!isPulling) return;

                    const pullDistance = e.changedTouches[0].clientY - pullStartY;
                    chatLog.style.transform = '';

                    if (pullDistance > 100) {
                        // Trigger refresh
                        console.log('Pull to refresh triggered');
                        // Could reload messages or show new messages
                    }

                    isPulling = false;
                });
            }
        }

        // Initialize widget active state
        updateWidgetActiveState();
        initializeMobileInteractions();

        // Cleanup function for when widget disconnects
        function cleanupWidgetResources() {
            if (widgetVisibilityObserver) {
                widgetVisibilityObserver.disconnect();
                widgetVisibilityObserver = null;
            }
            if (readReceiptTimeout) {
                clearTimeout(readReceiptTimeout);
                readReceiptTimeout = null;
            }
        }

        // Global function to update notification count from widget
        window.updateNotificationFromWidget = function() {
            console.log('Widget: Updating notification count from widget');
            if (window.NotificationManager && window.NotificationManager.forceRefresh) {
                window.NotificationManager.forceRefresh();
            }
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupWidgetResources);

        async function connectSocketWithHistory(roomId) {
            if (typeof lastRoomId !== 'undefined' && roomId === lastRoomId) return; // No recargar si no cambi칩 la sala

            // Validate room ID
            if (!roomId || roomId.trim() === '') {
                console.error('Cannot connect: Invalid room ID');
                return;
            }

            lastRoomId = roomId;
            await loadHistory(roomId);
            // Reset unread count when loading history
            setTimeout(() => resetUnreadCount(roomId), 500);

            if (chatSocket) {
                intentionalClose = true;
                chatSocket.close();
                intentionalClose = false;
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsPath = `${wsScheme}://${window.location.host}/ws/chat/${roomId}/`;
            console.log('Panel connecting to WebSocket:', wsPath);
            chatSocket = new WebSocket(wsPath);
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if (data.type === 'typing_start') {
                    if (data.user_id != currentUserId) {
                        showTypingIndicator(data.user_id, data.display_name);
                    }
                    return;
                }
                if (data.type === 'typing_stop') {
                    hideTypingIndicator();
                    return;
                }
                if (data.type === 'history_cleared') {
                    // Clear the chat history for all users in the room
                    handleHistoryCleared();
                    return;
                }
                if (data.message) {
                    const isCurrentUser = data.user_id == currentUserId;

                    // Track unread messages only if widget is not active
                    if (!isCurrentUser && !isWidgetActive) {
                        unreadMessageCount++;
                        console.log('Panel: Unread message count:', unreadMessageCount);
                    } else if (!isCurrentUser && isWidgetActive) {
                        // Widget is active, mark this message as read after a short delay
                        console.log('Panel: Widget active, will mark message as read');
                        clearTimeout(readReceiptTimeout);
                        readReceiptTimeout = setTimeout(() => {
                            if (typeof lastRoomId !== 'undefined' && lastRoomId && isWidgetActive) {
                                resetUnreadCount(lastRoomId);
                            }
                        }, 500); // Reduced to 0.5 seconds for faster confirmation
                    }

                    const msgHtml = `<div class="d-flex mb-2 justify-content-${isCurrentUser ? 'end' : 'start'}">
                        <div class="message-bubble px-3 py-2 ${isCurrentUser ? 'outgoing text-white text-end' : 'incoming text-dark text-start'}" style="max-width: 75%; border-radius: 1.2em; background:${isCurrentUser ? '#007bff' : '#f8f9fa'};">
                            <div class="small fw-bold mb-1">${data.display_name || 'Usuario'}</div>
                            <div class="message-content">${data.message}</div>
                            <div class="message-time small mt-1 text-muted">${data.timestamp ? data.timestamp.substring(11,19) : ''}</div>
                        </div>
                    </div>`;
                    chatLog.insertAdjacentHTML('beforeend', msgHtml);
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
            };
            chatSocket.onclose = function(e) {
                // Solo reconectar si la sala sigue siendo la misma
                if (!intentionalClose && typeof lastRoomId !== 'undefined' && roomId === lastRoomId) {
                    reconnectTimeout = setTimeout(() => connectSocketWithHistory(roomId), 2000);
                }
            };

            chatSocket.onopen = function() {
                console.log('Panel: WebSocket connected, setting up visibility observer');
                // Setup visibility observer when WebSocket connects
                setTimeout(updateWidgetActiveState, 100);
            };
        }
        // Conectar al inicio despu칠s de cargar las salas
        setTimeout(() => {
            if (roomSelector.value && roomSelector.value !== '') {
                console.log('Panel: Connecting to initial room:', roomSelector.value);
                connectSocketWithHistory(roomSelector.value);
            } else {
                console.log('Panel: No room selected, waiting for user selection');
            }
        }, 1000); // Give time for room loading to complete

        roomSelector.addEventListener('change', function() {
            const newRoomId = roomSelector.value;
            if (newRoomId) {
                // Save to localStorage for persistence
                localStorage.setItem('chatPanelLastRoom', newRoomId);
                console.log('Panel: Saved room to localStorage:', newRoomId);

                connectSocketWithHistory(newRoomId);
                // Reset unread count when switching rooms
                setTimeout(() => resetUnreadCount(newRoomId), 1000);
            }
        });
        chatSubmit.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({ 'message': message }));
                chatInput.value = '';
            }
        });
        chatInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                chatSubmit.click();
            }
        });

        chatInput.addEventListener('input', function(e) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                if (!isTyping) {
                    isTyping = true;
                    chatSocket.send(JSON.stringify({
                        'type': 'typing_start'
                    }));
                }
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(function() {
                    isTyping = false;
                    chatSocket.send(JSON.stringify({
                        'type': 'typing_stop'
                    }));
                }, 1000);
            }
        });
    });
</script>

            

            
            
        </div>
        
    </main>

    
    <footer id="footer" class="footer">
        <div class="container">
            <div class="row justify-content-center text-center">
                <div class="col-12 col-md-8">
                    <div class="project-credits mb-2">
                        <div class="copyright">
                            &copy; Copyright <strong><span>Management360</span></strong>. Todos los derechos reservados
                        </div>
                    </div>
                    <div class="third-party-credits">
                        <div class="credits">
                            <p>Plantilla base: <strong>NiceAdmin</strong></p>
                            <p>&copy; Copyright <strong>NiceAdmin</strong>. All Rights Reserved</p>
                            <p>Dise침ado por <a href="https://bootstrapmade.com/" rel="noopener noreferrer" target="_blank">BootstrapMade</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center" aria-label="Back to top">
        <i class="bi bi-arrow-up-short"></i>
    </a>

    
    <script src="/static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js" defer></script>
    <script src="/static/assets/vendor/apexcharts/apexcharts.min.js" defer></script>
    <script src="/static/assets/vendor/chart.js/chart.umd.js" defer></script>
    <script src="/static/assets/vendor/echarts/echarts.min.js" defer></script>
    <script src="/static/assets/vendor/quill/quill.js" defer></script>
    <script src="/static/assets/vendor/simple-datatables/simple-datatables.js" defer></script>
    <script src="/static/assets/vendor/tinymce/tinymce.min.js" defer></script>
    <script src="/static/assets/vendor/php-email-form/validate.js" defer></script>

    
    <script src="/static/assets/js/main.js" defer></script>

    
    

    
    

    
    



    
    <script nonce="">
        document.addEventListener('DOMContentLoaded', function() {
            // Configuraci칩n de alertas
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const closeButton = alert.querySelector('.btn-close');
                if (closeButton) {
                    closeButton.addEventListener('click', () => {
                        alert.style.transition = 'opacity 0.5s ease';
                        alert.style.opacity = '0';
                        setTimeout(() => alert.remove(), 500);
                    });
                }
                
                setTimeout(() => {
                    alert.style.transition = 'opacity 0.5s ease';
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 500);
                }, 5000);
            });

            // Configuraci칩n del bot칩n "Volver arriba"
            const backToTopButton = document.querySelector('.back-to-top');
            if (backToTopButton) {
                const toggleVisibility = () => {
                    backToTopButton.style.display = window.pageYOffset > 100 ? 'flex' : 'none';
                };

                window.addEventListener('scroll', toggleVisibility);
                toggleVisibility(); // Estado inicial
                
                backToTopButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
        });
    </script>
</body>
</html>