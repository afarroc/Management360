{% extends 'layouts/base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}{{ title }} - Panel Kanban Organizado{% endblock %}

{% block extra_css %}
<style>
/* ===============================================
   PANEL KANBAN ORGANIZADO - ESTILOS LIMPIOS
   =============================================== */

:root {
    --kanban-primary: #4f46e5;
    --kanban-secondary: #7c3aed;
    --kanban-success: #10b981;
    --kanban-warning: #f59e0b;
    --kanban-danger: #ef4444;
    --kanban-info: #06b6d4;
    --kanban-light: #f8fafc;
    --kanban-dark: #1e293b;
    --kanban-border: #e2e8f0;
    --kanban-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --kanban-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --kanban-radius: 12px;
    --kanban-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Modo oscuro */
[data-theme="dark"] {
    --kanban-primary: #8b7bd8;
    --kanban-secondary: #9d7bb0;
    --kanban-light: #2d3748;
    --kanban-dark: #e2e8f0;
    --kanban-border: rgba(255,255,255,0.1);
    --kanban-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

/* Layout principal */
.kanban-organized {
    min-height: 100vh;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 2rem 0;
}

/* Header organizado */
.kanban-header-organized {
    background: white;
    border-radius: var(--kanban-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--kanban-shadow);
    border: 1px solid var(--kanban-border);
}

.kanban-title-organized {
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--kanban-dark);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.kanban-subtitle-organized {
    color: #64748b;
    font-size: 1rem;
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Barra de herramientas organizada */
.kanban-toolbar-organized {
    background: white;
    border-radius: var(--kanban-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--kanban-shadow);
    border: 1px solid var(--kanban-border);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.toolbar-section-organized {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.toolbar-label-organized {
    font-weight: 600;
    color: var(--kanban-dark);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.toolbar-actions-organized {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* Estadísticas organizadas */
.kanban-stats-organized {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card-organized {
    background: white;
    border-radius: var(--kanban-radius);
    padding: 1.5rem;
    box-shadow: var(--kanban-shadow);
    border: 1px solid var(--kanban-border);
    transition: var(--kanban-transition);
    text-align: center;
}

.stat-card-organized:hover {
    transform: translateY(-2px);
    box-shadow: var(--kanban-shadow-lg);
}

.stat-number-organized {
    font-size: 2rem;
    font-weight: 700;
    color: var(--kanban-primary);
    display: block;
    margin-bottom: 0.25rem;
}

.stat-label-organized {
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Board principal organizado */
.kanban-board-organized {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Columnas organizadas */
.kanban-column-organized {
    background: white;
    border-radius: var(--kanban-radius);
    padding: 1.5rem;
    box-shadow: var(--kanban-shadow);
    border: 1px solid var(--kanban-border);
    min-height: 500px;
    display: flex;
    flex-direction: column;
}

.column-header-organized {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid;
    position: sticky;
    top: 0;
    background: inherit;
    border-radius: var(--kanban-radius) var(--kanban-radius) 0 0;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    padding: 1.5rem;
}

.column-title-organized {
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.column-icon-organized {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.column-count-organized {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    min-width: 24px;
    text-align: center;
}

/* Estados de columna */
.column-todo-organized { border-color: #6b7280; }
.column-todo-organized .column-icon-organized { background: #6b7280; }

.column-in-progress-organized { border-color: var(--kanban-primary); }
.column-in-progress-organized .column-icon-organized { background: var(--kanban-primary); }

.column-in-review-organized { border-color: var(--kanban-warning); }
.column-in-review-organized .column-icon-organized { background: var(--kanban-warning); }

.column-completed-organized { border-color: var(--kanban-success); }
.column-completed-organized .column-icon-organized { background: var(--kanban-success); }

.column-blocked-organized { border-color: var(--kanban-danger); }
.column-blocked-organized .column-icon-organized { background: var(--kanban-danger); }

/* Tarjetas de tarea organizadas */
.task-card-organized {
    background: white;
    border-radius: var(--kanban-radius);
    padding: 1.25rem;
    margin-bottom: 1rem;
    box-shadow: var(--kanban-shadow);
    border: 1px solid var(--kanban-border);
    cursor: pointer;
    transition: var(--kanban-transition);
    position: relative;
    overflow: hidden;
}

.task-card-organized:hover {
    transform: translateY(-2px);
    box-shadow: var(--kanban-shadow-lg);
}

.task-card-organized.important-organized {
    border-left: 4px solid var(--kanban-danger);
}

.task-title-organized {
    font-weight: 600;
    font-size: 1rem;
    color: #1e293b;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    line-height: 1.4;
}

.task-title-organized.important-organized {
    color: var(--kanban-danger);
}

.task-description-organized {
    color: #64748b;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.task-meta-organized {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.task-tag-organized {
    background: #f1f5f9;
    color: #475569;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid var(--kanban-border);
}

.task-project-organized {
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.task-assignee-organized {
    background: #f3e8ff;
    color: #7c3aed;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.task-actions-organized {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    padding-top: 0.75rem;
    border-top: 1px solid #e2e8f0;
}

.task-date-organized {
    color: #64748b;
    font-size: 0.8rem;
}

.task-buttons-organized {
    display: flex;
    gap: 0.25rem;
}

.btn-task-action-organized {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: var(--kanban-transition);
}

.btn-task-action-organized:hover {
    transform: scale(1.05);
}

/* Estados vacíos organizados */
.empty-column-organized {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    color: #64748b;
    text-align: center;
    flex: 1;
}

.empty-icon-organized {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-text-organized {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.empty-subtext-organized {
    font-size: 0.9rem;
    opacity: 0.7;
}

/* Secciones adicionales organizadas */
.kanban-sections-organized {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.section-card-organized {
    background: white;
    border-radius: var(--kanban-radius);
    padding: 1.5rem;
    box-shadow: var(--kanban-shadow);
    border: 1px solid var(--kanban-border);
}

.section-header-organized {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--kanban-border);
}

.section-icon-organized {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--kanban-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.section-title-organized {
    font-weight: 600;
    color: var(--kanban-dark);
    margin: 0;
}

.section-content-organized {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.section-item-organized {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 6px;
    transition: var(--kanban-transition);
}

.section-item-organized:hover {
    background: #f8fafc;
}

.section-item-icon-organized {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--kanban-info);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
}

.section-item-text-organized {
    flex: 1;
    font-size: 0.9rem;
    color: #475569;
}

.section-item-action-organized {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 4px;
    border: none;
    background: var(--kanban-primary);
    color: white;
    cursor: pointer;
    transition: var(--kanban-transition);
}

.section-item-action-organized:hover {
    background: var(--kanban-secondary);
}

/* Responsive */
@media (max-width: 768px) {
    .kanban-board-organized {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .kanban-toolbar-organized {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .toolbar-actions-organized {
        flex-direction: column;
    }

    .kanban-sections-organized {
        grid-template-columns: 1fr;
    }

    .kanban-title-organized {
        font-size: 1.75rem;
    }
}

/* Animaciones */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.task-card-organized {
    animation: slideInUp 0.3s ease-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

.task-card-organized.important-organized {
    animation: pulse 2s infinite;
}

/* Loading states */
.kanban-loading-organized {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    color: #64748b;
}

.loading-spinner-organized {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f4f6;
    border-top: 4px solid var(--kanban-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Estados de drag and drop */
.kanban-column-organized.drag-over-organized {
    border: 2px dashed var(--kanban-primary);
    background: rgba(79, 70, 229, 0.1);
    transform: scale(1.01);
}

/* Accesibilidad */
.task-card-organized:focus,
.btn-task-action-organized:focus {
    outline: 2px solid var(--kanban-primary);
    outline-offset: 2px;
}

/* Botón flotante */
.fab-kanban {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--kanban-primary), var(--kanban-secondary));
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: var(--kanban-shadow-lg);
    transition: var(--kanban-transition);
    display: flex;
    align-items: center;
    justify-content: center;
}

.fab-kanban:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

/* Theme toggle */
.theme-toggle {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 1010;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid var(--kanban-border);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--kanban-transition);
    box-shadow: var(--kanban-shadow);
}

.theme-toggle:hover {
    transform: scale(1.1);
    box-shadow: var(--kanban-shadow-lg);
}

/* Estados de drag and drop mejorados */
.kanban-column-organized.drag-over-organized {
    border: 2px dashed var(--kanban-primary);
    background: rgba(79, 70, 229, 0.1);
    transform: scale(1.02);
}

/* Scrollbar personalizada */
.kanban-board-organized::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.kanban-board-organized::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.kanban-board-organized::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
}

.kanban-board-organized::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Responsive para botones flotantes */
@media (max-width: 768px) {
    .fab-kanban {
        bottom: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        font-size: 1.25rem;
    }

    .theme-toggle {
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
    }
}

@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="kanban-organized">
    <div class="container-fluid">
        <!-- Header Organizado -->
        <div class="kanban-header-organized">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1 class="kanban-title-organized">
                        <i class="bi bi-kanban-fill"></i>
                        {{ title }}
                    </h1>
                    {% if project %}
                        <p class="kanban-subtitle-organized">
                            <i class="bi bi-folder me-2"></i>
                            Proyecto: <strong>{{ project.title }}</strong>
                        </p>
                    {% else %}
                        <p class="kanban-subtitle-organized">
                            <i class="bi bi-grid me-2"></i>
                            Panel kanban organizado para gestión de tareas
                        </p>
                    {% endif %}
                </div>

                <div class="d-flex gap-2 mt-3 mt-md-0">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                        <i class="bi bi-plus-circle me-1"></i>
                        Nueva Tarea
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="bi bi-funnel me-1"></i>
                        Filtros
                    </button>
                    <a href="{% url 'unified_dashboard' %}" class="btn btn-outline-info">
                        <i class="bi bi-speedometer2 me-1"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Barra de herramientas organizada -->
        <div class="kanban-toolbar-organized">
            <div class="toolbar-section-organized">
                <div class="toolbar-label-organized">Vista:</div>
                <div class="toolbar-actions-organized">
                    <select class="form-select form-select-sm" id="viewMode" style="max-width: 150px;">
                        <option value="normal">Normal</option>
                        <option value="compact">Compacta</option>
                        <option value="detailed">Detallada</option>
                    </select>
                </div>
            </div>

            <div class="toolbar-section-organized">
                <div class="toolbar-label-organized">Ordenar por:</div>
                <div class="toolbar-actions-organized">
                    <select class="form-select form-select-sm" id="sortBy" style="max-width: 150px;">
                        <option value="updated_at">Fecha actualización</option>
                        <option value="created_at">Fecha creación</option>
                        <option value="title">Título</option>
                        <option value="priority">Prioridad</option>
                    </select>
                </div>
            </div>

            <div class="toolbar-section-organized">
                <div class="toolbar-label-organized">Acciones rápidas:</div>
                <div class="toolbar-actions-organized">
                    <button class="btn btn-success btn-sm" onclick="refreshKanban()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Actualizar
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportKanban()">
                        <i class="bi bi-download me-1"></i>
                        Exportar
                    </button>
                </div>
            </div>
        
            <!-- Botón flotante -->
            <button class="fab-kanban" data-bs-toggle="modal" data-bs-target="#createTaskModal" title="Crear nueva tarea">
                <i class="bi bi-plus"></i>
            </button>
        
            <!-- Theme Toggle -->
            <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
                <i class="bi bi-moon-fill" id="themeIcon"></i>
            </button>
        </div>

        <!-- Estadísticas organizadas -->
        <div class="kanban-stats-organized">
            <div class="stat-card-organized">
                <span class="stat-number-organized">{{ total_tasks|default:0 }}</span>
                <div class="stat-label-organized">Total Tareas</div>
            </div>
            <div class="stat-card-organized">
                <span class="stat-number-organized text-primary">{{ in_progress_count|default:0 }}</span>
                <div class="stat-label-organized">En Progreso</div>
            </div>
            <div class="stat-card-organized">
                <span class="stat-number-organized text-success">{{ completed_count|default:0 }}</span>
                <div class="stat-label-organized">Completadas</div>
            </div>
            <div class="stat-card-organized">
                <span class="stat-number-organized text-warning">{{ pending_count|default:0 }}</span>
                <div class="stat-label-organized">Pendientes</div>
            </div>
        </div>

        <!-- Board Principal Organizado -->
        <div class="kanban-board-organized" id="kanbanBoard">
            {% for status_name, column in kanban_columns.items %}
            <div class="kanban-column-organized column-{{ status_name|slugify }}" data-status="{{ status_name }}">
                <div class="column-header-organized">
                    <div class="column-title-organized">
                        <div class="column-icon-organized">{{ forloop.counter }}</div>
                        {{ column.title }}
                    </div>
                    <span class="column-count-organized">{{ column.tasks|length }}</span>
                </div>

                <div class="column-tasks-organized" data-status="{{ status_name }}">
                    {% for task_data in column.tasks %}
                    <div class="task-card-organized {% if task_data.task.important %}important-organized{% endif %}"
                         data-task-id="{{ task_data.task.id }}"
                         draggable="true">

                        <div class="task-title-organized {% if task_data.task.important %}important-organized{% endif %}">
                            {% if task_data.task.important %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% endif %}
                            <span>{{ task_data.task.title|truncatechars:60 }}</span>
                        </div>

                        {% if task_data.task.description %}
                        <div class="task-description-organized">
                            {{ task_data.task.description|truncatechars:120 }}
                        </div>
                        {% endif %}

                        <div class="task-meta-organized">
                            {% if task_data.task.tags.all %}
                                {% for tag in task_data.task.tags.all|slice:":2" %}
                                <span class="task-tag-organized" data-tag-color="{{ tag.color }}">
                                    {{ tag.name }}
                                </span>
                                {% endfor %}
                                {% if task_data.task.tags.all|length > 2 %}
                                <span class="task-tag-organized">+{{ task_data.task.tags.all|length|add:"-2" }}</span>
                                {% endif %}
                            {% endif %}
                        </div>

                        {% if task_data.task.project %}
                        <div class="task-project-organized">
                            <i class="bi bi-folder me-1"></i>
                            {{ task_data.task.project.title|truncatechars:25 }}
                        </div>
                        {% endif %}

                        {% if task_data.task.assigned_to %}
                        <div class="task-assignee-organized">
                            <i class="bi bi-person me-1"></i>
                            {{ task_data.task.assigned_to.username|truncatechars:20 }}
                        </div>
                        {% endif %}

                        <div class="task-actions-organized">
                            <small class="task-date-organized">
                                {{ task_data.task.updated_at|date:"d/m/Y H:i" }}
                            </small>
                            <div class="task-buttons-organized">
                                <a href="{% url 'tasks_with_id' task_data.task.id %}"
                                   class="btn-task-action-organized btn btn-sm btn-outline-primary"
                                   title="Ver">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'task_edit' task_data.task.id %}"
                                   class="btn-task-action-organized btn btn-sm btn-outline-secondary"
                                   title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-column-organized">
                        <div class="empty-icon-organized">
                            <i class="bi bi-clipboard-x"></i>
                        </div>
                        <div class="empty-text-organized">Sin tareas</div>
                        <div class="empty-subtext-organized">Las tareas aparecerán aquí cuando cambien a este estado</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Secciones adicionales organizadas -->
        <div class="kanban-sections-organized">
            <!-- Sección de proyectos recientes -->
            <div class="section-card-organized">
                <div class="section-header-organized">
                    <div class="section-icon-organized">
                        <i class="bi bi-folder"></i>
                    </div>
                    <h3 class="section-title-organized">Proyectos Recientes</h3>
                </div>
                <div class="section-content-organized">
                    {% for project in recent_projects|slice:":5" %}
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-circle-fill"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>{{ project.title }}</strong>
                            <br>
                            <small class="text-muted">{{ project.updated_at|date:"d/m/Y" }}</small>
                        </div>
                        <a href="{% url 'projects_with_id' project.id %}" class="section-item-action-organized">
                            Ver
                        </a>
                    </div>
                    {% empty %}
                    <div class="section-item-organized">
                        <div class="section-item-text-organized text-muted">
                            No hay proyectos recientes
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sección de eventos activos -->
            <div class="section-card-organized">
                <div class="section-header-organized">
                    <div class="section-icon-organized">
                        <i class="bi bi-calendar-event"></i>
                    </div>
                    <h3 class="section-title-organized">Eventos Activos</h3>
                </div>
                <div class="section-content-organized">
                    {% for event in active_events|slice:":5" %}
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-circle-fill"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>{{ event.title }}</strong>
                            <br>
                            <small class="text-muted">{{ event.updated_at|date:"d/m/Y" }}</small>
                        </div>
                        <a href="{% url 'event_detail' event.id %}" class="section-item-action-organized">
                            Ver
                        </a>
                    </div>
                    {% empty %}
                    <div class="section-item-organized">
                        <div class="section-item-text-organized text-muted">
                            No hay eventos activos
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sección de herramientas GTD -->
            <div class="section-card-organized">
                <div class="section-header-organized">
                    <div class="section-icon-organized">
                        <i class="bi bi-lightbulb"></i>
                    </div>
                    <h3 class="section-title-organized">Herramientas GTD</h3>
                </div>
                <div class="section-content-organized">
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>Inbox GTD</strong>
                            <br>
                            <small class="text-muted">Captura tareas rápidamente</small>
                        </div>
                        <a href="{% url 'inbox' %}" class="section-item-action-organized">
                            Ir
                        </a>
                    </div>
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-grid-3x3"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>Matriz Eisenhower</strong>
                            <br>
                            <small class="text-muted">Prioriza tus tareas</small>
                        </div>
                        <a href="{% url 'eisenhower_matrix' %}" class="section-item-action-organized">
                            Ir
                        </a>
                    </div>
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-link"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>Dependencias</strong>
                            <br>
                            <small class="text-muted">Gestiona relaciones entre tareas</small>
                        </div>
                        <a href="{% url 'task_dependencies_list' %}" class="section-item-action-organized">
                            Ir
                        </a>
                    </div>
                </div>
            </div>

            <!-- Sección de configuración rápida -->
            <div class="section-card-organized">
                <div class="section-header-organized">
                    <div class="section-icon-organized">
                        <i class="bi bi-gear"></i>
                    </div>
                    <h3 class="section-title-organized">Configuración Rápida</h3>
                </div>
                <div class="section-content-organized">
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-file-plus"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>Plantillas</strong>
                            <br>
                            <small class="text-muted">Crear proyectos desde plantillas</small>
                        </div>
                        <a href="{% url 'project_templates' %}" class="section-item-action-organized">
                            Ver
                        </a>
                    </div>
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-bell"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>Recordatorios</strong>
                            <br>
                            <small class="text-muted">Gestionar notificaciones</small>
                        </div>
                        <a href="{% url 'reminders_dashboard' %}" class="section-item-action-organized">
                            Ver
                        </a>
                    </div>
                    <div class="section-item-organized">
                        <div class="section-item-icon-organized">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                        <div class="section-item-text-organized">
                            <strong>Reportes</strong>
                            <br>
                            <small class="text-muted">Ver estadísticas y métricas</small>
                        </div>
                        <a href="{% url 'unified_dashboard' %}" class="section-item-action-organized">
                            Ver
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de crear tarea -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Nueva Tarea
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickCreateTaskForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Título *</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Proyecto</label>
                                <select class="form-select" name="project">
                                    <option value="">Sin proyecto</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Estado inicial</label>
                                <select class="form-select" name="task_status">
                                    {% for status_name, column in kanban_columns.items %}
                                    <option value="{{ status_name }}">{{ column.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="important" id="importantCheck">
                            <label class="form-check-label" for="importantCheck">
                                Marcar como importante
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createQuickTask()">Crear Tarea</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de filtros -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-funnel me-2"></i>
                    Filtros
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for category in tag_categories %}
                <div class="mb-3">
                    <label class="form-label fw-bold">{{ category.name }}</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in category.tag_set.all %}
                        <button class="btn btn-sm btn-outline-secondary filter-tag" data-tag-id="{{ tag.id }}">
                            {{ tag.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                    <i class="bi bi-x-circle me-1"></i>
                    Limpiar Todo
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-check me-1"></i>
                    Aplicar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar funcionalidades avanzadas
    initializeAdvancedKanban();
    initializeDragAndDrop();
    initializeFilters();
    initializeTaskInteractions();
    initializeKeyboardShortcuts();
});

function initializeKanbanOrganizado() {
    console.log('🚀 Inicializando Panel Kanban Organizado...');

    // Configurar modo de vista
    setupViewMode();

    // Configurar ordenamiento
    setupSorting();

    console.log('✅ Panel Kanban Organizado inicializado');
}

function setupViewMode() {
    const viewMode = document.getElementById('viewMode');

    viewMode.addEventListener('change', function() {
        const board = document.getElementById('kanbanBoard');
        board.className = `kanban-board-organized ${this.value}-view`;

        showToast(`Vista cambiada a ${this.value}`, 'info');
    });
}

function setupSorting() {
    const sortBy = document.getElementById('sortBy');

    sortBy.addEventListener('change', function() {
        applySorting();
    });
}

function applySorting() {
    const columns = document.querySelectorAll('.kanban-column-organized');

    columns.forEach(column => {
        const tasks = Array.from(column.querySelectorAll('.task-card-organized'));
        tasks.sort((a, b) => {
            const taskA = kanbanData.tasks.find(t => t.task.id == a.dataset.taskId);
            const taskB = kanbanData.tasks.find(t => t.task.id == b.dataset.taskId);

            if (!taskA || !taskB) return 0;

            let valueA, valueB;

            switch(kanbanData.sortBy) {
                case 'title':
                    valueA = taskA.task.title.toLowerCase();
                    valueB = taskB.task.title.toLowerCase();
                    break;
                case 'created_at':
                    valueA = new Date(taskA.task.created_at);
                    valueB = new Date(taskB.task.created_at);
                    break;
                case 'priority':
                    valueA = taskA.task.important ? 0 : 1;
                    valueB = taskB.task.important ? 0 : 1;
                    break;
                default:
                    valueA = new Date(taskA.task.updated_at);
                    valueB = new Date(taskB.task.updated_at);
            }

            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        });

        const tasksContainer = column.querySelector('.column-tasks-organized');
        tasks.forEach(task => tasksContainer.appendChild(task));
    });

    showToast(`Ordenado por ${getSortLabel(kanbanData.sortBy)}`, 'info');
}

function getSortLabel(sortBy) {
    const labels = {
        'updated_at': 'fecha de actualización',
        'created_at': 'fecha de creación',
        'title': 'título',
        'priority': 'prioridad'
    };
    return labels[sortBy] || sortBy;
}

function initializeDragAndDrop() {
    const taskCards = document.querySelectorAll('.task-card-organized[draggable="true"]');
    const columns = document.querySelectorAll('.kanban-column-organized');

    taskCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });

    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
    e.target.classList.add('dragging');
    document.body.classList.add('dragging-active');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.kanban-column-organized').forEach(col => {
        col.classList.remove('drag-over-organized');
    });
    document.body.classList.remove('dragging-active');
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over-organized');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over-organized');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over-organized');

    const taskId = e.dataTransfer.getData('text/plain');
    const newStatus = e.currentTarget.dataset.status;

    if (taskId && newStatus) {
        moveTaskToColumn(taskId, newStatus);
    }
}

function moveTaskToColumn(taskId, newStatus) {
    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!card) return;

    const originalContent = card.innerHTML;
    card.innerHTML = `
        <div class="d-flex align-items-center justify-content-center p-3">
            <div class="loading-spinner-organized me-2"></div>
            <span>Moviendo tarea...</span>
        </div>
    `;

    fetch(`/events/tasks/change-status-ajax/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}&new_status_name=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newColumn = document.querySelector(`[data-status="${newStatus}"] .column-tasks-organized`);
            if (newColumn) {
                const emptyState = newColumn.querySelector('.empty-column-organized');
                if (emptyState) {
                    emptyState.remove();
                }

                newColumn.appendChild(card);
                updateColumnCounts();
                showToast('Tarea movida exitosamente', 'success');
            }
        } else {
            card.innerHTML = originalContent;
            showToast(data.error || 'Error al mover la tarea', 'error');
        }
    })
    .catch(error => {
        card.innerHTML = originalContent;
        showToast('Error de conexión', 'error');
        console.error('Error:', error);
    });
}

function updateColumnCounts() {
    document.querySelectorAll('.kanban-column-organized').forEach(column => {
        const count = column.querySelectorAll('.task-card-organized').length;
        const countElement = column.querySelector('.column-count-organized');
        if (countElement) {
            countElement.textContent = count;
        }
    });
}

function initializeFilters() {
    const filterTags = document.querySelectorAll('.filter-tag');

    filterTags.forEach(tag => {
        tag.addEventListener('click', function() {
            this.classList.toggle('active');
            applyFilters();
        });
    });
}

function applyFilters() {
    const activeFilters = Array.from(document.querySelectorAll('.filter-tag.active')).map(tag => tag.dataset.tagId);
    const taskCards = document.querySelectorAll('.task-card-organized');

    taskCards.forEach(card => {
        const taskTags = Array.from(card.querySelectorAll('.task-tag-organized')).map(tag => tag.textContent.trim());
        const shouldShow = activeFilters.length === 0 ||
            activeFilters.some(filterId => taskTags.includes(filterId));

        card.style.display = shouldShow ? 'block' : 'none';
    });

    updateColumnCounts();
    showToast(`Mostrando ${document.querySelectorAll('.task-card-organized[style*="block"]').length} tareas`, 'info');
}

function clearAllFilters() {
    document.querySelectorAll('.filter-tag.active').forEach(tag => {
        tag.classList.remove('active');
    });
    applyFilters();
}

function initializeTaskInteractions() {
    const taskCards = document.querySelectorAll('.task-card-organized');

    taskCards.forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.closest('.task-buttons-organized') || e.target.closest('.task-actions-organized')) {
                return;
            }

            const taskId = this.dataset.taskId;
            if (taskId) {
                window.location.href = `/events/tasks/${taskId}/`;
            }
        });
    });
}

function createQuickTask() {
    const form = document.getElementById('quickCreateTaskForm');
    const formData = new FormData(form);

    if (!formData.get('title')) {
        showToast('El título es obligatorio', 'error');
        return;
    }

    showToast('Funcionalidad de creación rápida próximamente', 'info');
}

function refreshKanban() {
    showToast('Actualizando...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function exportKanban() {
    showToast('Exportación próximamente', 'info');
}

function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        switch(e.key) {
            case '+':
                e.preventDefault();
                document.querySelector('[data-bs-target="#createTaskModal"]')?.click();
                break;
            case 'f':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    document.querySelector('[data-bs-target="#filterModal"]')?.click();
                }
                break;
            case 't':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    toggleTheme();
                }
                break;
            case 'Escape':
                clearAllFilters();
                break;
            case 'r':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    refreshKanban();
                }
                break;
        }
    });
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}

// Variables globales para el kanban
let kanbanData = {
    tasks: [],
    filters: {
        tags: [],
        status: [],
        projects: [],
        users: []
    },
    viewMode: 'normal',
    sortBy: 'updated_at',
    theme: localStorage.getItem('kanbanTheme') || 'light'
};

// ===============================================
// GESTIÓN DE TEMAS
// ===============================================

function setupTheme() {
    const themeIcon = document.getElementById('themeIcon');
    if (kanbanData.theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.className = 'bi bi-sun-fill';
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        themeIcon.className = 'bi bi-moon-fill';
    }
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    document.documentElement.setAttribute('data-theme', newTheme);
    kanbanData.theme = newTheme;
    localStorage.setItem('kanbanTheme', newTheme);

    const themeIcon = document.getElementById('themeIcon');
    themeIcon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';

    showToast('Tema cambiado a ' + (newTheme === 'dark' ? 'oscuro' : 'claro'), 'info');
}

// ===============================================
// FUNCIONES MEJORADAS
// ===============================================

function applyDynamicStyles() {
    // Aplicar colores de etiquetas dinámicamente
    document.querySelectorAll('.task-tag-organized[data-tag-color]').forEach(tag => {
        const color = tag.dataset.tagColor;
        if (color) {
            tag.style.backgroundColor = color + '20';
            tag.style.color = color;
            tag.style.border = `1px solid ${color}40`;
        }
    });
}

// ===============================================
// INICIALIZACIÓN MEJORADA
// ===============================================

function initializeAdvancedKanban() {
    console.log('🚀 Inicializando Kanban Avanzado...');

    // Configurar tema
    setupTheme();

    // Configurar modo de vista
    setupViewMode();

    // Configurar ordenamiento
    setupSorting();

    // Aplicar estilos dinámicos
    applyDynamicStyles();

    console.log('✅ Kanban Avanzado inicializado');
}

console.log('🎯 Panel Kanban Organizado completamente cargado');
</script>
{% endblock %}