
{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="pagetitle">
    <h1>{{title}}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'panel' %}">Panel</a></li>
            <li class="breadcrumb-item active">{{title}}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<!-- Mensajes de confirmación y éxito -->
{% if messages %}
<div id="message-container" class="alert alert-info" role="alert">
    {% for message in messages %}
    <p{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</p>
        {% endfor %}
</div>
{% endif %}

<section class="section">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-inbox me-2"></i>
                        Items de Inbox Filtrados
                    </h5>
                    <p class="card-text">
                        Esta tabla muestra los items del inbox asignados a tu usuario o creados por ti.
                        Total: <strong>{{ total_items }}</strong> items
                        (Procesados: <span class="text-success">{{ processed_items }}</span>,
                        Sin procesar: <span class="text-warning">{{ unprocessed_items }}</span>)
                    </p>

                    <!-- Tabla de Items del Inbox -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Título</th>
                                    <th scope="col">Descripción</th>
                                    <th scope="col">Creado por</th>
                                    <th scope="col">Asignado a</th>
                                    <th scope="col">Fecha de Creación</th>
                                    <th scope="col">Estado</th>
                                    <th scope="col">Categoría GTD</th>
                                    <th scope="col">Prioridad</th>
                                    <th scope="col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in table_data %}
                                <tr>
                                    <th scope="row">{{ item.id }}</th>
                                    <td>
                                        <strong>{{ item.title }}</strong>
                                        {% if item.important %}
                                        <i class="bi bi-star-fill text-warning ms-1" title="Importante"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.description %}
                                        <span title="{{ item.description }}">{{ item.description }}</span>
                                        {% else %}
                                        <span class="text-muted">Sin descripción</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ item.created_by }}</span>
                                    </td>
                                    <td>
                                        {% if item.assigned_to != "Sin asignar" %}
                                        <span class="badge bg-primary">{{ item.assigned_to }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ item.assigned_to }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ item.created_at }}</small>
                                    </td>
                                    <td>
                                        {% if item.is_processed %}
                                        <span class="badge bg-success">Procesado</span>
                                        {% else %}
                                        <span class="badge bg-warning">Pendiente</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.gtd_category == 'accionable' %}
                                        <span class="badge bg-success">{{ item.gtd_category|title }}</span>
                                        {% elif item.gtd_category == 'no_accionable' %}
                                        <span class="badge bg-info">{{ item.gtd_category|title }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ item.gtd_category|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.priority == 'alta' %}
                                        <span class="badge bg-danger">{{ item.priority|title }}</span>
                                        {% elif item.priority == 'media' %}
                                        <span class="badge bg-warning">{{ item.priority|title }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ item.priority|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'process_inbox_item' item.id %}"
                                               class="btn btn-outline-primary btn-sm"
                                               title="Procesar item">
                                                <i class="bi bi-gear"></i>
                                            </a>
                                            {% if item.is_processed %}
                                            <button class="btn btn-outline-success btn-sm"
                                                    title="Ya procesado">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                            {% else %}
                                            <button class="btn btn-outline-warning btn-sm"
                                                    title="Marcar como procesado"
                                                    onclick="markAsProcessed({{ item.id }})">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-4">
                                        <i class="bi bi-inbox display-4 text-muted"></i>
                                        <p class="mt-2 text-muted">No hay items del inbox para mostrar</p>
                                        <a href="{% url 'inbox' %}" class="btn btn-primary">
                                            <i class="bi bi-plus-circle me-2"></i>
                                            Ir al Inbox Principal
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación (si es necesario) -->
                    {% if table_data|length >= 50 %}
                    <div class="mt-3">
                        <small class="text-muted">
                            Mostrando primeros 50 items.
                            <a href="{% url 'inbox' %}">Ver todos los items</a>
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para acciones rápidas -->
<div class="modal fade" id="quickActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lightning me-2"></i>
                    Acción Rápida
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modal-item-title" class="fw-bold"></p>
                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn btn-success w-100" onclick="quickProcess('accionable')">
                            <i class="bi bi-check-circle me-1"></i>
                            Marcar Accionable
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-info w-100" onclick="quickProcess('no_accionable')">
                            <i class="bi bi-x-circle me-1"></i>
                            Marcar No Accionable
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-warning w-100" onclick="quickProcess('pendiente')">
                            <i class="bi bi-question-circle me-1"></i>
                            Dejar Pendiente
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-danger w-100" onclick="deleteItem()">
                            <i class="bi bi-trash me-1"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos específicos para el panel de inbox */
.table th {
    background-color: #343a40;
    color: white;
    border: none;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

.card-title {
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Animaciones */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.table-responsive {
    animation: fadeIn 0.5s ease-out;
}

/* Responsive */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }

    .btn-group-sm {
        flex-direction: column;
        gap: 0.25rem;
    }

    .btn-group-sm .btn {
        border-radius: 0.375rem !important;
    }
}
</style>

<script>
// Funciones JavaScript para el panel de inbox
function markAsProcessed(itemId) {
    if (confirm('¿Marcar este item como procesado?')) {
        // Crear formulario para enviar POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
            <input type="hidden" name="action" value="reference">
        `;

        document.body.appendChild(form);
        form.action = `/events/inbox/process/${itemId}/`;
        form.submit();
    }
}

function quickProcess(category) {
    const itemId = document.getElementById('modal-item-title').dataset.itemId;
    if (itemId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
            <input type="hidden" name="action" value="categorize">
            <input type="hidden" name="gtd_category" value="${category}">
        `;

        document.body.appendChild(form);
        form.action = `/events/inbox/process/${itemId}/`;
        form.submit();
    }
}

function deleteItem() {
    const itemId = document.getElementById('modal-item-title').dataset.itemId;
    if (itemId && confirm('¿Estás seguro de eliminar este item? Esta acción no se puede deshacer.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
            <input type="hidden" name="action" value="delete">
        `;

        document.body.appendChild(form);
        form.action = `/events/inbox/process/${itemId}/`;
        form.submit();
    }
}

// Inicializar tooltips y funcionalidades
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Agregar animaciones de entrada a las filas de la tabla
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';

        setTimeout(() => {
            row.style.transition = 'all 0.4s ease-out';
            row.style.opacity = '1';
            row.style.transform = 'translateX(0)';
        }, index * 50);
    });
});

// Función para refrescar datos automáticamente cada 30 segundos
setInterval(function() {
    // Solo refrescar si la página está visible
    if (!document.hidden) {
        console.log('Refrescando datos del inbox...');
        // Aquí podrías implementar una actualización AJAX si fuera necesario
    }
}, 30000);
</script>

{% endblock %}