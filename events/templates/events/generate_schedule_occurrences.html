{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Generar Ocurrencias - {{ schedule.task.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-play-circle"></i> Generar Ocurrencias
                    </h3>
                    <div class="card-subtitle">
                        Programación: <strong>{{ schedule.task.title }}</strong>
                    </div>
                    <div class="card-tools">
                        <a href="{% url 'task_schedule_detail' schedule.id %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Información:</strong> Esta acción creará automáticamente instancias de TaskProgram
                        para las próximas ocurrencias basadas en la configuración de la programación recurrente.
                    </div>

                    <!-- Detalles de la programación -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Configuración Actual</h5>
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <strong>Tipo:</strong> {{ schedule.get_recurrence_type_display }}
                                </li>
                                <li class="list-group-item">
                                    <strong>Días:</strong> {{ schedule.get_selected_days_display }}
                                </li>
                                <li class="list-group-item">
                                    <strong>Hora:</strong> {{ schedule.start_time|time:"H:i" }}
                                </li>
                                <li class="list-group-item">
                                    <strong>Duración:</strong> {{ schedule.duration|time:"H:i" }} horas
                                </li>
                                <li class="list-group-item">
                                    <strong>Estado:</strong>
                                    {% if schedule.is_active %}
                                        <span class="badge badge-success">Activa</span>
                                    {% else %}
                                        <span class="badge badge-secondary">Inactiva</span>
                                    {% endif %}
                                </li>
                            </ul>
                        </div>

                        <div class="col-md-6">
                            <h5>Próximas Ocurrencias a Generar</h5>
                            {% if next_occurrences %}
                                <div class="list-group">
                                    {% for occurrence in next_occurrences %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ occurrence.date|date:"l, d/m/Y" }}</h6>
                                                <small class="text-success">
                                                    <i class="fas fa-plus-circle"></i> Se creará
                                                </small>
                                            </div>
                                            <p class="mb-1">
                                                <strong>Hora:</strong> {{ occurrence.start_time|time:"H:i" }} -
                                                {{ occurrence.end_time|time:"H:i" }}
                                            </p>
                                            <small class="text-muted">
                                                Duración: {{ schedule.duration|time:"H:i" }} horas
                                            </small>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-success">
                                        <strong>{{ next_occurrences|length }}</strong> ocurrencia(s) serán creadas.
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    No hay próximas ocurrencias para generar.
                                    Esto puede deberse a que ya se generaron todas las programaciones futuras
                                    o la fecha de fin ya fue alcanzada.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if next_occurrences %}
                        <div class="text-center">
                            <form method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-lg" id="generateBtn">
                                    <i class="fas fa-play"></i> Generar {{ next_occurrences|length }} Ocurrencia(s)
                                </button>
                                <a href="{% url 'task_schedule_detail' schedule.id %}" class="btn btn-secondary btn-lg ml-2">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </form>
                        </div>
                    {% else %}
                        <div class="text-center">
                            <a href="{% url 'task_schedule_detail' schedule.id %}" class="btn btn-primary">
                                <i class="fas fa-arrow-left"></i> Volver al Detalle
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Confirmación antes de generar
    $('form').on('submit', function(e) {
        var buttonText = $('#generateBtn').text().trim();
        var countMatch = buttonText.match(/Generar (\d+)/);
        var count = countMatch ? countMatch[1] : 'las';
        if (!confirm('¿Estás seguro de que quieres generar ' + count + ' ocurrencia(s) para esta programación?')) {
            e.preventDefault();
            return false;
        }
        return true;
    });
});
</script>
{% endblock %}