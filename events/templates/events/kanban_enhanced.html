{% extends 'layouts/base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}{{ title }} - Dashboard GTD Unificado{% endblock %}

{% block extra_head %}
<!-- Kanban Enhanced CSS -->
<link rel="stylesheet" href="{% static 'assets/css/kanban-enhanced.css' %}">
{% endblock %}

{% block content %}
<!-- Kanban Enhanced Container -->
<div class="kanban-enhanced">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="kanban-header">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="kanban-title">
                        <i class="bi bi-kanban-fill text-primary me-2"></i>
                        {{ title }}
                    </h1>
                    {% if project %}
                        <p class="kanban-subtitle">
                            <i class="bi bi-folder me-2"></i>
                            Proyecto: <strong>{{ project.title }}</strong>
                        </p>
                    {% else %}
                        <p class="kanban-subtitle">
                            <i class="bi bi-grid-3x3-gap me-2"></i>
                            Panel kanban mejorado para gestión de tareas
                        </p>
                    {% endif %}
                </div>
                <div class="col-lg-6 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                            <i class="bi bi-plus-circle me-1"></i>
                            Nueva Tarea
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
                            <i class="bi bi-funnel me-1"></i>
                            Filtros
                        </button>
                        <a href="{% url 'unified_dashboard' %}" class="btn btn-outline-info">
                            <i class="bi bi-speedometer2 me-1"></i>
                            Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbar Section -->
        <div class="kanban-toolbar">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Vista:</label>
                    <select class="form-select" id="viewMode">
                        <option value="normal">Normal</option>
                        <option value="compact">Compacta</option>
                        <option value="detailed">Detallada</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Ordenar por:</label>
                    <select class="form-select" id="sortBy">
                        <option value="updated_at">Fecha actualización</option>
                        <option value="created_at">Fecha creación</option>
                        <option value="title">Título</option>
                        <option value="priority">Prioridad</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Acciones:</label>
                    <div class="btn-group w-100">
                        <button class="btn btn-success btn-sm" onclick="refreshKanban()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Actualizar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportKanban()">
                            <i class="bi bi-download me-1"></i>
                            Exportar
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Tema:</label>
                    <button class="btn btn-outline-dark w-100" onclick="toggleTheme()">
                        <i class="bi bi-moon-fill me-1" id="themeIcon"></i>
                        Cambiar Tema
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="kanban-stats">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-list-task"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number">{{ total_tasks|default:0 }}</h3>
                            <p class="stat-label">Total Tareas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">
                            <i class="bi bi-play-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number">{{ in_progress_count|default:0 }}</h3>
                            <p class="stat-label">En Progreso</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-success">
                        <div class="stat-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number">{{ completed_count|default:0 }}</h3>
                            <p class="stat-label">Completadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number">{{ pending_count|default:0 }}</h3>
                            <p class="stat-label">Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Kanban Board -->
        <div class="kanban-board" id="kanbanBoard">
            {% for status_name, column in kanban_columns.items %}
            <div class="kanban-column column-{{ status_name|slugify }}" data-status="{{ status_name }}">
                <div class="column-header">
                    <div class="column-info">
                        <div class="column-icon">
                            <i class="bi bi-circle-fill"></i>
                        </div>
                        <h4 class="column-title">{{ column.title }}</h4>
                    </div>
                    <div class="column-count">{{ column.tasks|length }}</div>
                </div>

                <div class="column-tasks" data-status="{{ status_name }}">
                    {% for task_data in column.tasks %}
                    <div class="kanban-card {% if task_data.task.important %}important{% endif %}"
                         data-task-id="{{ task_data.task.id }}"
                         draggable="true">
                        <div class="card-header">
                            <div class="card-title">
                                {% if task_data.task.important %}
                                    <i class="bi bi-star-fill text-warning me-2"></i>
                                {% endif %}
                                <span>{{ task_data.task.title|truncatechars:50 }}</span>
                            </div>
                            {% if task_data.task.important %}
                                <div class="priority-badge">Alta</div>
                            {% endif %}
                        </div>

                        {% if task_data.task.description %}
                        <div class="card-description">
                            {{ task_data.task.description|truncatechars:100 }}
                        </div>
                        {% endif %}

                        <div class="card-tags">
                            {% if task_data.task.tags.all %}
                                {% for tag in task_data.task.tags.all|slice:":3" %}
                                <span class="tag tag-{{ tag.color|slugify }}">
                                    {{ tag.name }}
                                </span>
                                {% endfor %}
                                {% if task_data.task.tags.all|length > 3 %}
                                <span class="tag">+{{ task_data.task.tags.all|length|add:"-3" }}</span>
                                {% endif %}
                            {% endif %}
                        </div>

                        <div class="card-meta">
                            {% if task_data.task.project %}
                            <div class="meta-item">
                                <i class="bi bi-folder me-1"></i>
                                {{ task_data.task.project.title|truncatechars:20 }}
                            </div>
                            {% endif %}
                            {% if task_data.task.assigned_to %}
                            <div class="meta-item">
                                <i class="bi bi-person me-1"></i>
                                {{ task_data.task.assigned_to.username|truncatechars:15 }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="card-footer">
                            <div class="card-date">
                                <i class="bi bi-clock me-1"></i>
                                {{ task_data.task.updated_at|date:"d/m/Y H:i" }}
                            </div>
                            <div class="card-actions">
                                <a href="{% url 'tasks_with_id' task_data.task.id %}"
                                   class="btn-icon" title="Ver">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'task_edit' task_data.task.id %}"
                                   class="btn-icon" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-column">
                        <div class="empty-icon">
                            <i class="bi bi-clipboard-x"></i>
                        </div>
                        <div class="empty-text">Sin tareas</div>
                        <div class="empty-subtext">Las tareas aparecerán aquí</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Additional Sections -->
        <div class="kanban-sections">
            <div class="row g-4">
                <!-- Recent Projects -->
                <div class="col-lg-6">
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="bi bi-folder"></i>
                            </div>
                            <h3 class="section-title">Proyectos Recientes</h3>
                        </div>
                        <div class="section-content">
                            {% for project in recent_projects|slice:":5" %}
                            <div class="section-item">
                                <div class="item-icon">
                                    <i class="bi bi-circle-fill"></i>
                                </div>
                                <div class="item-content">
                                    <strong>{{ project.title }}</strong>
                                    <br>
                                    <small class="text-muted">{{ project.updated_at|date:"d/m/Y" }}</small>
                                </div>
                                <a href="{% url 'projects_with_id' project.id %}" class="item-action">
                                    Ver
                                </a>
                            </div>
                            {% empty %}
                            <div class="section-item">
                                <div class="item-content text-muted">
                                    No hay proyectos recientes
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Active Events -->
                <div class="col-lg-6">
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                            <h3 class="section-title">Eventos Activos</h3>
                        </div>
                        <div class="section-content">
                            {% for event in active_events|slice:":5" %}
                            <div class="section-item">
                                <div class="item-icon">
                                    <i class="bi bi-circle-fill"></i>
                                </div>
                                <div class="item-content">
                                    <strong>{{ event.title }}</strong>
                                    <br>
                                    <small class="text-muted">{{ event.updated_at|date:"d/m/Y" }}</small>
                                </div>
                                <a href="{% url 'event_detail' event.id %}" class="item-action">
                                    Ver
                                </a>
                            </div>
                            {% empty %}
                            <div class="section-item">
                                <div class="item-content text-muted">
                                    No hay eventos activos
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- NUEVA SECCIÓN: Herramientas GTD Avanzadas -->
            <div class="row g-4 mt-4">
                <div class="col-12">
                    <div class="section-card gtd-tools-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="bi bi-lightbulb"></i>
                            </div>
                            <h3 class="section-title">🧠 Herramientas GTD Avanzadas</h3>
                            <div class="section-subtitle">
                                Sistema completo de productividad personal
                            </div>
                        </div>
                        <div class="section-content">
                            <div class="row g-3">
                                <!-- Inbox GTD -->
                                <div class="col-md-3">
                                    <div class="gtd-tool-card" data-url="{% url 'inbox' %}" onclick="navigateToGTDTool(this)">
                                        <div class="tool-icon">
                                            <i class="bi bi-inbox-fill"></i>
                                        </div>
                                        <div class="tool-content">
                                            <h5>Inbox GTD</h5>
                                            <p class="tool-description">Captura rápida de tareas</p>
                                            <div class="tool-stats">
                                                <span class="badge bg-primary">{{ inbox_items|length }} pendientes</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Matriz Eisenhower -->
                                <div class="col-md-3">
                                    <div class="gtd-tool-card" data-url="{% url 'eisenhower_matrix' %}" onclick="navigateToGTDTool(this)">
                                        <div class="tool-icon">
                                            <i class="bi bi-grid-3x3-gap"></i>
                                        </div>
                                        <div class="tool-content">
                                            <h5>Matriz Eisenhower</h5>
                                            <p class="tool-description">Priorización inteligente</p>
                                            <div class="tool-stats">
                                                <span class="badge bg-warning">4 cuadrantes</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekly Review -->
                                <div class="col-md-3">
                                    <div class="gtd-tool-card" onclick="showWeeklyReview()">
                                        <div class="tool-icon">
                                            <i class="bi bi-calendar-week"></i>
                                        </div>
                                        <div class="tool-content">
                                            <h5>Weekly Review</h5>
                                            <p class="tool-description">Revisión semanal</p>
                                            <div class="tool-stats">
                                                <span class="badge bg-success">Próximo: {{ "now"|date:"l" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Plantillas -->
                                <div class="col-md-3">
                                    <div class="gtd-tool-card" data-url="{% url 'project_templates' %}" onclick="navigateToGTDTool(this)">
                                        <div class="tool-icon">
                                            <i class="bi bi-file-earmark-plus"></i>
                                        </div>
                                        <div class="tool-content">
                                            <h5>Plantillas</h5>
                                            <p class="tool-description">Proyectos recurrentes</p>
                                            <div class="tool-stats">
                                                <span class="badge bg-info">Reutilizables</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Métricas GTD -->
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <div class="gtd-metrics-card">
                                        <h6 class="metrics-title">
                                            <i class="bi bi-bar-chart-line me-2"></i>
                                            Productividad Hoy
                                        </h6>
                                        <div class="metrics-grid">
                                            <div class="metric-item">
                                                <span class="metric-value">{{ task_stats.completed }}</span>
                                                <span class="metric-label">Completadas</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-value">{{ task_stats.in_progress }}</span>
                                                <span class="metric-label">En Progreso</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-value">{{ task_stats.pending }}</span>
                                                <span class="metric-label">Pendientes</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="gtd-metrics-card">
                                        <h6 class="metrics-title">
                                            <i class="bi bi-bullseye me-2"></i>
                                            Próximos Objetivos
                                        </h6>
                                        <div class="objectives-list">
                                            <div class="objective-item">
                                                <i class="bi bi-check-circle text-success me-2"></i>
                                                Completar revisión semanal
                                            </div>
                                            <div class="objective-item">
                                                <i class="bi bi-circle text-warning me-2"></i>
                                                Procesar inbox items
                                            </div>
                                            <div class="objective-item">
                                                <i class="bi bi-circle text-muted me-2"></i>
                                                Planificar próxima semana
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="kanban-fab" data-bs-toggle="modal" data-bs-target="#createTaskModal" title="Crear nueva tarea">
    <i class="bi bi-plus"></i>
</button>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Nueva Tarea
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickCreateTaskForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Título *</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Proyecto</label>
                                <select class="form-select" name="project">
                                    <option value="">Sin proyecto</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Estado inicial</label>
                                <select class="form-select" name="task_status">
                                    {% for status_name, column in kanban_columns.items %}
                                    <option value="{{ status_name }}">{{ column.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="important" id="importantCheck">
                            <label class="form-check-label" for="importantCheck">
                                Marcar como importante
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createQuickTask()">Crear Tarea</button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-funnel me-2"></i>
                    Filtros
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for category in tag_categories %}
                <div class="mb-3">
                    <label class="form-label fw-bold">{{ category.name }}</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in category.tag_set.all %}
                        <button class="btn btn-sm btn-outline-secondary filter-tag" data-tag-id="{{ tag.id }}">
                            {{ tag.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                    <i class="bi bi-x-circle me-1"></i>
                    Limpiar Todo
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-check me-1"></i>
                    Aplicar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Kanban Enhanced JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeKanbanEnhanced();
    initializeDragAndDrop();
    initializeFilters();
    initializeTaskInteractions();
    initializeKeyboardShortcuts();
    setupTheme();
});

// Initialize enhanced kanban
function initializeKanbanEnhanced() {
    console.log('🚀 Inicializando Kanban Enhanced...');

    // Setup view mode
    setupViewMode();

    // Setup sorting
    setupSorting();

    // Apply dynamic styles
    applyDynamicStyles();

    console.log('✅ Kanban Enhanced inicializado');
}

// View mode setup
function setupViewMode() {
    const viewMode = document.getElementById('viewMode');
    if (viewMode) {
        viewMode.addEventListener('change', function() {
            const board = document.getElementById('kanbanBoard');
            board.className = `kanban-board ${this.value}-view`;
            showToast(`Vista cambiada a ${this.value}`, 'info');
        });
    }
}

// Sorting setup
function setupSorting() {
    const sortBy = document.getElementById('sortBy');
    if (sortBy) {
        sortBy.addEventListener('change', function() {
            applySorting();
        });
    }
}

// Apply sorting
function applySorting() {
    const columns = document.querySelectorAll('.kanban-column');

    columns.forEach(column => {
        const tasks = Array.from(column.querySelectorAll('.kanban-card'));
        tasks.sort((a, b) => {
            const taskA = kanbanData.tasks.find(t => t.task.id == a.dataset.taskId);
            const taskB = kanbanData.tasks.find(t => t.task.id == b.dataset.taskId);

            if (!taskA || !taskB) return 0;

            let valueA, valueB;

            switch(kanbanData.sortBy) {
                case 'title':
                    valueA = taskA.task.title.toLowerCase();
                    valueB = taskB.task.title.toLowerCase();
                    break;
                case 'created_at':
                    valueA = new Date(taskA.task.created_at);
                    valueB = new Date(taskB.task.created_at);
                    break;
                case 'priority':
                    valueA = taskA.task.important ? 0 : 1;
                    valueB = taskB.task.important ? 0 : 1;
                    break;
                default:
                    valueA = new Date(taskA.task.updated_at);
                    valueB = new Date(taskB.task.updated_at);
            }

            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        });

        const tasksContainer = column.querySelector('.column-tasks');
        tasks.forEach(task => tasksContainer.appendChild(task));
    });

    showToast(`Ordenado por ${getSortLabel(kanbanData.sortBy)}`, 'info');
}

// Drag and drop functionality
function initializeDragAndDrop() {
    const taskCards = document.querySelectorAll('.kanban-card[draggable="true"]');
    const columns = document.querySelectorAll('.kanban-column');

    taskCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });

    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
    });
}

// Filter functionality
function initializeFilters() {
    const filterTags = document.querySelectorAll('.filter-tag');

    filterTags.forEach(tag => {
        tag.addEventListener('click', function() {
            this.classList.toggle('active');
            applyFilters();
        });
    });
}

// Task interactions
function initializeTaskInteractions() {
    const taskCards = document.querySelectorAll('.kanban-card');

    taskCards.forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.closest('.card-actions') || e.target.closest('.btn-icon')) {
                return;
            }

            const taskId = this.dataset.taskId;
            if (taskId) {
                window.location.href = `/events/tasks/${taskId}/`;
            }
        });
    });
}

// Keyboard shortcuts
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        switch(e.key) {
            case '+':
                e.preventDefault();
                document.querySelector('[data-bs-target="#createTaskModal"]')?.click();
                break;
            case 'f':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    document.querySelector('[data-bs-target="#filterModal"]')?.click();
                }
                break;
            case 't':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    toggleTheme();
                }
                break;
            case 'Escape':
                clearAllFilters();
                break;
            case 'r':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    refreshKanban();
                }
                break;
        }
    });
}

// Theme management
function setupTheme() {
    const themeIcon = document.getElementById('themeIcon');
    if (kanbanData.theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.className = 'bi bi-sun-fill';
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        themeIcon.className = 'bi bi-moon-fill';
    }
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    document.documentElement.setAttribute('data-theme', newTheme);
    kanbanData.theme = newTheme;
    localStorage.setItem('kanbanTheme', newTheme);

    const themeIcon = document.getElementById('themeIcon');
    themeIcon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';

    showToast('Tema cambiado a ' + (newTheme === 'dark' ? 'oscuro' : 'claro'), 'info');
}

// Utility functions
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}

function getSortLabel(sortBy) {
    const labels = {
        'updated_at': 'fecha de actualización',
        'created_at': 'fecha de creación',
        'title': 'título',
        'priority': 'prioridad'
    };
    return labels[sortBy] || sortBy;
}

function applyFilters() {
    const activeFilters = Array.from(document.querySelectorAll('.filter-tag.active')).map(tag => tag.dataset.tagId);
    const taskCards = document.querySelectorAll('.kanban-card');

    taskCards.forEach(card => {
        const taskTags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent.trim());
        const shouldShow = activeFilters.length === 0 ||
            activeFilters.some(filterId => taskTags.includes(filterId));

        card.style.display = shouldShow ? 'block' : 'none';
    });

    updateColumnCounts();
    showToast(`Mostrando ${document.querySelectorAll('.kanban-card[style*="block"]').length} tareas`, 'info');
}

function clearAllFilters() {
    document.querySelectorAll('.filter-tag.active').forEach(tag => {
        tag.classList.remove('active');
    });
    applyFilters();
}

function createQuickTask() {
    const form = document.getElementById('quickCreateTaskForm');
    const formData = new FormData(form);

    if (!formData.get('title')) {
        showToast('El título es obligatorio', 'error');
        return;
    }

    showToast('Funcionalidad de creación rápida próximamente', 'info');
}

function refreshKanban() {
    showToast('Actualizando...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function exportKanban() {
    showToast('Exportación próximamente', 'info');
}

function applyDynamicStyles() {
    // Apply tag colors dynamically
    document.querySelectorAll('.tag').forEach(tag => {
        // Tags already have CSS classes applied, no need for dynamic styling
        // This function can be used for other dynamic styling if needed
    });
}

// Global kanban data
let kanbanData = {
    tasks: [],
    filters: {
        tags: [],
        status: [],
        projects: [],
        users: []
    },
    viewMode: 'normal',
    sortBy: 'updated_at',
    theme: localStorage.getItem('kanbanTheme') || 'light'
};

// Drag and drop handlers
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
    e.target.classList.add('dragging');
    document.body.classList.add('dragging-active');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
    });
    document.body.classList.remove('dragging-active');
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    const taskId = e.dataTransfer.getData('text/plain');
    const newStatus = e.currentTarget.dataset.status;

    if (taskId && newStatus) {
        moveTaskToColumn(taskId, newStatus);
    }
}

function moveTaskToColumn(taskId, newStatus) {
    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!card) return;

    const originalContent = card.innerHTML;
    card.innerHTML = `
        <div class="d-flex align-items-center justify-content-center p-3">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Moviendo tarea...</span>
        </div>
    `;

    fetch(`/events/tasks/change-status-ajax/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}&new_status_name=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newColumn = document.querySelector(`[data-status="${newStatus}"] .column-tasks`);
            if (newColumn) {
                const emptyState = newColumn.querySelector('.empty-column');
                if (emptyState) {
                    emptyState.remove();
                }

                newColumn.appendChild(card);
                updateColumnCounts();
                showToast('Tarea movida exitosamente', 'success');
            }
        } else {
            card.innerHTML = originalContent;
            showToast(data.error || 'Error al mover la tarea', 'error');
        }
    })
    .catch(error => {
        card.innerHTML = originalContent;
        showToast('Error de conexión', 'error');
        console.error('Error:', error);
    });
}

function updateColumnCounts() {
    document.querySelectorAll('.kanban-column').forEach(column => {
        const count = column.querySelectorAll('.kanban-card').length;
        const countElement = column.querySelector('.column-count');
        if (countElement) {
            countElement.textContent = count;
        }
    });
}

// NUEVAS FUNCIONES GTD
function navigateToGTDTool(element) {
    const url = element.getAttribute('data-url');
    if (url) {
        window.location.href = url;
    }
}

function showWeeklyReview() {
    showToast('Weekly Review - Próximamente', 'info');
    // Aquí se implementaría la funcionalidad de Weekly Review
}

function showMonthlyReview() {
    showToast('Monthly Review - Próximamente', 'info');
    // Aquí se implementaría la funcionalidad de Monthly Review
}

function showQuarterlyReview() {
    showToast('Quarterly Review - Próximamente', 'info');
    // Aquí se implementaría la funcionalidad de Quarterly Review
}

// Función para actualizar métricas GTD en tiempo real
function updateGTDMetrics() {
    fetch('/events/inbox_stats_api/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar métricas del inbox
                const inboxBadge = document.querySelector('.gtd-tool-card[data-url*="inbox"] .badge');
                if (inboxBadge) {
                    inboxBadge.textContent = data.stats.unprocessed + ' pendientes';
                }
            }
        })
        .catch(error => {
            console.log('Error actualizando métricas GTD:', error);
        });
}

// Inicializar actualización periódica de métricas
setInterval(updateGTDMetrics, 30000); // Cada 30 segundos

console.log('🎯 Kanban Enhanced completamente cargado');
</script>
{% endblock %}