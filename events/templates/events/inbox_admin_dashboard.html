{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="pagetitle">
    <h1>{{title}}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'panel' %}">Panel</a></li>
            <li class="breadcrumb-item active">{{title}}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<!-- Mensajes de confirmación y éxito -->
{% if messages %}
<div id="message-container" class="alert alert-info" role="alert">
    {% for message in messages %}
    <p{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</p>
        {% endfor %}
</div>
{% endif %}

<section class="section">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-6">
            <div class="card info-card sales-card">
                <div class="card-body">
                    <h5 class="card-title">Total <span>| Items</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div class="ps-3">
                            <h6>{{ stats.total }}</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <h5 class="card-title">Procesados <span>| Items</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="ps-3">
                            <h6>{{ stats.processed }}</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="card info-card customers-card">
                <div class="card-body">
                    <h5 class="card-title">Sin Procesar <span>| Items</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="ps-3">
                            <h6>{{ stats.unprocessed }}</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="card info-card customers-card">
                <div class="card-body">
                    <h5 class="card-title">Públicos <span>| Items</span></h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-globe"></i>
                        </div>
                        <div class="ps-3">
                            <h6>{{ stats.public }}</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-funnel me-2"></i>
                        Filtros de Búsqueda
                    </h5>

                    <!-- Filter Form -->
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="status" class="form-label">Estado</label>
                            <select name="status" id="status" class="form-select">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Todos</option>
                                <option value="processed" {% if status_filter == 'processed' %}selected{% endif %}>Procesados</option>
                                <option value="unprocessed" {% if status_filter == 'unprocessed' %}selected{% endif %}>Sin Procesar</option>
                                <option value="public" {% if status_filter == 'public' %}selected{% endif %}>Públicos</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="category" class="form-label">Categoría GTD</label>
                            <select name="category" id="category" class="form-select">
                                <option value="all" {% if category_filter == 'all' %}selected{% endif %}>Todas</option>
                                <option value="accionable" {% if category_filter == 'accionable' %}selected{% endif %}>Accionable</option>
                                <option value="no_accionable" {% if category_filter == 'no_accionable' %}selected{% endif %}>No Accionable</option>
                                <option value="pendiente" {% if category_filter == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="user" class="form-label">Usuario</label>
                            <select name="user" id="user" class="form-select">
                                <option value="all" {% if user_filter == 'all' %}selected{% endif %}>Todos</option>
                                {% for user in active_users %}
                                <option value="{{ user.user.id }}" {% if user_filter == user.user.id|stringformat:'s' %}selected{% endif %}>
                                    {{ user.user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="search" class="form-label">Buscar</label>
                            <input type="text" name="search" id="search" class="form-control"
                                   value="{{ search_query }}" placeholder="Título, descripción...">
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>
                                Filtrar
                            </button>
                            <a href="{% url 'inbox_admin_dashboard' %}" class="btn btn-secondary ms-2">
                                <i class="bi bi-x-circle me-2"></i>
                                Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Inbox Items Table -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-list me-2"></i>
                        Items del Inbox
                        <span class="badge bg-primary ms-2">{{ inbox_items|length }}</span>
                    </h5>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Título</th>
                                    <th scope="col">Descripción</th>
                                    <th scope="col">Creado por</th>
                                    <th scope="col">Asignado a</th>
                                    <th scope="col">Estado</th>
                                    <th scope="col">Categoría GTD</th>
                                    <th scope="col">Prioridad</th>
                                    <th scope="col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in inbox_items %}
                                <tr>
                                    <th scope="row">{{ item.id }}</th>
                                    <td>
                                        <strong>{{ item.title }}</strong>
                                        {% if item.important %}
                                        <i class="bi bi-star-fill text-warning ms-1" title="Importante"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.description %}
                                        <span title="{{ item.description }}">{{ item.description|truncatechars:50 }}</span>
                                        {% else %}
                                        <span class="text-muted">Sin descripción</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ item.created_by.username }}</span>
                                    </td>
                                    <td>
                                        {% if item.assigned_to %}
                                        <span class="badge bg-primary">{{ item.assigned_to.username }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Sin asignar</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_processed %}
                                        <span class="badge bg-success">Procesado</span>
                                        {% else %}
                                        <span class="badge bg-warning">Pendiente</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.gtd_category == 'accionable' %}
                                        <span class="badge bg-success">{{ item.gtd_category|title }}</span>
                                        {% elif item.gtd_category == 'no_accionable' %}
                                        <span class="badge bg-info">{{ item.gtd_category|title }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ item.gtd_category|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.priority == 'alta' %}
                                        <span class="badge bg-danger">{{ item.priority|title }}</span>
                                        {% elif item.priority == 'media' %}
                                        <span class="badge bg-warning">{{ item.priority|title }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ item.priority|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'inbox_item_detail_admin' item.id %}"
                                               class="btn btn-outline-info btn-sm"
                                               title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'process_inbox_item' item.id %}"
                                               class="btn btn-outline-primary btn-sm"
                                               title="Procesar item">
                                                <i class="bi bi-gear"></i>
                                            </a>
                                            {% if not item.is_processed %}
                                            <button class="btn btn-outline-success btn-sm mark-processed-btn"
                                                    title="Marcar como procesado"
                                                    data-item-id="{{ item.id }}">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="bi bi-inbox display-4 text-muted"></i>
                                        <p class="mt-2 text-muted">No hay items del inbox que coincidan con los filtros</p>
                                        <a href="{% url 'inbox' %}" class="btn btn-primary">
                                            <i class="bi bi-plus-circle me-2"></i>
                                            Ir al Inbox Principal
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Recent Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history me-2"></i>
                        Items Recientes
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in recent_items %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-grow-1">
                            <div class="fw-bold small">{{ item.title|truncatechars:30 }}</div>
                            <small class="text-muted">{{ item.created_by.username }} • {{ item.created_at|date:"d/m H:i" }}</small>
                        </div>
                        <div class="text-end">
                            {% if item.is_processed %}
                            <span class="badge bg-success">✓</span>
                            {% else %}
                            <span class="badge bg-warning">○</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted small">No hay items recientes</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Active Users -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-people me-2"></i>
                        Usuarios Activos
                    </h5>
                </div>
                <div class="card-body">
                    {% for user_data in active_users %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar avatar-sm me-3">
                            <span class="avatar-initial rounded-circle bg-primary">
                                {{ user_data.user.username|first|upper }}
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold small">{{ user_data.user.username }}</div>
                            <small class="text-muted">{{ user_data.user.email }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted small">No hay usuarios activos</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-lightning me-2"></i>
                        Acciones Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'inbox' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus-circle me-2"></i>
                            Nuevo Item
                        </a>
                        <a href="{% url 'inbox_management_panel' %}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-gear me-2"></i>
                            Panel de Gestión
                        </a>
                        <button class="btn btn-outline-success btn-sm" onclick="bulkMarkProcessed()">
                            <i class="bi bi-check-circle me-2"></i>
                            Procesar Todos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* Custom styles for admin dashboard */
.info-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

.sales-card .card-icon {
    color: #4154f1;
    background: #f6f6fe;
}

.revenue-card .card-icon {
    color: #2eca6a;
    background: #e7f8ed;
}

.customers-card .card-icon {
    color: #ff771d;
    background: #fff3e6;
}

.table th {
    background-color: #343a40;
    color: white;
    border: none;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
}

.card-title {
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.avatar-initial {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

/* Responsive */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }

    .btn-group-sm {
        flex-direction: column;
        gap: 0.25rem;
    }

    .btn-group-sm .btn {
        border-radius: 0.375rem !important;
    }
}
</style>

<script>
// JavaScript functions for admin dashboard
function markAsProcessed(itemId) {
    if (confirm('¿Marcar este item como procesado?')) {
        // Create form to send POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
            <input type="hidden" name="action" value="reference">
        `;

        document.body.appendChild(form);
        form.action = `/events/inbox/process/${itemId}/`;
        form.submit();
    }
}

// Event delegation for mark processed buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('mark-processed-btn') || e.target.closest('.mark-processed-btn')) {
        const btn = e.target.classList.contains('mark-processed-btn') ? e.target : e.target.closest('.mark-processed-btn');
        const itemId = btn.getAttribute('data-item-id');
        if (itemId) {
            markAsProcessed(itemId);
        }
    }
});

function bulkMarkProcessed() {
    if (confirm('¿Marcar todos los items visibles como procesados?')) {
        // This would need to be implemented with a bulk action endpoint
        alert('Función de procesamiento masivo en desarrollo');
    }
}

// Initialize tooltips and functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Add fade-in animation to table rows
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';

        setTimeout(() => {
            row.style.transition = 'all 0.4s ease-out';
            row.style.opacity = '1';
            row.style.transform = 'translateX(0)';
        }, index * 50);
    });
});

// Auto-refresh functionality (optional)
setInterval(function() {
    // Only refresh if page is visible
    if (!document.hidden) {
        console.log('Refreshing inbox admin data...');
        // Could implement AJAX refresh here if needed
    }
}, 60000); // Refresh every minute
</script>

{% endblock %}