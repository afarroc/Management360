{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}

<div class="pagetitle">
    <h1>{{ title }}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<!-- Mensajes de confirmación y éxito -->
{% if messages %}
<div id="message-container" class="alert alert-info" role="alert">
    {% for message in messages %}
    <p{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</p>
        {% endfor %}
</div>
{% endif %}

<section class="section">
    <!-- Información del Usuario Actual -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Información del Usuario Actual
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Información Básica del Usuario -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-fill me-2"></i>Datos Personales
                            </h6>
                            <div class="row">
                                <div class="col-sm-4"><strong>Usuario:</strong></div>
                                <div class="col-sm-8">{{ user_info.username }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Nombre:</strong></div>
                                <div class="col-sm-8">{{ user_info.first_name }} {{ user_info.last_name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Email:</strong></div>
                                <div class="col-sm-8">{{ user_info.email }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Registro:</strong></div>
                                <div class="col-sm-8">{{ user_info.date_joined|date:"d/m/Y H:i" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Último acceso:</strong></div>
                                <div class="col-sm-8">
                                    {% if user_info.last_login %}
                                        {{ user_info.last_login|date:"d/m/Y H:i" }}
                                    {% else %}
                                        Nunca
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Estado del Sistema y Rol -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-shield-check me-2"></i>Estado del Sistema
                            </h6>
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Tipo de Usuario:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge bg-{{ role_badge_class }} fs-6">{{ user_role }}</span>
                                </div>
                            </div>

                            {% if profile_info.role %}
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Rol del Sistema:</strong></div>
                                <div class="col-sm-8">
                                    <code>{{ profile_info.role }}</code>
                                </div>
                            </div>
                            {% endif %}

                            {% if profile_info.profession %}
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Profesión:</strong></div>
                                <div class="col-sm-8">{{ profile_info.profession }}</div>
                            </div>
                            {% endif %}

                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Estado:</strong></div>
                                <div class="col-sm-8">
                                    {% if user_info.is_active %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                    {% endif %}
                                    {% if user_info.is_staff %}
                                        <span class="badge bg-info ms-1">Staff</span>
                                    {% endif %}
                                    {% if user_info.is_superuser %}
                                        <span class="badge bg-warning ms-1">Superuser</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if player_info %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Habitación Actual:</strong></div>
                                <div class="col-sm-8">
                                    {% if player_info.current_room %}
                                        <span class="badge bg-secondary">{{ player_info.current_room }}</span>
                                    {% else %}
                                        <span class="text-muted">Ninguna</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if player_info %}
                    <hr>
                    <h6 class="text-success mb-3">
                        <i class="bi bi-controller me-2"></i>Estado del Player (3D)
                    </h6>
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-success fs-4">{{ player_info.energy }}%</div>
                                <small class="text-muted">Energía</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: {{ player_info.energy }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-info fs-4">{{ player_info.productivity }}%</div>
                                <small class="text-muted">Productividad</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-info" style="width: {{ player_info.productivity }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-warning fs-4">{{ player_info.social }}%</div>
                                <small class="text-muted">Social</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-warning" style="width: {{ player_info.social }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-muted fs-6">({{ player_info.position_x }}, {{ player_info.position_y }})</div>
                                <small class="text-muted">Posición</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Gestión Completa del Inbox GTD -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-inbox me-2"></i>
                        Gestión Completa del Inbox GTD
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                            <i class="bi bi-plus-circle"></i> Crear Item
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshInboxItems()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros para la tabla de Inbox -->
                    <div class="row mb-3">
                        <div class="col-md-2 mb-2">
                            <label for="filterCategory" class="form-label small">Categoría GTD</label>
                            <select class="form-select form-select-sm" id="filterCategory">
                                <option value="">Todas</option>
                                <option value="accionable">Accionable</option>
                                <option value="no_accionable">No Accionable</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterPriority" class="form-label small">Prioridad</label>
                            <select class="form-select form-select-sm" id="filterPriority">
                                <option value="">Todas</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterStatus" class="form-label small">Estado</label>
                            <select class="form-select form-select-sm" id="filterStatus">
                                <option value="">Todos</option>
                                <option value="processed">Procesado</option>
                                <option value="pending">Pendiente</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterUser" class="form-label small">Creado por</label>
                            <select class="form-select form-select-sm" id="filterUser">
                                <option value="">Todos</option>
                                {% for user in users_for_filter %}
                                <option value="{{ user.username }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterDateFrom" class="form-label small">Desde</label>
                            <input type="date" class="form-control form-control-sm" id="filterDateFrom">
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterDateTo" class="form-label small">Hasta</label>
                            <input type="date" class="form-control form-control-sm" id="filterDateTo">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-10 mb-2">
                            <label for="filterSearch" class="form-label small">Buscar</label>
                            <input type="text" class="form-control form-control-sm" id="filterSearch" placeholder="Título o descripción...">
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    {% if all_inbox_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="bi bi-hash"></i> ID</th>
                                    <th><i class="bi bi-tag"></i> Título</th>
                                    <th><i class="bi bi-person"></i> Creado por</th>
                                    <th><i class="bi bi-diagram-3"></i> Categoría GTD</th>
                                    <th><i class="bi bi-gear"></i> Acción</th>
                                    <th><i class="bi bi-flag"></i> Prioridad</th>
                                    <th><i class="bi bi-check-circle"></i> Estado</th>
                                    <th><i class="bi bi-calendar"></i> Creado</th>
                                    <th><i class="bi bi-person-plus"></i> Delegar a</th>
                                    <th><i class="bi bi-cogs"></i> Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in all_inbox_items %}
                                <tr>
                                    <td>
                                        <code class="text-muted">#{{ item.id }}</code>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ item.title|truncatechars:40 }}</strong>
                                            {% if item.description %}
                                            <br><small class="text-muted">{{ item.description|truncatechars:60 }}</small>
                                            {% endif %}
                                            {% if item.user_context and item.user_context.source == 'cx_email' %}
                                            <br><small class="badge bg-primary">CX Email</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ item.created_by.username }}</small>
                                    </td>
                                    <td>
                                        {% if item.gtd_category == 'accionable' %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Accionable
                                            </span>
                                        {% elif item.gtd_category == 'no_accionable' %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-x-circle"></i> No Accionable
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-question-circle"></i> Pendiente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.action_type %}
                                            <small class="text-primary">{{ item.get_action_type_display }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.priority == 'alta' %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle-fill"></i> Alta
                                            </span>
                                        {% elif item.priority == 'media' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-dash-circle"></i> Media
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-arrow-down-circle"></i> Baja
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_processed %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle-fill"></i> Procesado
                                            </span>
                                            {% if item.processed_at %}
                                            <br><small class="text-muted">{{ item.processed_at|date:"d/m H:i" }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-clock"></i> Pendiente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-nowrap">
                                            <strong>{{ item.created_at|date:"d/m/Y" }}</strong>
                                            <br><small class="text-muted">{{ item.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <select class="form-select form-select-sm delegate-select" data-item-id="{{ item.id }}" style="min-width: 120px;">
                                                <option value="">Seleccionar...</option>
                                                {% for user in all_users %}
                                                    {% if user != item.created_by %}
                                                        <option value="{{ user.id }}">{{ user.username }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                            <button class="btn btn-outline-success btn-sm" onclick="delegateInboxItem({{ item.id }})" title="Delegar">
                                                <i class="bi bi-person-plus"></i>
                                            </button>
                                        </div>
                                        {% if item.assigned_to %}
                                            <small class="text-muted">
                                                <i class="bi bi-check-circle-fill text-success"></i> {{ item.assigned_to.username }}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInboxItem({{ item.id }})" title="Ver">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" onclick="editInboxItem({{ item.id }})" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteInboxItem({{ item.id }}, '{{ item.title|escapejs }}')" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Mostrando {{ all_inbox_items|length }} items del inbox.
                            <a href="{% url 'inbox_management_panel' %}" class="text-decoration-none">Ver panel completo →</a>
                        </small>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary btn-sm" onclick="bulkProcessInboxItems()">
                                <i class="bi bi-check-all"></i> Procesar Seleccionados
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteInboxItems()">
                                <i class="bi bi-trash-fill"></i> Eliminar Seleccionados
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No hay items en el inbox</h5>
                        <p class="text-muted">El inbox está vacío. Los emails CX y otras interacciones aparecerán aquí automáticamente.</p>
                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                            <i class="bi bi-plus-circle me-2"></i>Crear Primer Item
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Item del Inbox -->
    <div class="modal fade" id="createInboxItemModal" tabindex="-1" aria-labelledby="createInboxItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createInboxItemModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Item del Inbox
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createInboxItemForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="itemTitle" class="form-label">Título *</label>
                                <input type="text" class="form-control" id="itemTitle" name="title" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="itemDescription" class="form-label">Descripción</label>
                                <textarea class="form-control" id="itemDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemCategory" class="form-label">Categoría GTD</label>
                                <select class="form-select" id="itemCategory" name="gtd_category">
                                    <option value="pendiente">Pendiente de Categorizar</option>
                                    <option value="accionable">Accionable</option>
                                    <option value="no_accionable">No Accionable</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemPriority" class="form-label">Prioridad</label>
                                <select class="form-select" id="itemPriority" name="priority">
                                    <option value="media">Media</option>
                                    <option value="alta">Alta</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemActionType" class="form-label">Tipo de Acción</label>
                                <select class="form-select" id="itemActionType" name="action_type">
                                    <option value="">Seleccionar...</option>
                                    <option value="hacer">Hacer</option>
                                    <option value="delegar">Delegar</option>
                                    <option value="posponer">Posponer</option>
                                    <option value="proyecto">Convertir en Proyecto</option>
                                    <option value="eliminar">Eliminar</option>
                                    <option value="archivar">Archivar para Referencia</option>
                                    <option value="incubar">Incubar (Algún Día)</option>
                                    <option value="esperar">Esperar Más Información</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemContext" class="form-label">Contexto</label>
                                <input type="text" class="form-control" id="itemContext" name="context" placeholder="@casa, @trabajo, etc.">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Crear Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contenedores del Dashboard -->
    <div class="row">
        <!-- Contenedor 1 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 1</h5>
                    <p class="card-text">Este es el primer contenedor responsivo. Se adapta automáticamente al tamaño de pantalla.</p>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Estado: Activo</small>
                        <span class="badge bg-success">OK</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 2 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 2</h5>
                    <p class="card-text">Segundo contenedor con información adicional y métricas básicas.</p>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-info" style="width: 75%"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">Progreso: 75%</small>
                </div>
            </div>
        </div>

        <!-- Contenedor 3 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 3</h5>
                    <p class="card-text">Tercer contenedor con elementos interactivos y botones de acción.</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary">Acción 1</button>
                        <button class="btn btn-sm btn-outline-secondary">Acción 2</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 4 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 4</h5>
                    <p class="card-text">Cuarto contenedor con iconos y elementos visuales.</p>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star text-warning me-2"></i>
                        <small class="text-muted ms-2">4.0/5.0</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 5 -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 5</h5>
                    <p class="card-text">Quinto contenedor con un ancho diferente (4 columnas en lg).</p>
                    <div class="alert alert-light border" role="alert">
                        <small>Este contenedor ocupa más espacio horizontal para contenido extenso.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 6 -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 6</h5>
                    <p class="card-text">Sexto contenedor con el mismo ancho que el anterior.</p>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Elemento 1</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Elemento 2</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Elemento 3</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Contenedor 7 -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 7</h5>
                    <p class="card-text">Séptimo contenedor completando la fila de 3 elementos.</p>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-primary"><i class="bi bi-people fs-4"></i></div>
                            <small>Usuarios</small>
                        </div>
                        <div class="col-4">
                            <div class="text-success"><i class="bi bi-check-circle fs-4"></i></div>
                            <small>Tareas</small>
                        </div>
                        <div class="col-4">
                            <div class="text-warning"><i class="bi bi-clock fs-4"></i></div>
                            <small>Tiempo</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 8 -->
        <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 8</h5>
                    <p class="card-text">Octavo contenedor ocupando la mitad del ancho (6 columnas).</p>
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-muted mb-2">Información Destacada</h6>
                        <p class="mb-0">Este contenedor tiene más espacio para contenido detallado y puede incluir gráficos o información más compleja.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 9 -->
        <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 9</h5>
                    <p class="card-text">Noveno contenedor complementando el ancho del anterior.</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Valor</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>A</td>
                                    <td>100</td>
                                    <td><span class="badge bg-success">OK</span></td>
                                </tr>
                                <tr>
                                    <td>B</td>
                                    <td>85</td>
                                    <td><span class="badge bg-warning">Advertencia</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 10 -->
        <div class="col-lg-8 col-md-8 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 10</h5>
                    <p class="card-text">Décimo contenedor con ancho mayor (8 columnas) para contenido principal.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Estadísticas</h6>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Proyectos:</span>
                                <strong>24</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Tareas:</span>
                                <strong>156</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Eventos:</span>
                                <strong>8</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Actividad Reciente</h6>
                            <small class="text-muted">Última actualización: hace 5 min</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 11 -->
        <div class="col-lg-4 col-md-4 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 11</h5>
                    <p class="card-text">Undécimo contenedor más estrecho (4 columnas).</p>
                    <div class="text-center">
                        <div class="avatar avatar-xl mb-3">
                            <img src="{% static 'assets/img/profile-img.jpg' %}" alt="Profile" class="avatar-img rounded-circle" onerror="this.src='{% static 'images/default-avatar.png' %}'">
                        </div>
                        <h6>Usuario Activo</h6>
                        <small class="text-muted">Conectado</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 12 -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 12</h5>
                    <p class="card-text">Duodécimo y último contenedor ocupando todo el ancho disponible (12 columnas).</p>
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading">Información Importante</h6>
                        <p class="mb-0">Este layout responsivo se adapta automáticamente a diferentes tamaños de pantalla. En dispositivos móviles, todos los contenedores se apilan verticalmente para una mejor experiencia de usuario.</p>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">Layout creado con Bootstrap Grid System - 12 contenedores responsivos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// Funciones CRUD para Inbox Items
function viewInboxItem(itemId) {
    // Abrir panel de administración para ver detalles del item
    window.open(`/events/inbox/admin/${itemId}/`, '_blank');
}

function editInboxItem(itemId) {
    // Por ahora, abrir el panel de administración (se puede mejorar con edición inline)
    window.open(`/events/inbox/admin/${itemId}/`, '_blank');
}

function deleteInboxItem(itemId, title) {
    if (confirm(`¿Estás seguro de que quieres eliminar el item "${title}"? Esta acción no se puede deshacer.`)) {
        // Usar la API de administración para eliminar
        fetch(`/events/inbox/admin/bulk-action/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `action=delete&selected_items=${itemId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || response.redirected) {
                location.reload();
            } else {
                alert('Error al eliminar el item: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el item');
        });
    }
}

function refreshInboxItems() {
    location.reload();
}

function bulkProcessInboxItems() {
    // Obtener items seleccionados (si se implementa checkbox)
    alert('Función de procesamiento masivo próximamente');
}

function bulkDeleteInboxItems() {
    // Obtener items seleccionados (si se implementa checkbox)
    alert('Función de eliminación masiva próximamente');
}

function delegateInboxItem(itemId) {
    const selectElement = document.querySelector(`.delegate-select[data-item-id="${itemId}"]`);
    const userId = selectElement.value;

    if (!userId) {
        alert('Por favor, selecciona un usuario para delegar.');
        return;
    }

    if (!confirm('¿Estás seguro de que quieres delegar este item al usuario seleccionado?')) {
        return;
    }

    // Mostrar loading
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    fetch('/events/root/bulk-actions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=delegate&selected_items[]=${itemId}&delegate_user_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la UI para mostrar el usuario asignado
            const cell = selectElement.closest('td');
            const existingBadge = cell.querySelector('.text-muted');
            if (existingBadge) {
                existingBadge.remove();
            }

            // Agregar indicador de asignación
            const badge = document.createElement('small');
            badge.className = 'text-muted d-block';
            badge.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> ${data.delegate_user}`;
            cell.appendChild(badge);

            // Resetear el select
            selectElement.value = '';

            alert(`Item delegado exitosamente a ${data.delegate_user}`);
        } else {
            alert('Error al delegar el item: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al delegar el item');
    })
    .finally(() => {
        // Restaurar botón
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}

// Funciones para verificación manual de emails
function checkNewEmails() {
    const btn = document.getElementById('checkEmailsBtn');
    const statusDiv = document.getElementById('emailCheckStatus');
    const messageSpan = document.getElementById('emailCheckMessage');

    // Deshabilitar botón y mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Verificando...';
    statusDiv.classList.remove('d-none');
    messageSpan.textContent = 'Verificando correos nuevos...';

    fetch('/events/api/check-new-emails/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageSpan.textContent = `¡Éxito! ${data.processed_count} emails procesados.`;
            statusDiv.classList.add('text-success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            messageSpan.textContent = `Error: ${data.error}`;
            statusDiv.classList.add('text-danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageSpan.textContent = 'Error de conexión';
        statusDiv.classList.add('text-danger');
    })
    .finally(() => {
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-envelope-arrow-down me-2"></i>Verificar Correos Nuevos';
    });
}

function processEmailsManually() {
    const btn = document.getElementById('processEmailsBtn');
    const statusDiv = document.getElementById('emailCheckStatus');
    const messageSpan = document.getElementById('emailCheckMessage');

    // Deshabilitar botón y mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-robot me-2"></i>Procesando...';
    statusDiv.classList.remove('d-none');
    messageSpan.textContent = 'Procesando emails CX...';

    fetch('/events/api/process-cx-emails/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageSpan.textContent = `¡Procesamiento completado! ${data.processed_count} emails procesados.`;
            statusDiv.classList.add('text-success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            messageSpan.textContent = `Error: ${data.error}`;
            statusDiv.classList.add('text-danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageSpan.textContent = 'Error de conexión';
        statusDiv.classList.add('text-danger');
    })
    .finally(() => {
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot me-2"></i>Procesar Emails CX';
    });
}

// Funciones de filtrado para la tabla de Inbox
function filterInboxTable() {
    const categoryFilter = document.getElementById('filterCategory').value.toLowerCase();
    const priorityFilter = document.getElementById('filterPriority').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value.toLowerCase();
    const userFilter = document.getElementById('filterUser').value.toLowerCase();
    const dateFromFilter = document.getElementById('filterDateFrom').value;
    const dateToFilter = document.getElementById('filterDateTo').value;
    const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

    const table = document.querySelector('.table.table-striped.table-hover');
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const categoryCell = row.cells[3]; // Categoría GTD
        const priorityCell = row.cells[5]; // Prioridad
        const statusCell = row.cells[6]; // Estado
        const createdCell = row.cells[7]; // Creado
        const userCell = row.cells[2]; // Creado por
        const titleCell = row.cells[1]; // Título y descripción

        // Obtener valores de las celdas
        const categoryText = categoryCell.textContent.toLowerCase();
        const priorityText = priorityCell.textContent.toLowerCase();
        const statusText = statusCell.textContent.toLowerCase();
        const userText = userCell.textContent.toLowerCase().trim();
        const titleText = titleCell.textContent.toLowerCase();

        // Extraer fecha de la celda de creación (formato: dd/mm/yyyy)
        let rowDate = null;
        if (createdCell) {
            const dateText = createdCell.textContent.trim();
            const dateMatch = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            if (dateMatch) {
                rowDate = new Date(dateMatch[3], dateMatch[2] - 1, dateMatch[1]);
            }
        }

        // Aplicar filtros
        const categoryMatch = !categoryFilter || categoryText.includes(categoryFilter);
        const priorityMatch = !priorityFilter || priorityText.includes(priorityFilter);
        const statusMatch = !statusFilter || statusText.includes(statusFilter);
        const userMatch = !userFilter || userText.includes(userFilter);
        const searchMatch = !searchFilter || titleText.includes(searchFilter);

        // Filtro de fecha desde
        let dateFromMatch = true;
        if (dateFromFilter && rowDate) {
            const fromDate = new Date(dateFromFilter);
            dateFromMatch = rowDate >= fromDate;
        }

        // Filtro de fecha hasta
        let dateToMatch = true;
        if (dateToFilter && rowDate) {
            const toDate = new Date(dateToFilter);
            toDate.setHours(23, 59, 59, 999); // Fin del día
            dateToMatch = rowDate <= toDate;
        }

        // Mostrar/ocultar fila
        if (categoryMatch && priorityMatch && statusMatch && userMatch && searchMatch && dateFromMatch && dateToMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterPriority').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterUser').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterSearch').value = '';
    filterInboxTable();
}

// Agregar event listeners a los filtros
document.addEventListener('DOMContentLoaded', function() {
    const filters = ['filterCategory', 'filterPriority', 'filterStatus', 'filterUser', 'filterDateFrom', 'filterDateTo', 'filterSearch'];

    filters.forEach(filterId => {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
            filterElement.addEventListener('input', filterInboxTable);
            filterElement.addEventListener('change', filterInboxTable);
        }
    });
});

// Manejar formulario de creación
document.getElementById('createInboxItemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/events/inbox/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal y recargar página
            const modal = bootstrap.Modal.getInstance(document.getElementById('createInboxItemModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error al crear el item: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear el item');
    });
});
</script>
{% endblock %}