{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}

<div class="pagetitle">
    <h1>{{ title }}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<!-- Mensajes de confirmación y éxito -->
{% if messages %}
<div id="message-container" class="alert alert-info" role="alert">
    {% for message in messages %}
    <p{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</p>
        {% endfor %}
</div>
{% endif %}

<section class="section">
    <!-- Información del Usuario Actual -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Información del Usuario Actual
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Información Básica del Usuario -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-fill me-2"></i>Datos Personales
                            </h6>
                            <div class="row">
                                <div class="col-sm-4"><strong>Usuario:</strong></div>
                                <div class="col-sm-8">{{ user_info.username }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Nombre:</strong></div>
                                <div class="col-sm-8">{{ user_info.first_name }} {{ user_info.last_name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Email:</strong></div>
                                <div class="col-sm-8">{{ user_info.email }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Registro:</strong></div>
                                <div class="col-sm-8">{{ user_info.date_joined|date:"d/m/Y H:i" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Último acceso:</strong></div>
                                <div class="col-sm-8">
                                    {% if user_info.last_login %}
                                        {{ user_info.last_login|date:"d/m/Y H:i" }}
                                    {% else %}
                                        Nunca
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Estado del Sistema y Rol -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-shield-check me-2"></i>Estado del Sistema
                            </h6>
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Tipo de Usuario:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge bg-{{ role_badge_class }} fs-6">{{ user_role }}</span>
                                </div>
                            </div>

                            {% if profile_info.role %}
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Rol del Sistema:</strong></div>
                                <div class="col-sm-8">
                                    <code>{{ profile_info.role }}</code>
                                </div>
                            </div>
                            {% endif %}

                            {% if profile_info.profession %}
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Profesión:</strong></div>
                                <div class="col-sm-8">{{ profile_info.profession }}</div>
                            </div>
                            {% endif %}

                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Estado:</strong></div>
                                <div class="col-sm-8">
                                    {% if user_info.is_active %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                    {% endif %}
                                    {% if user_info.is_staff %}
                                        <span class="badge bg-info ms-1">Staff</span>
                                    {% endif %}
                                    {% if user_info.is_superuser %}
                                        <span class="badge bg-warning ms-1">Superuser</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if player_info %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Habitación Actual:</strong></div>
                                <div class="col-sm-8">
                                    {% if player_info.current_room %}
                                        <span class="badge bg-secondary">{{ player_info.current_room }}</span>
                                    {% else %}
                                        <span class="text-muted">Ninguna</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if player_info %}
                    <hr>
                    <h6 class="text-success mb-3">
                        <i class="bi bi-controller me-2"></i>Estado del Player (3D)
                    </h6>
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-success fs-4">{{ player_info.energy }}%</div>
                                <small class="text-muted">Energía</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: {{ player_info.energy }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-info fs-4">{{ player_info.productivity }}%</div>
                                <small class="text-muted">Productividad</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-info" style="width: {{ player_info.productivity }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-warning fs-4">{{ player_info.social }}%</div>
                                <small class="text-muted">Social</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-warning" style="width: {{ player_info.social }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-muted fs-6">({{ player_info.position_x }}, {{ player_info.position_y }})</div>
                                <small class="text-muted">Posición</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Dashboard de Métricas y Resumen Ejecutivo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Dashboard Ejecutivo - Resumen del Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Estadísticas del Inbox -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 border-info card-dashboard">
                                <div class="card-body text-center">
                                    <div class="text-info mb-2">
                                        <i class="bi bi-inbox fs-1"></i>
                                    </div>
                                    <h4 class="text-info mb-1">{{ all_inbox_items|length }}</h4>
                                    <small class="text-muted">Items en Inbox</small>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-info" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Items Procesados Hoy -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 border-success card-dashboard">
                                <div class="card-body text-center">
                                    <div class="text-success mb-2">
                                        <i class="bi bi-check-circle-fill fs-1"></i>
                                    </div>
                                    <h4 class="text-success mb-1">{{ processed_today_count|default:0 }}</h4>
                                    <small class="text-muted">Procesados Hoy</small>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-success" style="width: {{ processed_percentage|default:0 }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Emails Procesados -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 border-primary card-dashboard">
                                <div class="card-body text-center">
                                    <div class="text-primary mb-2">
                                        <i class="bi bi-envelope fs-1"></i>
                                    </div>
                                    <h4 class="text-primary mb-1">{{ emails_processed_today|default:0 }}</h4>
                                    <small class="text-muted">Emails CX Hoy</small>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-primary" style="width: {{ email_processing_rate|default:0 }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Eficiencia del Sistema -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 border-warning card-dashboard">
                                <div class="card-body text-center">
                                    <div class="text-warning mb-2">
                                        <i class="bi bi-speedometer2 fs-1"></i>
                                    </div>
                                    <h4 class="text-warning mb-1">{{ system_efficiency|default:85 }}%</h4>
                                    <small class="text-muted">Eficiencia</small>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-warning" style="width: {{ system_efficiency|default:85 }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Sistema -->
                    <div class="row mt-4">
                        <div class="col-lg-8">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-info-circle me-2"></i>Estado del Sistema GTD
                            </h6>
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="text-success fs-4">●</div>
                                    <small class="text-muted">Inbox Activo</small>
                                </div>
                                <div class="col-3">
                                    <div class="text-primary fs-4">●</div>
                                    <small class="text-muted">Procesamiento OK</small>
                                </div>
                                <div class="col-3">
                                    <div class="text-info fs-4">●</div>
                                    <small class="text-muted">Emails CX OK</small>
                                </div>
                                <div class="col-3">
                                    <div class="text-warning fs-4">●</div>
                                    <small class="text-muted">Sistema Optimizado</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-clock me-2"></i>Última Actividad
                            </h6>
                            <div class="small text-muted">
                                <div class="mb-1">
                                    <i class="bi bi-check-circle text-success me-1"></i>
                                    Inbox actualizado: <strong>{{ last_inbox_update|default:"Nunca" }}</strong>
                                </div>
                                <div class="mb-1">
                                    <i class="bi bi-envelope text-primary me-1"></i>
                                    Emails procesados: <strong>{{ last_email_check|default:"Nunca" }}</strong>
                                </div>
                                <div class="mb-0">
                                    <i class="bi bi-robot text-info me-1"></i>
                                    Sistema optimizado: <strong>{{ last_optimization|default:"Reciente" }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Gestión Completa del Inbox GTD -->
    <!-- Panel de Acciones Rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-rocket me-2"></i>
                        Acciones Rápidas del Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <button class="btn btn-outline-primary w-100 p-3 h-100 d-flex flex-column align-items-center" onclick="refreshInboxItems()">
                                <i class="bi bi-arrow-clockwise fs-2 mb-2"></i>
                                <span>Actualizar Inbox</span>
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button class="btn btn-outline-info w-100 p-3 h-100 d-flex flex-column align-items-center" onclick="checkNewEmails()">
                                <i class="bi bi-envelope-arrow-down fs-2 mb-2"></i>
                                <span>Verificar Emails</span>
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button class="btn btn-outline-success w-100 p-3 h-100 d-flex flex-column align-items-center" onclick="processEmailsManually()">
                                <i class="bi bi-robot fs-2 mb-2"></i>
                                <span>Procesar Emails</span>
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button class="btn btn-outline-warning w-100 p-3 h-100 d-flex flex-column align-items-center" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                                <i class="bi bi-plus-circle fs-2 mb-2"></i>
                                <span>Crear Item</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-inbox me-2"></i>
                        Gestión Completa del Inbox GTD
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                            <i class="bi bi-plus-circle"></i> Crear Item
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshInboxItems()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros para la tabla de Inbox -->
                    <div class="row mb-3">
                        <div class="col-md-2 mb-2">
                            <label for="filterCategory" class="form-label small">Categoría GTD</label>
                            <select class="form-select form-select-sm" id="filterCategory">
                                <option value="">Todas</option>
                                <option value="accionable">Accionable</option>
                                <option value="no_accionable">No Accionable</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterPriority" class="form-label small">Prioridad</label>
                            <select class="form-select form-select-sm" id="filterPriority">
                                <option value="">Todas</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterStatus" class="form-label small">Estado</label>
                            <select class="form-select form-select-sm" id="filterStatus">
                                <option value="">Todos</option>
                                <option value="processed">Procesado</option>
                                <option value="pending">Pendiente</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterUser" class="form-label small">Creado por</label>
                            <select class="form-select form-select-sm" id="filterUser">
                                <option value="">Todos</option>
                                {% for user in users_for_filter %}
                                <option value="{{ user.username }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterDateFrom" class="form-label small">Desde</label>
                            <input type="date" class="form-control form-control-sm" id="filterDateFrom">
                        </div>
                        <div class="col-md-2 mb-2">
                            <label for="filterDateTo" class="form-label small">Hasta</label>
                            <input type="date" class="form-control form-control-sm" id="filterDateTo">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-10 mb-2">
                            <label for="filterSearch" class="form-label small">Buscar</label>
                            <input type="text" class="form-control form-control-sm" id="filterSearch" placeholder="Título o descripción...">
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    {% if all_inbox_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th class="d-none d-md-table-cell"><i class="bi bi-hash"></i></th>
                                    <th><i class="bi bi-tag"></i> Título</th>
                                    <th class="d-none d-lg-table-cell"><i class="bi bi-person"></i> Usuario</th>
                                    <th><i class="bi bi-diagram-3"></i> Estado</th>
                                    <th><i class="bi bi-flag"></i> Prioridad</th>
                                    <th class="d-none d-xl-table-cell"><i class="bi bi-calendar"></i> Creado</th>
                                    <th><i class="bi bi-cogs"></i> Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in all_inbox_items %}
                                <tr>
                                    <td class="d-none d-md-table-cell">
                                        <code class="text-muted small">#{{ item.id }}</code>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="d-block">{{ item.title|truncatechars:35 }}</strong>
                                            {% if item.description %}
                                            <small class="text-muted d-block">{{ item.description|truncatechars:45 }}</small>
                                            {% endif %}
                                            {% if item.user_context and item.user_context.source == 'cx_email' %}
                                            <span class="badge bg-primary badge-sm">CX</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <small>{{ item.created_by.username }}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column gap-1">
                                            {% if item.gtd_category == 'accionable' %}
                                                <span class="badge bg-success badge-sm">
                                                    <i class="bi bi-check-circle"></i> Acción
                                                </span>
                                            {% elif item.gtd_category == 'no_accionable' %}
                                                <span class="badge bg-secondary badge-sm">
                                                    <i class="bi bi-x-circle"></i> Ref
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark badge-sm">
                                                    <i class="bi bi-question-circle"></i> Pend
                                                </span>
                                            {% endif %}
                                            {% if item.is_processed %}
                                                <span class="badge bg-success badge-sm">
                                                    <i class="bi bi-check-circle-fill"></i> OK
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark badge-sm">
                                                    <i class="bi bi-clock"></i> Pend
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.priority == 'alta' %}
                                            <span class="badge bg-danger badge-sm">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                            </span>
                                        {% elif item.priority == 'media' %}
                                            <span class="badge bg-warning text-dark badge-sm">
                                                <i class="bi bi-dash-circle"></i>
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary badge-sm">
                                                <i class="bi bi-arrow-down-circle"></i>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-xl-table-cell">
                                        <small class="text-nowrap">{{ item.created_at|date:"d/m H:i" }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInboxItem({{ item.id }})" title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm d-none d-md-inline-block" onclick="editInboxItem({{ item.id }})" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteInboxItem({{ item.id }}, '{{ item.title|escapejs }}')" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                        <div class="d-flex flex-column flex-sm-row gap-2 align-items-start align-items-sm-center">
                            <small class="text-muted">
                                <strong>{{ all_inbox_items|length }}</strong> items en inbox
                            </small>
                            <a href="{% url 'inbox_management_panel' %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-gear me-1"></i>Panel Completo
                            </a>
                        </div>
                        <div class="btn-group btn-group-sm flex-wrap" role="group">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkProcessInboxItems()">
                                <i class="bi bi-check-all me-1"></i>Procesar
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteInboxItems()">
                                <i class="bi bi-trash-fill me-1"></i>Eliminar
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No hay items en el inbox</h5>
                        <p class="text-muted">El inbox está vacío. Los emails CX y otras interacciones aparecerán aquí automáticamente.</p>
                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                            <i class="bi bi-plus-circle me-2"></i>Crear Primer Item
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Item del Inbox -->
    <div class="modal fade" id="createInboxItemModal" tabindex="-1" aria-labelledby="createInboxItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createInboxItemModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Item del Inbox
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createInboxItemForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="itemTitle" class="form-label">Título *</label>
                                <input type="text" class="form-control" id="itemTitle" name="title" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="itemDescription" class="form-label">Descripción</label>
                                <textarea class="form-control" id="itemDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemCategory" class="form-label">Categoría GTD</label>
                                <select class="form-select" id="itemCategory" name="gtd_category">
                                    <option value="pendiente">Pendiente de Categorizar</option>
                                    <option value="accionable">Accionable</option>
                                    <option value="no_accionable">No Accionable</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemPriority" class="form-label">Prioridad</label>
                                <select class="form-select" id="itemPriority" name="priority">
                                    <option value="media">Media</option>
                                    <option value="alta">Alta</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemActionType" class="form-label">Tipo de Acción</label>
                                <select class="form-select" id="itemActionType" name="action_type">
                                    <option value="">Seleccionar...</option>
                                    <option value="hacer">Hacer</option>
                                    <option value="delegar">Delegar</option>
                                    <option value="posponer">Posponer</option>
                                    <option value="proyecto">Convertir en Proyecto</option>
                                    <option value="eliminar">Eliminar</option>
                                    <option value="archivar">Archivar para Referencia</option>
                                    <option value="incubar">Incubar (Algún Día)</option>
                                    <option value="esperar">Esperar Más Información</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemContext" class="form-label">Contexto</label>
                                <input type="text" class="form-control" id="itemContext" name="context" placeholder="@casa, @trabajo, etc.">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Crear Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Alertas y Mensajes -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">
                        <i class="bi bi-info-circle me-2"></i>Notificación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    <!-- El mensaje se insertará aquí dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sincronización de Correos CX -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-envelope-arrow-down me-2"></i>
                        Sincronización de Correos CX
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-light" id="checkEmailsBtn" onclick="checkNewEmails()">
                            <i class="bi bi-envelope-arrow-down"></i> Verificar Correos Nuevos
                        </button>
                        <button class="btn btn-sm btn-outline-light" id="processEmailsBtn" onclick="processEmailsManually()">
                            <i class="bi bi-robot"></i> Procesar Emails CX
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Estado de Sincronización -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-info-circle me-2"></i>Estado Actual
                            </h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">Servicio:</span>
                                <span class="badge bg-success" id="syncStatus">Activo</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">Última verificación:</span>
                                <small class="text-muted" id="lastCheckTime">Nunca</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">Procesados hoy:</span>
                                <strong class="text-primary" id="emailsProcessedToday">0</strong>
                            </div>
                        </div>

                        <!-- Configuración Rápida -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear me-2"></i>Configuración
                            </h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="autoSyncToggle" checked>
                                <label class="form-check-label small" for="autoSyncToggle">
                                    Auto-sincronización
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="notificationsToggle" checked>
                                <label class="form-check-label small" for="notificationsToggle">
                                    Notificaciones
                                </label>
                            </div>
                            <div class="mb-2">
                                <label for="syncInterval" class="form-label small mb-1">Intervalo:</label>
                                <select class="form-select form-select-sm" id="syncInterval">
                                    <option value="5">5 min</option>
                                    <option value="15" selected>15 min</option>
                                    <option value="30">30 min</option>
                                    <option value="60">1 hora</option>
                                </select>
                            </div>
                        </div>

                        <!-- Estado de Procesamiento -->
                        <div class="col-lg-4 col-md-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-activity me-2"></i>Actividad
                            </h6>
                            <div id="emailCheckStatus" class="alert alert-info d-none py-2" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="sr-only">Cargando...</span>
                                    </div>
                                    <small id="emailCheckMessage">Procesando...</small>
                                </div>
                            </div>
                            <div class="text-center text-muted small" id="noActivityMessage">
                                <i class="bi bi-check-circle-fill text-success me-1"></i>
                                Servicio activo - Procesamiento automático
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Centro de Bots -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-robot me-2"></i>Centro de Bots
                    </h5>
                    <small class="text-light">Simulación de tareas con credenciales reales</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-4 mb-3">
                            <label for="botSelect" class="form-label fw-bold">Seleccionar Bot</label>
                            <select class="form-select" id="botSelect" onchange="updateBotTasks()">
                                <option value="">-- Seleccionar Bot --</option>
                                {% for bot in available_bots %}
                                <option value="{{ bot.id }}" data-icon="{{ bot.icon }}" data-color="{{ bot.color }}">
                                    {{ bot.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <small id="botDescription" class="text-muted">Selecciona un bot para ver su descripción y tareas disponibles.</small>
                            </div>
                        </div>
                        <div class="col-lg-5 mb-3">
                            <label class="form-label fw-bold">Seleccionar Tareas</label>
                            <div id="taskOptions" class="border rounded p-3 bg-light" style="min-height: 120px;">
                                <small class="text-muted">Selecciona un bot para ver las tareas disponibles.</small>
                            </div>
                        </div>
                        <div class="col-lg-3 mb-3 d-flex align-items-end">
                            <div class="w-100">
                                <button class="btn btn-primary w-100 mb-2" id="activateBotBtn" onclick="activateBot()" disabled>
                                    <i class="bi bi-play-circle me-2"></i>Activar Bot
                                </button>
                                <div id="activationStatus" class="small text-muted text-center">
                                    <!-- Estado de activación se mostrará aquí -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resultados de la activación -->
                    <div id="activationResults" class="mt-3" style="display: none;">
                        <div class="alert alert-success" role="alert">
                            <h6 class="alert-heading">
                                <i class="bi bi-check-circle-fill me-2"></i>Activación Completada
                            </h6>
                            <div id="activationSummary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

{% endblock %}

{% block extra_css %}
<style>
/* Estilos personalizados para el dashboard root */
.badge-sm {
    font-size: 0.7em;
    padding: 0.2em 0.4em;
}

.card-dashboard {
    transition: transform 0.2s ease-in-out;
}

.card-dashboard:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.table-responsive {
    border-radius: 0.375rem;
    overflow: hidden;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .btn-group-sm {
        flex-direction: column;
        width: 100%;
    }

    .btn-group-sm .btn {
        margin-bottom: 0.25rem;
    }

    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Animaciones para los indicadores de estado */
@keyframes pulse-success {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.status-indicator {
    animation: pulse-success 2s infinite;
}

/* Mejorar la apariencia de los filtros */
.form-select-sm {
    border-radius: 0.25rem;
}

.input-group-sm .form-select {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.input-group-sm .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Datos de bots disponibles (pasados desde Django)
const availableBots = {{ available_bots_json|safe }};

// Funciones para mostrar modales de alerta y confirmación
function showAlertModal(title, message, type = 'info') {
    const modal = new bootstrap.Modal(document.getElementById('alertModal'));
    const modalTitle = document.getElementById('alertModalLabel');
    const modalBody = document.getElementById('alertModalBody');

    // Configurar icono según el tipo
    const icons = {
        'success': 'bi-check-circle-fill text-success',
        'danger': 'bi-exclamation-triangle-fill text-danger',
        'warning': 'bi-exclamation-triangle-fill text-warning',
        'info': 'bi-info-circle-fill text-info'
    };

    modalTitle.innerHTML = `<i class="bi ${icons[type] || icons['info']} me-2"></i>${title}`;
    modalBody.innerHTML = `<p class="mb-0">${message}</p>`;

    modal.show();
}

function showConfirmModal(title, message, type = 'warning', onConfirm, onCancel) {
    // Crear modal de confirmación dinámicamente
    const modalHtml = `
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">
                            <i class="bi bi-question-circle-fill text-${type} me-2"></i>${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-0">${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmCancelBtn">Cancelar</button>
                        <button type="button" class="btn btn-${type}" id="confirmOkBtn">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const confirmBtn = document.getElementById('confirmOkBtn');
    const cancelBtn = document.getElementById('confirmCancelBtn');

    // Configurar eventos
    confirmBtn.addEventListener('click', () => {
        modal.hide();
        if (onConfirm) onConfirm();
        // Remover modal del DOM después de ocultarlo
        setTimeout(() => {
            document.getElementById('confirmModal').remove();
        }, 300);
    });

    cancelBtn.addEventListener('click', () => {
        modal.hide();
        if (onCancel) onCancel();
        // Remover modal del DOM después de ocultarlo
        setTimeout(() => {
            document.getElementById('confirmModal').remove();
        }, 300);
    });

    // Remover modal si se cierra con la X o haciendo click fuera
    document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
        if (onCancel) onCancel();
        document.getElementById('confirmModal').remove();
    });

    modal.show();
}

// Funciones CRUD para Inbox Items
function viewInboxItem(itemId) {
    // Abrir panel de administración para ver detalles del item
    window.open(`/events/inbox/admin/${itemId}/`, '_blank');
}

function editInboxItem(itemId) {
    // Por ahora, abrir el panel de administración (se puede mejorar con edición inline)
    window.open(`/events/inbox/admin/${itemId}/`, '_blank');
}

function deleteInboxItem(itemId, title) {
    console.log('=== INICIO deleteInboxItem ===');
    console.log('itemId:', itemId);
    console.log('title:', title);

    // Mostrar modal de confirmación personalizado en lugar de confirm()
    showConfirmModal(
        `¿Estás seguro de que quieres eliminar el item "${title}"?`,
        'Esta acción no se puede deshacer.',
        'danger',
        () => {
            console.log('Usuario confirmó eliminación');

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            console.log('CSRF Token encontrado:', csrfToken ? 'Sí (' + csrfToken.substring(0, 10) + '...)' : 'No');

            const url = `/events/inbox/admin/bulk-action/`;
            const body = `action=delete&selected_items=${itemId}`;

            console.log('URL completa:', window.location.origin + url);
            console.log('Body:', body);
            console.log('Current location:', window.location.href);
            console.log('Is HTTPS:', window.location.protocol === 'https:');

            // Usar la API de administración para eliminar
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: body
            })
            .then(response => {
                console.log('=== RESPONSE RECIBIDA ===');
                console.log('Response status:', response.status);
                console.log('Response statusText:', response.statusText);
                console.log('Response ok:', response.ok);
                console.log('Response redirected:', response.redirected);
                console.log('Response url:', response.url);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                // Verificar si es un redirect
                if (response.redirected) {
                    console.log('RESPUESTA ES REDIRECT - URL final:', response.url);
                }

                // Intentar leer el contenido como texto primero
                return response.text().then(text => {
                    console.log('Contenido de respuesta (primeros 500 chars):', text.substring(0, 500));

                    // Verificar si es HTML
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        console.error('ERROR: La respuesta es HTML, no JSON!');
                        console.log('Contenido HTML completo:', text);
                        throw new Error('Respuesta HTML en lugar de JSON');
                    }

                    // Si no es HTML, intentar parsear como JSON
                    try {
                        const jsonData = JSON.parse(text);
                        console.log('JSON parseado exitosamente:', jsonData);
                        return jsonData;
                    } catch (jsonError) {
                        console.error('Error al parsear JSON:', jsonError);
                        console.log('Texto que falló en JSON:', text);
                        throw jsonError;
                    }
                });
            })
            .then(data => {
                console.log('=== PROCESANDO DATA ===');
                console.log('Data recibida:', data);
                console.log('data.success:', data.success);
                console.log('data.success type:', typeof data.success);
                console.log('data.error:', data.error);
                console.log('data.message:', data.message);
                console.log('response.redirected check:', data.response ? data.response.redirected : 'N/A');

                if (data.success === true || data.success === "true") {
                    console.log('Eliminación exitosa, recargando página');
                    showAlertModal('Item eliminado exitosamente', data.message || 'El item ha sido eliminado correctamente.', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    console.log('Error en data.success, mostrando modal de error');
                    console.log('data.success value:', data.success);
                    showAlertModal('Error al eliminar el item', data.error || data.message || 'Error desconocido', 'danger');
                }
            })
            .catch(error => {
                console.error('=== ERROR EN deleteInboxItem ===');
                console.error('Error completo:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error name:', error.name);
                console.error('Error type:', typeof error);

                // Verificar si es un error de red
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    console.error('ERROR DE RED: Posible problema de conectividad o CORS');
                }

                // Verificar si es un error de JSON
                if (error instanceof SyntaxError) {
                    console.error('ERROR DE JSON: La respuesta no es JSON válido');
                }

                showAlertModal('Error al eliminar el item', `Error: ${error.message}. Revisa la consola para más detalles.`, 'danger');
            });
        },
        () => {
            console.log('Usuario canceló la eliminación');
        }
    );

    console.log('=== FIN deleteInboxItem ===');
}

function refreshInboxItems() {
    location.reload();
}

function bulkProcessInboxItems() {
    // Obtener items seleccionados (si se implementa checkbox)
    showAlertModal('Función próximamente', 'La función de procesamiento masivo estará disponible próximamente.', 'info');
}

function bulkDeleteInboxItems() {
    // Obtener items seleccionados (si se implementa checkbox)
    showAlertModal('Función próximamente', 'La función de eliminación masiva estará disponible próximamente.', 'info');
}

function delegateInboxItem(itemId) {
    const selectElement = document.querySelector(`.delegate-select[data-item-id="${itemId}"]`);
    const userId = selectElement.value;

    if (!userId) {
        showAlertModal('Usuario requerido', 'Por favor, selecciona un usuario para delegar.', 'warning');
        return;
    }

    showConfirmModal(
        'Confirmar delegación',
        '¿Estás seguro de que quieres delegar este item al usuario seleccionado?',
        'primary',
        () => {
            // Continuar con la delegación
            performDelegation(itemId, userId);
        }
    );
}

function performDelegation(itemId, userId) {

    // Mostrar loading
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    fetch('/events/root/bulk-actions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=delegate&selected_items[]=${itemId}&delegate_user_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la UI para mostrar el usuario asignado
            const cell = selectElement.closest('td');
            const existingBadge = cell.querySelector('.text-muted');
            if (existingBadge) {
                existingBadge.remove();
            }

            // Agregar indicador de asignación
            const badge = document.createElement('small');
            badge.className = 'text-muted d-block';
            badge.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> ${data.delegate_user}`;
            cell.appendChild(badge);

            // Resetear el select
            selectElement.value = '';

            showAlertModal('Delegación exitosa', `Item delegado exitosamente a ${data.delegate_user}`, 'success');
        } else {
            showAlertModal('Error al delegar', data.error || 'Error desconocido', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlertModal('Error al delegar', 'Error al delegar el item', 'danger');
    })
    .finally(() => {
        // Restaurar botón
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}

// Funciones para verificación manual de emails
function checkNewEmails() {
    const btn = document.getElementById('checkEmailsBtn');
    const statusDiv = document.getElementById('emailCheckStatus');
    const messageSpan = document.getElementById('emailCheckMessage');

    // Deshabilitar botón y mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Verificando...';
    statusDiv.classList.remove('d-none');
    messageSpan.textContent = 'Verificando correos nuevos...';

    fetch('/events/api/check-new-emails/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageSpan.textContent = `¡Éxito! ${data.processed_count} emails procesados.`;
            statusDiv.classList.add('text-success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            messageSpan.textContent = `Error: ${data.error}`;
            statusDiv.classList.add('text-danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageSpan.textContent = 'Error de conexión';
        statusDiv.classList.add('text-danger');
        showAlertModal('Error de conexión', 'No se pudo conectar con el servidor para verificar emails.', 'danger');
    })
    .finally(() => {
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-envelope-arrow-down me-2"></i>Verificar Correos Nuevos';
    });
}

function processEmailsManually() {
    const btn = document.getElementById('processEmailsBtn');
    const statusDiv = document.getElementById('emailCheckStatus');
    const messageSpan = document.getElementById('emailCheckMessage');

    // Deshabilitar botón y mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-robot me-2"></i>Procesando...';
    statusDiv.classList.remove('d-none');
    messageSpan.textContent = 'Procesando emails CX...';

    fetch('/events/api/process-cx-emails/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageSpan.textContent = `¡Procesamiento completado! ${data.processed_count} emails procesados.`;
            statusDiv.classList.add('text-success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            messageSpan.textContent = `Error: ${data.error}`;
            statusDiv.classList.add('text-danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageSpan.textContent = 'Error de conexión';
        statusDiv.classList.add('text-danger');
        showAlertModal('Error de conexión', 'No se pudo conectar con el servidor para procesar emails.', 'danger');
    })
    .finally(() => {
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot me-2"></i>Procesar Emails CX';
    });
}

// Funciones de filtrado para la tabla de Inbox
function filterInboxTable() {
    const categoryFilter = document.getElementById('filterCategory').value.toLowerCase();
    const priorityFilter = document.getElementById('filterPriority').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value.toLowerCase();
    const userFilter = document.getElementById('filterUser').value.toLowerCase();
    const dateFromFilter = document.getElementById('filterDateFrom').value;
    const dateToFilter = document.getElementById('filterDateTo').value;
    const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

    const table = document.querySelector('.table.table-striped.table-hover');
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const categoryCell = row.cells[3]; // Categoría GTD
        const priorityCell = row.cells[5]; // Prioridad
        const statusCell = row.cells[6]; // Estado
        const createdCell = row.cells[7]; // Creado
        const userCell = row.cells[2]; // Creado por
        const titleCell = row.cells[1]; // Título y descripción

        // Obtener valores de las celdas
        const categoryText = categoryCell.textContent.toLowerCase();
        const priorityText = priorityCell.textContent.toLowerCase();
        const statusText = statusCell.textContent.toLowerCase();
        const userText = userCell.textContent.toLowerCase().trim();
        const titleText = titleCell.textContent.toLowerCase();

        // Extraer fecha de la celda de creación (formato: dd/mm/yyyy)
        let rowDate = null;
        if (createdCell) {
            const dateText = createdCell.textContent.trim();
            const dateMatch = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            if (dateMatch) {
                rowDate = new Date(dateMatch[3], dateMatch[2] - 1, dateMatch[1]);
            }
        }

        // Aplicar filtros
        const categoryMatch = !categoryFilter || categoryText.includes(categoryFilter);
        const priorityMatch = !priorityFilter || priorityText.includes(priorityFilter);
        const statusMatch = !statusFilter || statusText.includes(statusFilter);
        const userMatch = !userFilter || userText.includes(userFilter);
        const searchMatch = !searchFilter || titleText.includes(searchFilter);

        // Filtro de fecha desde
        let dateFromMatch = true;
        if (dateFromFilter && rowDate) {
            const fromDate = new Date(dateFromFilter);
            dateFromMatch = rowDate >= fromDate;
        }

        // Filtro de fecha hasta
        let dateToMatch = true;
        if (dateToFilter && rowDate) {
            const toDate = new Date(dateToFilter);
            toDate.setHours(23, 59, 59, 999); // Fin del día
            dateToMatch = rowDate <= toDate;
        }

        // Mostrar/ocultar fila
        if (categoryMatch && priorityMatch && statusMatch && userMatch && searchMatch && dateFromMatch && dateToMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterPriority').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterUser').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterSearch').value = '';
    filterInboxTable();
}

// Agregar event listeners a los filtros
document.addEventListener('DOMContentLoaded', function() {
    const filters = ['filterCategory', 'filterPriority', 'filterStatus', 'filterUser', 'filterDateFrom', 'filterDateTo', 'filterSearch'];

    filters.forEach(filterId => {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
            filterElement.addEventListener('input', filterInboxTable);
            filterElement.addEventListener('change', filterInboxTable);
        }
    });
});

// Funciones para el Centro de Bots
function updateBotTasks() {
    const botSelect = document.getElementById('botSelect');
    const taskOptions = document.getElementById('taskOptions');
    const botDescription = document.getElementById('botDescription');
    const activateBtn = document.getElementById('activateBotBtn');

    const selectedBotId = botSelect.value;

    if (!selectedBotId) {
        taskOptions.innerHTML = '<small class="text-muted">Selecciona un bot para ver las tareas disponibles.</small>';
        botDescription.textContent = 'Selecciona un bot para ver su descripción y tareas disponibles.';
        activateBtn.disabled = true;
        return;
    }

    // Buscar el bot seleccionado en availableBots
    const selectedBot = availableBots.find(bot => bot.id === selectedBotId);

    if (selectedBot) {
        // Actualizar descripción
        botDescription.innerHTML = `<strong>${selectedBot.name}:</strong> ${selectedBot.description}`;

        // Generar checkboxes para las tareas
        let tasksHtml = '<div class="mb-2"><small class="text-muted fw-bold">Selecciona las tareas a ejecutar:</small></div>';
        selectedBot.tasks.forEach(task => {
            tasksHtml += `
                <div class="form-check">
                    <input class="form-check-input task-checkbox" type="checkbox" value="${task.id}" id="task_${task.id}">
                    <label class="form-check-label" for="task_${task.id}">
                        <strong>${task.name}</strong>
                        <br><small class="text-muted">${task.description}</small>
                    </label>
                </div>
            `;
        });

        taskOptions.innerHTML = tasksHtml;

        // Habilitar botón de activación
        activateBtn.disabled = false;

        // Agregar event listeners a los checkboxes
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateActivateButton);
        });
    }
}

function updateActivateButton() {
    const checkedTasks = document.querySelectorAll('.task-checkbox:checked');
    const activateBtn = document.getElementById('activateBotBtn');
    const activationStatus = document.getElementById('activationStatus');

    if (checkedTasks.length > 0) {
        activateBtn.disabled = false;
        activationStatus.innerHTML = `<small class="text-success">${checkedTasks.length} tarea(s) seleccionada(s)</small>`;
    } else {
        activateBtn.disabled = true;
        activationStatus.innerHTML = '<small class="text-muted">Selecciona al menos una tarea</small>';
    }
}

function activateBot() {
    const botSelect = document.getElementById('botSelect');
    const activateBtn = document.getElementById('activateBotBtn');
    const activationStatus = document.getElementById('activationStatus');
    const activationResults = document.getElementById('activationResults');
    const activationSummary = document.getElementById('activationSummary');

    const botId = botSelect.value;
    const selectedTasks = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => cb.value);

    if (!botId || selectedTasks.length === 0) {
        showAlertModal('Error', 'Selecciona un bot y al menos una tarea', 'warning');
        return;
    }

    // Deshabilitar botón y mostrar loading
    activateBtn.disabled = true;
    activateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Activando...';
    activationStatus.innerHTML = '<small class="text-info">Procesando activación...</small>';

    // Preparar datos para envío
    const formData = new FormData();
    formData.append('bot_id', botId);
    selectedTasks.forEach(task => {
        formData.append('tasks[]', task);
    });

    fetch('/events/root/activate-bot/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar resultados exitosos
            let summaryHtml = `<p class="mb-2"><strong>Bot activado:</strong> ${data.bot_name}</p>`;
            summaryHtml += '<ul class="mb-0">';

            data.executed_tasks.forEach(task => {
                const statusIcon = task.status === 'success' ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-warning';
                const statusText = task.status === 'success' ? 'Completado' : 'Error';
                summaryHtml += `
                    <li class="mb-1">
                        <i class="bi ${statusIcon} me-1"></i>
                        <strong>${task.task_id}:</strong> ${statusText}
                        ${task.result ? `<br><small class="text-muted ms-3">${task.result}</small>` : ''}
                        ${task.error ? `<br><small class="text-danger ms-3">${task.error}</small>` : ''}
                    </li>
                `;
            });

            summaryHtml += '</ul>';
            activationSummary.innerHTML = summaryHtml;
            activationResults.style.display = 'block';

            // Resetear formulario
            botSelect.value = '';
            updateBotTasks();

            showAlertModal('Activación Exitosa', `Bot ${data.bot_name} activado correctamente`, 'success');
        } else {
            showAlertModal('Error en activación', data.error || 'Error desconocido', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlertModal('Error de conexión', 'No se pudo conectar con el servidor para activar el bot', 'danger');
    })
    .finally(() => {
        // Restaurar botón
        activateBtn.disabled = false;
        activateBtn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Activar Bot';
        activationStatus.innerHTML = '';
    });
}

// Manejar formulario de creación
document.getElementById('createInboxItemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/events/inbox/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal y recargar página
            const modal = bootstrap.Modal.getInstance(document.getElementById('createInboxItemModal'));
            modal.hide();
            location.reload();
        } else {
            showAlertModal('Error al crear', 'Error al crear el item: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlertModal('Error al crear', 'Error al crear el item', 'danger');
    });
});
</script>
{% endblock %}