{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}

<div class="pagetitle">
    <h1>{{ title }}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<!-- Mensajes de confirmación y éxito -->
{% if messages %}
<div id="message-container" class="alert alert-info" role="alert">
    {% for message in messages %}
    <p{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</p>
        {% endfor %}
</div>
{% endif %}

<section class="section">
    <!-- Información del Usuario Actual -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Información del Usuario Actual
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Información Básica del Usuario -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-fill me-2"></i>Datos Personales
                            </h6>
                            <div class="row">
                                <div class="col-sm-4"><strong>Usuario:</strong></div>
                                <div class="col-sm-8">{{ user_info.username }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Nombre:</strong></div>
                                <div class="col-sm-8">{{ user_info.first_name }} {{ user_info.last_name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Email:</strong></div>
                                <div class="col-sm-8">{{ user_info.email }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Registro:</strong></div>
                                <div class="col-sm-8">{{ user_info.date_joined|date:"d/m/Y H:i" }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Último acceso:</strong></div>
                                <div class="col-sm-8">
                                    {% if user_info.last_login %}
                                        {{ user_info.last_login|date:"d/m/Y H:i" }}
                                    {% else %}
                                        Nunca
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Estado del Sistema y Rol -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-shield-check me-2"></i>Estado del Sistema
                            </h6>
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Tipo de Usuario:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge bg-{{ role_badge_class }} fs-6">{{ user_role }}</span>
                                </div>
                            </div>

                            {% if profile_info.role %}
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Rol del Sistema:</strong></div>
                                <div class="col-sm-8">
                                    <code>{{ profile_info.role }}</code>
                                </div>
                            </div>
                            {% endif %}

                            {% if profile_info.profession %}
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Profesión:</strong></div>
                                <div class="col-sm-8">{{ profile_info.profession }}</div>
                            </div>
                            {% endif %}

                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Estado:</strong></div>
                                <div class="col-sm-8">
                                    {% if user_info.is_active %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactivo</span>
                                    {% endif %}
                                    {% if user_info.is_staff %}
                                        <span class="badge bg-info ms-1">Staff</span>
                                    {% endif %}
                                    {% if user_info.is_superuser %}
                                        <span class="badge bg-warning ms-1">Superuser</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if player_info %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Habitación Actual:</strong></div>
                                <div class="col-sm-8">
                                    {% if player_info.current_room %}
                                        <span class="badge bg-secondary">{{ player_info.current_room }}</span>
                                    {% else %}
                                        <span class="text-muted">Ninguna</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if player_info %}
                    <hr>
                    <h6 class="text-success mb-3">
                        <i class="bi bi-controller me-2"></i>Estado del Player (3D)
                    </h6>
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-success fs-4">{{ player_info.energy }}%</div>
                                <small class="text-muted">Energía</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: {{ player_info.energy }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-info fs-4">{{ player_info.productivity }}%</div>
                                <small class="text-muted">Productividad</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-info" style="width: {{ player_info.productivity }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-warning fs-4">{{ player_info.social }}%</div>
                                <small class="text-muted">Social</small>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-warning" style="width: {{ player_info.social }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="text-center">
                                <div class="text-muted fs-6">({{ player_info.position_x }}, {{ player_info.position_y }})</div>
                                <small class="text-muted">Posición</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Items de Email CX -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-envelope-paper me-2"></i>
                        Items Recibidos por Email CX
                    </h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">Total: {{ cx_stats.total }}</span>
                        <span class="badge bg-success me-2">Procesados: {{ cx_stats.processed }}</span>
                        <span class="badge bg-warning">Pendientes: {{ cx_stats.unprocessed }}</span>
                        <span class="badge bg-primary ms-2">Hoy: {{ cx_stats.today }}</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if cx_email_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="bi bi-hash"></i> ID</th>
                                    <th><i class="bi bi-tag"></i> Título</th>
                                    <th><i class="bi bi-person"></i> Remitente</th>
                                    <th><i class="bi bi-envelope"></i> Email</th>
                                    <th><i class="bi bi-flag"></i> Prioridad</th>
                                    <th><i class="bi bi-check-circle"></i> Estado</th>
                                    <th><i class="bi bi-calendar"></i> Fecha</th>
                                    <th><i class="bi bi-robot"></i> Asignado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cx_email_items %}
                                <tr>
                                    <td>
                                        <code class="text-muted">#{{ item.id }}</code>
                                    </td>
                                    <td>
                                        <strong>{{ item.title|truncatechars:50 }}</strong>
                                        {% if item.description %}
                                        <br><small class="text-muted">{{ item.description|truncatechars:80 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.user_context.customer_id %}
                                        <span class="badge bg-secondary">{{ item.user_context.customer_id }}</span>
                                        {% else %}
                                        <span class="text-muted">No identificado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="font-monospace">{{ item.user_context.email_sender|truncatechars:30 }}</small>
                                    </td>
                                    <td>
                                        {% if item.priority == 'alta' %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle-fill"></i> Alta
                                            </span>
                                        {% elif item.priority == 'media' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-dash-circle"></i> Media
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-arrow-down-circle"></i> Baja
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_processed %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle-fill"></i> Procesado
                                            </span>
                                            {% if item.processed_at %}
                                            <br><small class="text-muted">{{ item.processed_at|date:"d/m H:i" }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-clock"></i> Pendiente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-nowrap">
                                            <strong>{{ item.created_at|date:"d/m/Y" }}</strong>
                                            <br><small class="text-muted">{{ item.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.user_context.assigned_to %}
                                            <span class="badge bg-info">
                                                <i class="bi bi-robot"></i> {{ item.user_context.assigned_to }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">
                                                <i class="bi bi-person"></i> Sin asignar
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            Mostrando los últimos {{ cx_email_items|length }} items de email CX.
                            <a href="{% url 'inbox_admin_dashboard' %}" class="text-decoration-none">Ver todos →</a>
                        </small>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-envelope-x display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No hay items de email CX</h5>
                        <p class="text-muted">Los emails procesados aparecerán aquí automáticamente.</p>
                        <div class="mt-3">
                            <small class="text-muted">
                                Para probar el procesamiento de emails, ejecuta:<br>
                                <code class="bg-light px-2 py-1 rounded">python manage.py process_cx_emails</code>
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración Backend de Email -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Configuración Backend de Email
                    </h5>
                    <div>
                        {% if email_backend_info.smtp_status == 'Conectado' %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle-fill"></i> SMTP: {{ email_backend_info.smtp_status }}
                            </span>
                        {% elif email_backend_info.smtp_status == 'No configurado' %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-dash-circle"></i> SMTP: {{ email_backend_info.smtp_status }}
                            </span>
                        {% else %}
                            <span class="badge bg-danger">
                                <i class="bi bi-x-circle-fill"></i> SMTP: Error
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Configuración SMTP -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-secondary mb-3">
                                <i class="bi bi-send me-2"></i>Configuración SMTP (Envío)
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted" style="width: 40%;"><strong>Backend:</strong></td>
                                            <td>
                                                <code class="text-primary">{{ email_backend_info.backend }}</code>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Host:</strong></td>
                                            <td>
                                                {% if email_backend_info.host != 'No configurado' %}
                                                    <code>{{ email_backend_info.host }}</code>
                                                {% else %}
                                                    <span class="text-muted">{{ email_backend_info.host }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Puerto:</strong></td>
                                            <td>
                                                {% if email_backend_info.port != 'No configurado' %}
                                                    <code>{{ email_backend_info.port }}</code>
                                                {% else %}
                                                    <span class="text-muted">{{ email_backend_info.port }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>TLS:</strong></td>
                                            <td>
                                                {% if email_backend_info.use_tls %}
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-shield-check"></i> Habilitado
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-shield-x"></i> Deshabilitado
                                                    </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Usuario:</strong></td>
                                            <td>
                                                {% if email_backend_info.host_user != 'No configurado' %}
                                                    <code>{{ email_backend_info.host_user }}</code>
                                                {% else %}
                                                    <span class="text-muted">{{ email_backend_info.host_user }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Configuración IMAP y CX -->
                        <div class="col-lg-6 col-md-6">
                            <h6 class="text-secondary mb-3">
                                <i class="bi bi-envelope-arrow-down me-2"></i>Configuración IMAP (Recepción) & CX
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted" style="width: 40%;"><strong>Recepción:</strong></td>
                                            <td>
                                                {% if email_backend_info.reception_enabled %}
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle"></i> Habilitada
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="bi bi-dash-circle"></i> Deshabilitada
                                                    </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>IMAP Host:</strong></td>
                                            <td>
                                                {% if email_backend_info.imap_host != 'No configurado' %}
                                                    <code>{{ email_backend_info.imap_host }}</code>
                                                {% else %}
                                                    <span class="text-muted">{{ email_backend_info.imap_host }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>IMAP Puerto:</strong></td>
                                            <td>
                                                {% if email_backend_info.imap_port != 'No configurado' %}
                                                    <code>{{ email_backend_info.imap_port }}</code>
                                                {% else %}
                                                    <span class="text-muted">{{ email_backend_info.imap_port }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Dominios CX:</strong></td>
                                            <td>
                                                {% if email_backend_info.cx_domains %}
                                                    <div class="d-flex flex-wrap gap-1">
                                                        {% for domain in email_backend_info.cx_domains %}
                                                            <span class="badge bg-info">{{ domain }}</span>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">No configurados</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted"><strong>Palabras clave CX:</strong></td>
                                            <td>
                                                {% if email_backend_info.cx_keywords %}
                                                    <div class="d-flex flex-wrap gap-1">
                                                        {% for keyword in email_backend_info.cx_keywords %}
                                                            <span class="badge bg-warning text-dark">{{ keyword }}</span>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">No configuradas</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Estado de Conectividad -->
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-secondary mb-3">
                                <i class="bi bi-activity me-2"></i>Estado de Conectividad
                            </h6>
                            <div class="row text-center">
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body py-3">
                                            <div class="text-secondary mb-1">
                                                <i class="bi bi-send fs-4"></i>
                                            </div>
                                            <div class="fs-6 fw-bold">
                                                {% if email_backend_info.smtp_status == 'Conectado' %}
                                                    <span class="text-success">SMTP OK</span>
                                                {% elif email_backend_info.smtp_status == 'No configurado' %}
                                                    <span class="text-muted">No Configurado</span>
                                                {% else %}
                                                    <span class="text-danger">SMTP Error</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">Envío de Emails</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body py-3">
                                            <div class="text-secondary mb-1">
                                                <i class="bi bi-envelope-arrow-down fs-4"></i>
                                            </div>
                                            <div class="fs-6 fw-bold">
                                                {% if email_backend_info.reception_enabled %}
                                                    <span class="text-success">IMAP OK</span>
                                                {% else %}
                                                    <span class="text-muted">Deshabilitado</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">Recepción de Emails</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body py-3">
                                            <div class="text-secondary mb-1">
                                                <i class="bi bi-robot fs-4"></i>
                                            </div>
                                            <div class="fs-6 fw-bold">
                                                <span class="text-info">CX Activo</span>
                                            </div>
                                            <small class="text-muted">Procesamiento Automático</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body py-3">
                                            <div class="text-secondary mb-1">
                                                <i class="bi bi-gear fs-4"></i>
                                            </div>
                                            <div class="fs-6 fw-bold">
                                                <span class="text-primary">Configurado</span>
                                            </div>
                                            <small class="text-muted">Sistema Listo</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información adicional -->
                    <div class="mt-3">
                        <div class="alert alert-light border" role="alert">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Nota:</strong> La configuración de email se gestiona en el archivo <code>panel/settings.py</code>.
                                Para probar el envío de emails, ejecuta: <code class="bg-light px-1 rounded">python manage.py sendtestemail</code>
                            </small>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success btn-sm" onclick="checkNewEmails()" id="checkEmailsBtn">
                                <i class="bi bi-envelope-arrow-down me-2"></i>Verificar Correos Nuevos
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="processEmailsManually()" id="processEmailsBtn">
                                <i class="bi bi-robot me-2"></i>Procesar Emails CX
                            </button>
                            <div id="emailCheckStatus" class="d-none">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Verificando...</span>
                                </div>
                                <small class="text-muted ms-2" id="emailCheckMessage">Verificando correos nuevos...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestión Completa del Inbox GTD -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-inbox me-2"></i>
                        Gestión Completa del Inbox GTD
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                            <i class="bi bi-plus-circle"></i> Crear Item
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshInboxItems()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if all_inbox_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="bi bi-hash"></i> ID</th>
                                    <th><i class="bi bi-tag"></i> Título</th>
                                    <th><i class="bi bi-person"></i> Creado por</th>
                                    <th><i class="bi bi-diagram-3"></i> Categoría GTD</th>
                                    <th><i class="bi bi-gear"></i> Acción</th>
                                    <th><i class="bi bi-flag"></i> Prioridad</th>
                                    <th><i class="bi bi-check-circle"></i> Estado</th>
                                    <th><i class="bi bi-calendar"></i> Creado</th>
                                    <th><i class="bi bi-cogs"></i> Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in all_inbox_items %}
                                <tr>
                                    <td>
                                        <code class="text-muted">#{{ item.id }}</code>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ item.title|truncatechars:40 }}</strong>
                                            {% if item.description %}
                                            <br><small class="text-muted">{{ item.description|truncatechars:60 }}</small>
                                            {% endif %}
                                            {% if item.user_context and item.user_context.source == 'cx_email' %}
                                            <br><small class="badge bg-primary">CX Email</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ item.created_by.username }}</small>
                                    </td>
                                    <td>
                                        {% if item.gtd_category == 'accionable' %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Accionable
                                            </span>
                                        {% elif item.gtd_category == 'no_accionable' %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-x-circle"></i> No Accionable
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-question-circle"></i> Pendiente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.action_type %}
                                            <small class="text-primary">{{ item.get_action_type_display }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.priority == 'alta' %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle-fill"></i> Alta
                                            </span>
                                        {% elif item.priority == 'media' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-dash-circle"></i> Media
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-arrow-down-circle"></i> Baja
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_processed %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle-fill"></i> Procesado
                                            </span>
                                            {% if item.processed_at %}
                                            <br><small class="text-muted">{{ item.processed_at|date:"d/m H:i" }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-clock"></i> Pendiente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-nowrap">
                                            <strong>{{ item.created_at|date:"d/m/Y" }}</strong>
                                            <br><small class="text-muted">{{ item.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInboxItem({{ item.id }})" title="Ver">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" onclick="editInboxItem({{ item.id }})" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteInboxItem({{ item.id }}, '{{ item.title|escapejs }}')" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Mostrando {{ all_inbox_items|length }} items del inbox.
                            <a href="{% url 'inbox_management_panel' %}" class="text-decoration-none">Ver panel completo →</a>
                        </small>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary btn-sm" onclick="bulkProcessInboxItems()">
                                <i class="bi bi-check-all"></i> Procesar Seleccionados
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteInboxItems()">
                                <i class="bi bi-trash-fill"></i> Eliminar Seleccionados
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No hay items en el inbox</h5>
                        <p class="text-muted">El inbox está vacío. Los emails CX y otras interacciones aparecerán aquí automáticamente.</p>
                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#createInboxItemModal">
                            <i class="bi bi-plus-circle me-2"></i>Crear Primer Item
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Item del Inbox -->
    <div class="modal fade" id="createInboxItemModal" tabindex="-1" aria-labelledby="createInboxItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createInboxItemModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Item del Inbox
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createInboxItemForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="itemTitle" class="form-label">Título *</label>
                                <input type="text" class="form-control" id="itemTitle" name="title" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="itemDescription" class="form-label">Descripción</label>
                                <textarea class="form-control" id="itemDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemCategory" class="form-label">Categoría GTD</label>
                                <select class="form-select" id="itemCategory" name="gtd_category">
                                    <option value="pendiente">Pendiente de Categorizar</option>
                                    <option value="accionable">Accionable</option>
                                    <option value="no_accionable">No Accionable</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemPriority" class="form-label">Prioridad</label>
                                <select class="form-select" id="itemPriority" name="priority">
                                    <option value="media">Media</option>
                                    <option value="alta">Alta</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemActionType" class="form-label">Tipo de Acción</label>
                                <select class="form-select" id="itemActionType" name="action_type">
                                    <option value="">Seleccionar...</option>
                                    <option value="hacer">Hacer</option>
                                    <option value="delegar">Delegar</option>
                                    <option value="posponer">Posponer</option>
                                    <option value="proyecto">Convertir en Proyecto</option>
                                    <option value="eliminar">Eliminar</option>
                                    <option value="archivar">Archivar para Referencia</option>
                                    <option value="incubar">Incubar (Algún Día)</option>
                                    <option value="esperar">Esperar Más Información</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="itemContext" class="form-label">Contexto</label>
                                <input type="text" class="form-control" id="itemContext" name="context" placeholder="@casa, @trabajo, etc.">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Crear Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contenedores del Dashboard -->
    <div class="row">
        <!-- Contenedor 1 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 1</h5>
                    <p class="card-text">Este es el primer contenedor responsivo. Se adapta automáticamente al tamaño de pantalla.</p>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Estado: Activo</small>
                        <span class="badge bg-success">OK</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 2 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 2</h5>
                    <p class="card-text">Segundo contenedor con información adicional y métricas básicas.</p>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-info" style="width: 75%"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">Progreso: 75%</small>
                </div>
            </div>
        </div>

        <!-- Contenedor 3 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 3</h5>
                    <p class="card-text">Tercer contenedor con elementos interactivos y botones de acción.</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary">Acción 1</button>
                        <button class="btn btn-sm btn-outline-secondary">Acción 2</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 4 -->
        <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 4</h5>
                    <p class="card-text">Cuarto contenedor con iconos y elementos visuales.</p>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <i class="bi bi-star text-warning me-2"></i>
                        <small class="text-muted ms-2">4.0/5.0</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 5 -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 5</h5>
                    <p class="card-text">Quinto contenedor con un ancho diferente (4 columnas en lg).</p>
                    <div class="alert alert-light border" role="alert">
                        <small>Este contenedor ocupa más espacio horizontal para contenido extenso.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 6 -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 6</h5>
                    <p class="card-text">Sexto contenedor con el mismo ancho que el anterior.</p>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Elemento 1</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Elemento 2</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Elemento 3</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Contenedor 7 -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 7</h5>
                    <p class="card-text">Séptimo contenedor completando la fila de 3 elementos.</p>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-primary"><i class="bi bi-people fs-4"></i></div>
                            <small>Usuarios</small>
                        </div>
                        <div class="col-4">
                            <div class="text-success"><i class="bi bi-check-circle fs-4"></i></div>
                            <small>Tareas</small>
                        </div>
                        <div class="col-4">
                            <div class="text-warning"><i class="bi bi-clock fs-4"></i></div>
                            <small>Tiempo</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 8 -->
        <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 8</h5>
                    <p class="card-text">Octavo contenedor ocupando la mitad del ancho (6 columnas).</p>
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-muted mb-2">Información Destacada</h6>
                        <p class="mb-0">Este contenedor tiene más espacio para contenido detallado y puede incluir gráficos o información más compleja.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 9 -->
        <div class="col-lg-6 col-md-6 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 9</h5>
                    <p class="card-text">Noveno contenedor complementando el ancho del anterior.</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Valor</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>A</td>
                                    <td>100</td>
                                    <td><span class="badge bg-success">OK</span></td>
                                </tr>
                                <tr>
                                    <td>B</td>
                                    <td>85</td>
                                    <td><span class="badge bg-warning">Advertencia</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 10 -->
        <div class="col-lg-8 col-md-8 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 10</h5>
                    <p class="card-text">Décimo contenedor con ancho mayor (8 columnas) para contenido principal.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Estadísticas</h6>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Proyectos:</span>
                                <strong>24</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Tareas:</span>
                                <strong>156</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Eventos:</span>
                                <strong>8</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Actividad Reciente</h6>
                            <small class="text-muted">Última actualización: hace 5 min</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 11 -->
        <div class="col-lg-4 col-md-4 col-sm-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 11</h5>
                    <p class="card-text">Undécimo contenedor más estrecho (4 columnas).</p>
                    <div class="text-center">
                        <div class="avatar avatar-xl mb-3">
                            <img src="{% static 'assets/img/profile-img.jpg' %}" alt="Profile" class="avatar-img rounded-circle" onerror="this.src='{% static 'images/default-avatar.png' %}'">
                        </div>
                        <h6>Usuario Activo</h6>
                        <small class="text-muted">Conectado</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor 12 -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Contenedor 12</h5>
                    <p class="card-text">Duodécimo y último contenedor ocupando todo el ancho disponible (12 columnas).</p>
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading">Información Importante</h6>
                        <p class="mb-0">Este layout responsivo se adapta automáticamente a diferentes tamaños de pantalla. En dispositivos móviles, todos los contenedores se apilan verticalmente para una mejor experiencia de usuario.</p>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">Layout creado con Bootstrap Grid System - 12 contenedores responsivos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// Funciones CRUD para Inbox Items
function viewInboxItem(itemId) {
    // Abrir panel de administración para ver detalles del item
    window.open(`/events/inbox/admin/${itemId}/`, '_blank');
}

function editInboxItem(itemId) {
    // Por ahora, abrir el panel de administración (se puede mejorar con edición inline)
    window.open(`/events/inbox/admin/${itemId}/`, '_blank');
}

function deleteInboxItem(itemId, title) {
    if (confirm(`¿Estás seguro de que quieres eliminar el item "${title}"? Esta acción no se puede deshacer.`)) {
        // Usar la API de administración para eliminar
        fetch(`/events/inbox/admin/bulk-action/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `action=delete&selected_items=${itemId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || response.redirected) {
                location.reload();
            } else {
                alert('Error al eliminar el item: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el item');
        });
    }
}

function refreshInboxItems() {
    location.reload();
}

function bulkProcessInboxItems() {
    // Obtener items seleccionados (si se implementa checkbox)
    alert('Función de procesamiento masivo próximamente');
}

function bulkDeleteInboxItems() {
    // Obtener items seleccionados (si se implementa checkbox)
    alert('Función de eliminación masiva próximamente');
}

// Funciones para verificación manual de emails
function checkNewEmails() {
    const btn = document.getElementById('checkEmailsBtn');
    const statusDiv = document.getElementById('emailCheckStatus');
    const messageSpan = document.getElementById('emailCheckMessage');

    // Deshabilitar botón y mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Verificando...';
    statusDiv.classList.remove('d-none');
    messageSpan.textContent = 'Verificando correos nuevos...';

    fetch('/events/api/check-new-emails/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageSpan.textContent = `¡Éxito! ${data.processed_count} emails procesados.`;
            statusDiv.classList.add('text-success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            messageSpan.textContent = `Error: ${data.error}`;
            statusDiv.classList.add('text-danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageSpan.textContent = 'Error de conexión';
        statusDiv.classList.add('text-danger');
    })
    .finally(() => {
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-envelope-arrow-down me-2"></i>Verificar Correos Nuevos';
    });
}

function processEmailsManually() {
    const btn = document.getElementById('processEmailsBtn');
    const statusDiv = document.getElementById('emailCheckStatus');
    const messageSpan = document.getElementById('emailCheckMessage');

    // Deshabilitar botón y mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-robot me-2"></i>Procesando...';
    statusDiv.classList.remove('d-none');
    messageSpan.textContent = 'Procesando emails CX...';

    fetch('/events/api/process-cx-emails/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageSpan.textContent = `¡Procesamiento completado! ${data.processed_count} emails procesados.`;
            statusDiv.classList.add('text-success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            messageSpan.textContent = `Error: ${data.error}`;
            statusDiv.classList.add('text-danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageSpan.textContent = 'Error de conexión';
        statusDiv.classList.add('text-danger');
    })
    .finally(() => {
        // Rehabilitar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot me-2"></i>Procesar Emails CX';
    });
}

// Manejar formulario de creación
document.getElementById('createInboxItemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/events/inbox/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal y recargar página
            const modal = bootstrap.Modal.getInstance(document.getElementById('createInboxItemModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error al crear el item: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al crear el item');
    });
});
</script>
{% endblock %}