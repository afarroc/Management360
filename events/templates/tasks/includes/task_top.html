<!-- Top Selling -->
<div class="col-12">
    <div class="card top-selling overflow-auto">

        <div class="filter">
            <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                <li class="dropdown-header text-start">
                    <h6>Filter</h6>
                </li>

                <li><a class="dropdown-item" href="#">--</a></li>
                <li><a class="dropdown-item" href="#">-</a></li>
                <li><a class="dropdown-item" href="#">--</a></li>
            </ul>
        </div>

        <div class="card-body pb-0">
            <h5 class="card-title">Tasks <span>| Today</span></h5>

            <table class="table table-borderless datatable">
                <thead>
                    <tr>
                        <th scope="col">Title</th>
                        <th scope="col">Project</th>
                        <th scope="col">Event</th>
                        <th scope="col">Assigned To</th>
                        <th scope="col">Priority</th>
                        <th scope="col">Status</th>
                        <th scope="col">Duration</th>
                        <th scope="col">Progress</th>
                        <th scope="col">Created</th>
                        <th scope="col">Updated</th>
                        <th scope="col">Ticket</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in tasks_data %}
                    <tr>
                        <td class="fw-bold">
                            <a href="{% url 'task_panel_with_id' data.task.id %}">{{data.task.title|truncatechars:30}}</a>
                            {% if data.task.important %}
                            <i class="bi bi-star-fill text-warning ms-1" title="High Priority"></i>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.task.project %}
                            <a href="{% url 'project_panel_with_id' data.task.project.id %}">{{data.task.project.title|truncatechars:20}}</a>
                            <br><small class="text-muted">{{data.task.project.project_status.status_name}}</small>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.task.event %}
                            <a href="{% url 'event_panel_with_id' data.task.event.id %}">{{data.task.event.title|truncatechars:20}}</a>
                            <br><small class="text-muted">{{data.task.event.event_status.status_name}}</small>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.task.assigned_to %}
                            <span class="badge bg-info">{{data.task.assigned_to.username}}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.task.important %}
                            <span class="badge bg-warning text-dark">High</span>
                            {% else %}
                            <span class="badge bg-secondary">Normal</span>
                            {% endif %}
                        </td>
                        <td>
                            <span style="background-color: {{ data.task.task_status.color }};" class="badge text-white">
                                {% if data.task.task_status.icon %}
                                    <i class="{{ data.task.task_status.icon }}"></i>
                                {% endif %}
                                {{ data.task.task_status.status_name }}
                            </span>
                        </td>
                        <td>
                            {% load tz %}
                            {% if data.task.task_status.status_name == 'In Progress' %}
                                {% with data.active_state as active_state %}
                                    {% if active_state %}
                                        <small class="text-info">
                                            <i class="bi bi-clock"></i>
                                            {% timezone "America/Lima" %}
                                                {% with active_state.start_time|timesince as time_diff %}
                                                    {{ time_diff }}
                                                {% endwith %}
                                            {% endtimezone %}
                                        </small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                {% endwith %}
                            {% elif data.task.task_status.status_name == 'Completed' %}
                                {% with data.completed_state as completed_state %}
                                    {% if completed_state and completed_state.end_time %}
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i>
                                            {% with completed_state.start_time|timeuntil:completed_state.end_time as duration %}
                                                {{ duration }}
                                            {% endwith %}
                                        </small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.task.task_status.status_name == 'Completed' %}
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                </div>
                            {% elif data.task.task_status.status_name == 'In Progress' %}
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">50%</div>
                                </div>
                            {% else %}
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            {% endif %}
                        </td>
                        <td><small class="text-muted">{{data.task.created_at|date:"M d, H:i"}}</small></td>
                        <td><small class="text-muted">{{data.task.updated_at|date:"M d, H:i"}}</small></td>
                        <td><a href="{% url 'task_panel_with_id' data.task.id %}" class="fw-bold text-primary">${{data.task.ticket_price}}</a></td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input task-activate-switch"
                                       type="checkbox"
                                       role="switch"
                                       id="switch-{{data.task.id}}"
                                       data-task-id="{{data.task.id}}"
                                       {% if data.task.task_status.status_name == 'In Progress' %}checked{% endif %}
                                       {% if data.task.task_status.status_name == 'Completed' %}disabled{% endif %}>
                                <label class="form-check-label" for="switch-{{data.task.id}}"></label>
                            </div>
                        </td>
                    </tr>
                    {% endfor%}
                </tbody>
            </table>

        </div>

    </div>
</div><!-- End Top Selling -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle task activation switches
    document.querySelectorAll('.task-activate-switch').forEach(function(switchElement) {
        switchElement.addEventListener('change', function() {
            const taskId = this.getAttribute('data-task-id');
            const isChecked = this.checked;
            const switchElement = this;

            // Disable switch during request
            switchElement.disabled = true;

            // Prepare data for AJAX request
            const formData = new FormData();
            formData.append('task_id', taskId);
            formData.append('action', isChecked ? 'activate' : 'deactivate');

            // Send AJAX request
            fetch('{% url "task_change_status_ajax" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update status badge in the same row
                    const row = switchElement.closest('tr');
                    const statusCell = row.querySelector('td:nth-child(6) .badge'); // Status column

                    if (isChecked) {
                        statusCell.innerHTML = '<i class="bi bi-play-circle"></i> In Progress';
                        statusCell.style.backgroundColor = '#007bff'; // Blue for In Progress
                    } else {
                        statusCell.innerHTML = 'To Do';
                        statusCell.style.backgroundColor = '#6c757d'; // Gray for To Do
                    }

                    // Show success message
                    showToast('Task status updated successfully', 'success');
                } else {
                    // Revert switch state on error
                    switchElement.checked = !isChecked;
                    showToast(data.error || 'Error updating task status', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert switch state on error
                switchElement.checked = !isChecked;
                showToast('Network error. Please try again.', 'error');
            })
            .finally(() => {
                // Re-enable switch
                switchElement.disabled = false;
            });
        });
    });

    // Toast notification function
    function showToast(message, type) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        // Add to page
        const container = document.querySelector('.toast-container') || createToastContainer();
        container.appendChild(toast);

        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove after shown
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
});
</script>

<style>
/* Enhanced table styling for data analysis */
.table th {
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
    font-size: 0.875rem;
}

/* Status badges */
.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.5rem;
}

/* Priority indicators */
.bi-star-fill {
    font-size: 0.8rem;
}

/* Switch styling */
.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.form-check-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Responsive table */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.8rem;
    }

    .table td, .table th {
        padding: 0.5rem 0.25rem;
    }

    /* Hide less critical columns on mobile */
    .table th:nth-child(9), .table td:nth-child(9), /* Created */
    .table th:nth-child(10), .table td:nth-child(10), /* Updated */
    .table th:nth-child(11), .table td:nth-child(11)  /* Ticket */ {
        display: none;
    }
}

/* Loading state for switches */
.form-check-input:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Enhanced row hover */
.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* Toast styling */
.toast {
    min-width: 300px;
}
</style>
