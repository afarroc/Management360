<!-- Kanban Task Card -->
<div class="card mb-2 task-card" data-task-id="{{ task.id }}" draggable="true">
    <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-1 fw-bold">{{ task.title }}</h6>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'task_panel' task.id %}">
                        <i class="bi bi-eye me-2"></i>View Details</a></li>
                    <li><a class="dropdown-item" href="{% url 'task_edit' task.id %}">
                        <i class="bi bi-pencil me-2"></i>Edit</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete({{ task.id }}, '{{ task.title }}')">
                        <i class="bi bi-trash me-2"></i>Delete</a></li>
                </ul>
            </div>
        </div>

        {% if task.description %}
        <p class="card-text small text-muted mb-2">{{ task.description|truncatechars:80 }}</p>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge" style="background-color: {{ task.task_status.color }};">
                {% if task.task_status.icon %}
                    <i class="{{ task.task_status.icon }}"></i>
                {% endif %}
                {{ task.task_status.status_name }}
            </span>
            {% if task.important %}
            <i class="bi bi-star-fill text-warning" title="High Priority"></i>
            {% endif %}
        </div>

        {% if task.project %}
        <div class="mb-2">
            <small class="text-muted">
                <i class="bi bi-diagram-3 me-1"></i>
                <a href="{% url 'project_panel' task.project.id %}" class="text-decoration-none">
                    {{ task.project.title }}
                </a>
            </small>
        </div>
        {% endif %}

        {% if task.event %}
        <div class="mb-2">
            <small class="text-muted">
                <i class="bi bi-calendar-event me-1"></i>
                <a href="{% url 'event_panel' task.event.id %}" class="text-decoration-none">
                    {{ task.event.title }}
                </a>
            </small>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                <i class="bi bi-person me-1"></i>
                {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
            </small>
            {% if task.ticket_price %}
            <small class="text-success fw-bold">
                <i class="bi bi-cash me-1"></i>
                ${{ task.ticket_price }}
            </small>
            {% endif %}
        </div>

        <div class="mt-2">
            <small class="text-muted">
                <i class="bi bi-clock me-1"></i>
                {{ task.created_at|date:"M d, H:i" }}
            </small>
        </div>
    </div>
</div>

<style>
.task-card {
    cursor: grab;
    transition: all 0.2s ease;
}

.task-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.task-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.task-card .card-title {
    font-size: 0.9rem;
    line-height: 1.3;
}

.task-card .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}
</style>

<script>
// Drag and Drop functionality for Kanban
document.addEventListener('DOMContentLoaded', function() {
    const taskCards = document.querySelectorAll('.task-card');
    const columns = document.querySelectorAll('[id$="Column"]');

    taskCards.forEach(card => {
        card.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.taskId);
        });

        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });

    columns.forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        column.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        column.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const taskId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.querySelector(`[data-task-id="${taskId}"]`);

            if (draggedCard) {
                this.appendChild(draggedCard);

                // Update task status based on column
                const newStatus = this.id.replace('Column', '').toLowerCase();
                updateTaskStatus(taskId, newStatus);
            }
        });
    });

    function updateTaskStatus(taskId, newStatus) {
        // Map column IDs to status names
        const statusMap = {
            'todo': 'To Do',
            'inprogress': 'In Progress',
            'completed': 'Completed',
            'blocked': 'Blocked'
        };

        const statusName = statusMap[newStatus];
        if (statusName) {
            // AJAX call to update task status
            fetch(`{% url "task_change_status_ajax" %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'task_id': taskId,
                    'new_status_name': statusName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showToast('Task status updated successfully!', 'success');
                } else {
                    showToast('Error updating task status', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error updating task status', 'error');
            });
        }
    }

    function showToast(message, type) {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
});
</script>