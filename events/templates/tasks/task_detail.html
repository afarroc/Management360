{% extends 'layouts/base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'assets/css/alerts-styles.css' %}">
{% block content %}

<!-- Mensajes de confirmación y éxito -->
{% if messages %}
<div class="alert alert-info" role="alert">
    {% for message in messages %}
    <p{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</p>
    {% endfor %}
</div>
{% endif %}

<div class="pagetitle">
    <h1>Detalle de Tarea</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'tasks' %}">Tareas</a></li>
            <li class="breadcrumb-item active">{{ task.title|truncatechars:30 }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ task.title }}</h5>
                    
                    <!-- Badges de estado y prioridad en header -->
                    <div class="mb-4">
                        <span class="badge bg-{{ task.task_status.color|default:'secondary' }} me-2">
                            {% if task.task_status.icon %}
                            <i class="{{ task.task_status.icon }} me-1"></i>
                            {% endif %}
                            {{ task.task_status.status_name }}
                        </span>
                        {% if task.important %}
                        <span class="badge bg-danger">
                            <i class="bi bi-star-fill me-1"></i> Alta Prioridad
                        </span>
                        {% endif %}
                        {% if task.done %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i> Completada
                        </span>
                        {% endif %}
                    </div>

                    <!-- Descripción -->
                    {% if task.description %}
                    <div class="mb-4">
                        <h6>Descripción:</h6>
                        <div class="border rounded p-3 bg-light">
                            {{ task.description|linebreaks }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Información en dos columnas -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle me-2"></i>Información General</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>Creado por:</strong><br>
                                    {{ task.host.get_full_name|default:task.host.username }}
                                </li>
                                <li class="mb-2">
                                    <strong>Asignado a:</strong><br>
                                    {% if task.assigned_to %}
                                    {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                    {% else %}
                                    <span class="text-muted">No asignado</span>
                                    {% endif %}
                                </li>
                                <li class="mb-2">
                                    <strong>Fecha creación:</strong><br>
                                    {{ task.created_at|date:"d/m/Y H:i" }}
                                </li>
                                <li class="mb-2">
                                    <strong>Última actualización:</strong><br>
                                    {{ task.updated_at|date:"d/m/Y H:i" }}
                                </li>
                            </ul>
                        </div>
                        
                        <div class="col-md-6">
                            <h6><i class="bi bi-link-45deg me-2"></i>Relaciones</h6>
                            <ul class="list-unstyled">
                                {% if task.project %}
                                <li class="mb-2">
                                    <strong>Proyecto:</strong><br>
                                    <a href="{% url 'projects_with_id' task.project.id %}" class="text-decoration-none">
                                        {{ task.project.title }}
                                    </a>
                                    <span class="badge bg-light text-dark ms-2">
                                        {{ task.project.project_status.status_name }}
                                    </span>
                                </li>
                                {% endif %}
                                
                                {% if task.event %}
                                <li class="mb-2">
                                    <strong>Evento:</strong><br>
                                    <a href="{% url 'event_detail' task.event.id %}" class="text-decoration-none">
                                        {{ task.event.title }}
                                    </a>
                                    <span class="badge bg-light text-dark ms-2">
                                        {{ task.event.event_status.status_name }}
                                    </span>
                                </li>
                                {% endif %}
                                
                                {% if task.ticket_price > 0 %}
                                <li class="mb-2">
                                    <strong>Precio del Ticket:</strong><br>
                                    <span class="text-success fw-bold">${{ task.ticket_price }}</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    <!-- Sección de alertas -->
                    {% if alerts %}
                    <div class="mt-4">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Alertas</h6>
                        {% for alert in alerts %}
                        <div class="alert alert-{{ alert.type }} d-flex align-items-center">
                            <i class="bi {{ alert.icon }} me-3 fs-4"></i>
                            <div class="flex-grow-1">
                                <strong>{{ alert.title }}</strong><br>
                                {{ alert.message }}
                            </div>
                            {% if alert.action_url %}
                            <a href="{{ alert.action_url }}" class="btn btn-outline-{{ alert.type }} btn-sm ms-3">
                                {{ alert.action_text }}
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Footer con acciones -->
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between">
                        <div class="btn-group">
                            <a href="{% url 'task_edit' task.id %}" class="btn btn-primary">
                                <i class="bi bi-pencil me-1"></i> Editar
                            </a>
                            <a href="{% url 'tasks' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Volver a la lista
                            </a>
                        </div>
                        <div class="btn-group">
                            {% if task.project %}
                            <a href="{% url 'kanban_project' task.project.id %}" class="btn btn-info">
                                <i class="bi bi-kanban me-1"></i> Ver Kanban
                            </a>
                            {% endif %}
                            <a href="{% url 'task_dependency_graph' task.id %}" class="btn btn-secondary">
                                <i class="bi bi-diagram-3 me-1"></i> Dependencias
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel lateral derecho -->
        <div class="col-lg-4">
            <!-- Cambiar estado -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="bi bi-arrow-repeat me-2"></i>Cambiar Estado</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for status in task_statuses %}
                        <button type="button" 
                                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                onclick="changeTaskStatus({{ task.id }}, {{ status.id }}, '{{ status.status_name|escapejs }}')">
                            <div>
                                <span class="badge me-2" style="background-color: {{ status.color|default:'#6c757d' }};">&nbsp;</span>
                                {{ status.status_name }}
                            </div>
                            {% if task.task_status.id == status.id %}
                            <i class="bi bi-check text-success"></i>
                            {% else %}
                            <small class="text-muted">Cambiar</small>
                            {% endif %}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Información del sistema -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-gear me-2"></i>Información Técnica</h6>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">ID de Tarea:</dt>
                        <dd class="col-sm-6">{{ task.id }}</dd>
                        
                        <dt class="col-sm-6">URL API:</dt>
                        <dd class="col-sm-6">
                            <small><code>/events/tasks/{{ task.id }}/</code></small>
                        </dd>
                        
                        <dt class="col-sm-6">Modelo:</dt>
                        <dd class="col-sm-6">Task</dd>
                        
                        <dt class="col-sm-6">Propietario:</dt>
                        <dd class="col-sm-6">{{ task.host.username }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Acciones rápidas -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="bi bi-lightning me-2"></i>Acciones Rápidas</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success" onclick="markTaskCompleted({{ task.id }})">
                            <i class="bi bi-check-circle me-1"></i> Marcar como Completada
                        </button>
                        <button class="btn btn-outline-warning" onclick="markTaskInProgress({{ task.id }})">
                            <i class="bi bi-arrow-repeat me-1"></i> Poner en Progreso
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTask({{ task.id }}, '{{ task.title|escapejs }}')">
                            <i class="bi bi-trash me-1"></i> Eliminar Tarea
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Scripts para funcionalidades -->
<script>
// Cambiar estado de la tarea
function changeTaskStatus(taskId, statusId, statusName) {
    if (confirm(`¿Cambiar estado a "${statusName}"?`)) {
        fetch(`/events/change_task_status/${taskId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `new_status_id=${statusId}`
        })
        .then(response => response.text())
        .then(data => {
            alert('Estado actualizado exitosamente');
            location.reload();
        })
        .catch(error => {
            alert('Error al actualizar el estado: ' + error);
        });
    }
}

// Marcar como completada
function markTaskCompleted(taskId) {
    if (confirm('¿Marcar esta tarea como completada?\n\nEsto actualizará el estado y los créditos.')) {
        fetch(`/events/tasks/${taskId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'new_status=Completed'
        })
        .then(response => response.text())
        .then(data => {
            alert('Tarea marcada como completada');
            location.reload();
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

// Marcar en progreso
function markTaskInProgress(taskId) {
    if (confirm('¿Poner esta tarea en progreso?')) {
        fetch(`/events/tasks/${taskId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'new_status=In Progress'
        })
        .then(response => response.text())
        .then(data => {
            alert('Tarea puesta en progreso');
            location.reload();
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

// Eliminar tarea
function deleteTask(taskId, taskTitle) {
    if (confirm(`¿Estás seguro de eliminar la tarea "${taskTitle}"?\n\nEsta acción no se puede deshacer.`)) {
        fetch(`/events/tasks/${taskId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.text())
        .then(data => {
            alert('Tarea eliminada exitosamente');
            window.location.href = "{% url 'tasks' %}";
        })
        .catch(error => {
            alert('Error al eliminar: ' + error);
        });
    }
}
</script>

{% endblock %}