{% extends 'layouts/base.html' %}
{% load static %}

<!-- Load global panel styles -->
<link rel="stylesheet" href="{% static 'assets/css/panel-styles.css' %}">

<style>
/* Enhanced Alert Styles */
.alerts-container {
    margin-bottom: 1.5rem;
}

.alerts-container .alert {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.alerts-container .alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.alerts-container .alert .alert-message {
    margin-top: 0.25rem;
    font-size: 0.9rem;
    opacity: 0.9;
}

.alerts-container .alert .btn-outline-success {
    border-color: #198754;
    color: #198754;
}

.alerts-container .alert .btn-outline-success:hover {
    background-color: #198754;
    border-color: #198754;
}

.alerts-container .alert .btn-outline-warning {
    border-color: #fd7e14;
    color: #fd7e14;
}

.alerts-container .alert .btn-outline-warning:hover {
    background-color: #fd7e14;
    border-color: #fd7e14;
}

.alerts-container .alert .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
}

.alerts-container .alert .btn-outline-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
}

.alerts-container .alert .btn-outline-info {
    border-color: #0dcaf0;
    color: #0dcaf0;
}

.alerts-container .alert .btn-outline-info:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
}

/* Alert animation */
@keyframes slideInFromTop {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.alerts-container .alert {
    animation: slideInFromTop 0.5s ease-out;
}

/* Stagger animation for multiple alerts */
.alerts-container .alert:nth-child(1) { animation-delay: 0.1s; }
.alerts-container .alert:nth-child(2) { animation-delay: 0.2s; }
.alerts-container .alert:nth-child(3) { animation-delay: 0.3s; }
.alerts-container .alert:nth-child(4) { animation-delay: 0.4s; }
.alerts-container .alert:nth-child(5) { animation-delay: 0.5s; }

/* Alert counter badge */
.alert-counter {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: 2px solid white;
    z-index: 10;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Ensure alerts container has relative positioning for counter */
.alerts-container {
    position: relative;
    min-height: 40px;
}

/* Loading spinner animation */
.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Toast notifications */
.toast-container {
    z-index: 9999;
}

.toast {
    min-width: 300px;
}

/* Alert priority indicators */
.alert-danger {
    border-left: 4px solid #dc3545 !important;
}

.alert-warning {
    border-left: 4px solid #fd7e14 !important;
}

.alert-success {
    border-left: 4px solid #198754 !important;
}

.alert-info {
    border-left: 4px solid #0dcaf0 !important;
}

/* Alert hover effects */
.alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}

/* Alert action buttons */
.alert .btn {
    transition: all 0.2s ease;
}

.alert .btn:hover {
    transform: scale(1.05);
}

/* Responsive alerts */
@media (max-width: 768px) {
    .alerts-container .alert {
        flex-direction: column;
        text-align: center;
    }

    .alerts-container .alert .btn {
        margin-top: 0.5rem;
        width: 100%;
    }

    .alerts-container .alert .btn-close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
    }
}
</style>

{% block content %}

<!-- Page Title -->
<div class="pagetitle">
    <h1><i class="bi bi-folder-fill me-2"></i>{{title}}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}"><i class="bi bi-house-door"></i></a></li>
            <li class="breadcrumb-item"><a href="{% url 'projects' %}">Projects</a></li>
            <li class="breadcrumb-item active">{{title}}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section dashboard">
    <!-- Alertas del Sistema -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Sistema de Alertas</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshAlerts()" id="refreshAlertsBtn">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAlerts()">
                        <i class="bi bi-eye-slash me-1"></i>Ocultar
                    </button>
                </div>
            </div>
            <div class="alerts-container" id="alertsContainer">
                {% if alerts %}
                    {% for alert in alerts %}
                    <div class="alert alert-{{ alert.type }} alert-dismissible fade show d-flex align-items-center" role="alert" data-alert-id="{{ forloop.counter }}">
                        <i class="bi {{ alert.icon }} me-2 fs-5"></i>
                        <div class="flex-grow-1">
                            <strong>{{ alert.title }}</strong>
                            <div class="alert-message">{{ alert.message }}</div>
                        </div>
                        {% if alert.action_url %}
                        <a href="{{ alert.action_url }}" class="btn btn-sm btn-outline-{{ alert.type }} ms-2" onclick="markAlertAsRead(this)">
                            {{ alert.action_text }}
                        </a>
                        {% endif %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="dismissAlert(this)"></button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Â¡Todo en orden!</strong> No hay alertas activas en este momento.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left side columns -->
        <div class="col-lg-8">
            <div class="row">

                {% if projects %}
        <!-- Statistics Cards -->
        <div class="col-12">
            <div class="row">
                <!-- Total Projects -->
                <div class="col-xxl-3 col-md-6">
                    <div class="card info-card sales-card">
                        <div class="card-body">
                            <h5 class="card-title">Total <span>| Projects</span></h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-folder-fill"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ total_projects }}</h6>
                                    <span class="text-success small pt-1 fw-bold">Active Projects</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- In Progress -->
                <div class="col-xxl-3 col-md-6">
                    <div class="card info-card revenue-card">
                        <div class="card-body">
                            <h5 class="card-title">In Progress <span>| Active</span></h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-play-circle-fill"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ in_progress_count }}</h6>
                                    <span class="text-warning small pt-1 fw-bold">Working On</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Completed -->
                <div class="col-xxl-3 col-md-6">
                    <div class="card info-card customers-card">
                        <div class="card-body">
                            <h5 class="card-title">Completed <span>| Done</span></h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ completed_count }}</h6>
                                    <span class="text-success small pt-1 fw-bold">Finished</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Tasks -->
                <div class="col-xxl-3 col-md-6">
                    <div class="card info-card">
                        <div class="card-body">
                            <h5 class="card-title">Total Tasks <span>| Assigned</span></h5>
                            <div class="d-flex align-items-center">
                                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-info-light">
                                    <i class="bi bi-list-check text-info"></i>
                                </div>
                                <div class="ps-3">
                                    <h6>{{ total_tasks }}</h6>
                                    <span class="text-info small pt-1 fw-bold">Task Items</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>




                {% include 'projects/control/control.html' %}
                {% include 'projects/includes/project_top.html' %}
                {% else %}
                {% endif %}

                
                {% if project_data %}
                {% include 'projects/includes/project_card.html' %}
                {% include 'projects/includes/project_tasks.html' %}
                
                {% else %}
                {% endif %}

            </div>
        </div><!-- End Left side columns -->
        <!-- Right side columns -->
        <div class="col-lg-4">

            <!-- CRUD Actions Panel -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-gear-fill me-2"></i>Project Management</h5>
                    <div class="d-flex flex-column gap-2">
                        <a href="{% url 'project_create' %}" class="btn btn-success btn-sm">
                            <i class="bi bi-plus-circle me-1"></i> Create Project
                        </a>
                        <a href="{% url 'project_edit' %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-pencil me-1"></i> Edit Projects
                        </a>
                        <a href="{% url 'projects' %}" class="btn btn-info btn-sm">
                            <i class="bi bi-eye me-1"></i> View Dashboard
                        </a>
                        <button type="button" class="btn btn-warning btn-sm" onclick="exportProjects()">
                            <i class="bi bi-download me-1"></i> Export
                        </button>
                    </div>

                    <hr class="my-3">

                    <div class="mb-2">
                        <label for="searchInput" class="form-label small fw-bold">Search Projects</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search..." onkeyup="searchProjects()">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>

                    <hr class="my-3">

                    <!-- Quick Actions & Filters -->
                    <div class="mb-3">
                        <h6 class="mb-2"><i class="bi bi-lightning me-1"></i>Bulk Actions</h6>
                        <div class="d-flex flex-column gap-1">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkAction('delete')" data-bs-toggle="tooltip" title="Delete selected projects">
                                <i class="bi bi-trash me-1"></i> Delete Selected
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkAction('activate')" data-bs-toggle="tooltip" title="Activate selected projects">
                                <i class="bi bi-play-circle me-1"></i> Activate
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="bulkAction('complete')" data-bs-toggle="tooltip" title="Mark as completed">
                                <i class="bi bi-check-circle me-1"></i> Complete
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Filter by Status:</span>
                            <span id="selectedCount" class="badge bg-primary">0 selected</span>
                        </div>
                        <select class="form-select form-select-sm" onchange="filterByStatus(this.value)">
                            <option value="all">All Status</option>
                            {% for status in project_statuses %}
                            <option value="{{ status.id }}">{{ status.status_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="refreshData()" data-bs-toggle="tooltip" title="Refresh data">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-activity me-2"></i>Recent Activity</h5>
                    <div class="activity">
                        {% for project_info in projects|slice:":5" %}
                        <div class="activity-item d-flex">
                            <div class="activite-label">
                                <span class="badge bg-{% if project_info.project.project_status.status_name == 'Completed' %}success{% elif project_info.project.project_status.status_name == 'In Progress' %}warning{% else %}secondary{% endif %}">{{ project_info.project.project_status.status_name|slice:":1" }}</span>
                            </div>
                            <div class="activity-content">
                                <strong>{{ project_info.project.title }}</strong>
                                <div class="text-muted small">
                                    {{ project_info.count_tasks }} tasks â¢ Updated {{ project_info.project.updated_at|timesince }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div><!-- End Right side columns -->
        <!-- Summary Section -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart-line me-2"></i>Performance Summary</h5>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-primary mb-1">{{ total_projects }}</h4>
                                <p class="text-muted small mb-0">Total Projects</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-warning mb-1">{{ in_progress_count }}</h4>
                                <p class="text-muted small mb-0">In Progress</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-success mb-1">{{ completed_count }}</h4>
                                <p class="text-muted small mb-0">Completed</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-info mb-1">{{ total_tasks }}</h4>
                            <p class="text-muted small mb-0">Total Tasks</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

// Load global panel scripts
<script src="{% static 'assets/js/panel-scripts.js' %}"></script>
<script src="{% static 'assets/js/project-panel.js' %}"></script>

<script>
// Enhanced Alert System
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for DOM to be fully ready
    setTimeout(function() {
        // Initialize alerts
        initializeAlerts();

        // Verify alerts are properly displayed
        verifyAlertsDisplay();

        // Auto-dismiss alerts after 15 seconds for non-critical ones
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert:not(.alert-danger):not(.alert-warning):not(.alert-dismissed)');
            alerts.forEach(function(alert) {
                if (!alert.classList.contains('alert-dismissed')) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            });
        }, 15000);
    }, 100);
});

function verifyAlertsDisplay() {
    const alertsContainer = document.getElementById('alertsContainer');
    const alerts = alertsContainer.querySelectorAll('.alert');
    const counterBadge = alertsContainer.querySelector('.alert-counter');

    console.log(`Verification: Found ${alerts.length} alerts in container`);

    if (alerts.length > 0 && !counterBadge) {
        // Add counter if missing
        const newCounter = document.createElement('div');
        newCounter.className = 'alert-counter';
        newCounter.textContent = alerts.length > 9 ? '9+' : alerts.length;
        newCounter.title = `${alerts.length} alerta(s) activa(s)`;
        alertsContainer.appendChild(newCounter);
        console.log('Added missing counter badge');
    } else if (alerts.length === 0 && counterBadge) {
        // Remove counter if no alerts
        counterBadge.remove();
        console.log('Removed unnecessary counter badge');
    }
}

function initializeAlerts() {
    const alertsContainer = document.getElementById('alertsContainer');
    const alerts = alertsContainer.querySelectorAll('.alert');
    const alertCount = alerts.length;

    // Remove existing counter if present
    const existingCounter = alertsContainer.querySelector('.alert-counter');
    if (existingCounter) {
        existingCounter.remove();
    }

    // Add counter badge if there are alerts
    if (alertCount > 0) {
        const counterBadge = document.createElement('div');
        counterBadge.className = 'alert-counter';
        counterBadge.textContent = alertCount > 9 ? '9+' : alertCount;
        counterBadge.title = `${alertCount} alerta(s) activa(s)`;
        alertsContainer.appendChild(counterBadge);

        // Update counter when alerts are dismissed
        document.addEventListener('alertDismissed', function() {
            const remainingAlerts = alertsContainer.querySelectorAll('.alert:not(.alert-dismissed)');
            if (remainingAlerts.length === 0) {
                counterBadge.remove();
            } else {
                counterBadge.textContent = remainingAlerts.length > 9 ? '9+' : remainingAlerts.length;
                counterBadge.title = `${remainingAlerts.length} alerta(s) activa(s)`;
            }
        });
    }

    // Add priority indicators and ensure proper structure
    alerts.forEach(function(alert, index) {
        // Ensure alert has proper structure
        if (!alert.hasAttribute('role')) {
            alert.setAttribute('role', 'alert');
        }

        // Add priority border indicators
        if (alert.classList.contains('alert-danger')) {
            alert.style.borderLeft = '4px solid #dc3545';
        } else if (alert.classList.contains('alert-warning')) {
            alert.style.borderLeft = '4px solid #fd7e14';
        } else if (alert.classList.contains('alert-success')) {
            alert.style.borderLeft = '4px solid #198754';
        } else if (alert.classList.contains('alert-info')) {
            alert.style.borderLeft = '4px solid #0dcaf0';
        }

        // Add data attribute for tracking
        alert.setAttribute('data-alert-index', index + 1);
    });

    // Log initialization for debugging
    console.log(`Initialized ${alertCount} alerts`);
}

function markAlertAsRead(element) {
    const alert = element.closest('.alert');
    alert.classList.add('alert-read');

    // Visual feedback
    element.innerHTML = '<i class="bi bi-check2 me-1"></i>Marcado como leÃ­do';
    element.classList.remove('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger', 'btn-outline-info');
    element.classList.add('btn-success');

    // Here you could send an AJAX request to mark the alert as read on the server
    console.log('Alert marked as read');
}

function dismissAlert(button) {
    const alert = button.closest('.alert');
    const alertsContainer = document.getElementById('alertsContainer');

    // Add dismissed class for animation
    alert.classList.add('alert-dismissed');

    // Use Bootstrap's alert dismissal
    const bsAlert = new bootstrap.Alert(alert);
    bsAlert.close();

    // Dispatch custom event for counter update
    const event = new CustomEvent('alertDismissed');
    document.dispatchEvent(event);

    // Update counter immediately
    setTimeout(() => {
        const remainingAlerts = alertsContainer.querySelectorAll('.alert:not(.alert-dismissed)');
        const counterBadge = alertsContainer.querySelector('.alert-counter');

        if (remainingAlerts.length === 0) {
            if (counterBadge) {
                counterBadge.remove();
            }
            // Show "no alerts" message if all alerts are dismissed
            if (alertsContainer.children.length === 0) {
                const noAlertsDiv = document.createElement('div');
                noAlertsDiv.className = 'alert alert-info';
                noAlertsDiv.setAttribute('role', 'alert');
                noAlertsDiv.innerHTML = `
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Â¡Todo en orden!</strong> No hay alertas activas en este momento.
                `;
                alertsContainer.appendChild(noAlertsDiv);
            }
        } else if (counterBadge) {
            counterBadge.textContent = remainingAlerts.length > 9 ? '9+' : remainingAlerts.length;
            counterBadge.title = `${remainingAlerts.length} alerta(s) activa(s)`;
        }
    }, 150); // Wait for Bootstrap animation to complete

    console.log('Alert dismissed');
}

function toggleAlerts() {
    const container = document.getElementById('alertsContainer');
    const button = event.target;

    if (container.style.display === 'none') {
        container.style.display = 'block';
        button.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Ocultar';
    } else {
        container.style.display = 'none';
        button.innerHTML = '<i class="bi bi-eye me-1"></i>Mostrar';
    }
}

function refreshAlerts() {
    const refreshBtn = document.getElementById('refreshAlertsBtn');
    const originalText = refreshBtn.innerHTML;

    // Show loading state
    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinning me-1"></i>Actualizando...';
    refreshBtn.disabled = true;

    // Fetch new alerts via AJAX
    fetch('{% url "project_alerts_ajax" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateAlertsDisplay(data.alerts);
            showToast('Alertas actualizadas', 'success');
        } else {
            showToast('Error al actualizar alertas', 'error');
        }
    })
    .catch(error => {
        console.error('Error refreshing alerts:', error);
        showToast('Error de conexiÃ³n', 'error');
    })
    .finally(() => {
        // Restore original button state
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    });
}

function updateAlertsDisplay(alerts) {
    const container = document.getElementById('alertsContainer');

    // Clear existing content
    container.innerHTML = '';

    if (alerts.length === 0) {
        const noAlertsDiv = document.createElement('div');
        noAlertsDiv.className = 'alert alert-info';
        noAlertsDiv.setAttribute('role', 'alert');
        noAlertsDiv.innerHTML = `
            <i class="bi bi-info-circle me-2"></i>
            <strong>Â¡Todo en orden!</strong> No hay alertas activas en este momento.
        `;
        container.appendChild(noAlertsDiv);
        return;
    }

    // Create alert elements
    alerts.forEach((alertData, index) => {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${alertData.type} alert-dismissible fade show d-flex align-items-center`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.setAttribute('data-alert-id', index + 1);

        alertDiv.innerHTML = `
            <i class="bi ${alertData.icon} me-2 fs-5"></i>
            <div class="flex-grow-1">
                <strong>${alertData.title}</strong>
                <div class="alert-message">${alertData.message}</div>
            </div>
            ${alertData.action_url ? `<a href="${alertData.action_url}" class="btn btn-sm btn-outline-${alertData.type} ms-2" onclick="markAlertAsRead(this)">${alertData.action_text}</a>` : ''}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="dismissAlert(this)"></button>
        `;

        container.appendChild(alertDiv);
    });

    // Re-initialize alerts after update
    setTimeout(() => {
        initializeAlerts();
    }, 100);
}

function showToast(message, type) {
    // Create toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    // Add to toast container or create one
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    // Show and auto-hide toast
    const toast = toastContainer.lastElementChild;
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Alert refresh functionality
function refreshAlerts() {
    // This could be enhanced to fetch new alerts via AJAX
    location.reload();
}

// Auto-refresh alerts every 5 minutes
setInterval(function() {
    // Only refresh if page is visible
    if (!document.hidden) {
        // Could implement AJAX refresh here instead of full page reload
        console.log('Checking for new alerts...');
    }
}, 300000); // 5 minutes

// Alert sound notification (optional)
function playAlertSound() {
    // Create audio context for alert sounds
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
        console.log('Audio notification not supported');
    }
}

// Show alert summary in console for debugging
function logAlertSummary() {
    const alerts = document.querySelectorAll('.alerts-container .alert');
    const summary = {
        total: alerts.length,
        danger: document.querySelectorAll('.alert-danger').length,
        warning: document.querySelectorAll('.alert-warning').length,
        success: document.querySelectorAll('.alert-success').length,
        info: document.querySelectorAll('.alert-info').length
    };
    console.log('Alert Summary:', summary);
}

// Call on page load
logAlertSummary();

// Debug function for development (call from browser console)
window.debugAlerts = function() {
    const alertsContainer = document.getElementById('alertsContainer');
    const alerts = alertsContainer.querySelectorAll('.alert');
    const counterBadge = alertsContainer.querySelector('.alert-counter');

    console.group('ð Alert Debug Information');
    console.log('Container element:', alertsContainer);
    console.log('Number of alerts found:', alerts.length);
    console.log('Counter badge:', counterBadge);
    console.log('Counter text:', counterBadge ? counterBadge.textContent : 'No counter');

    alerts.forEach((alert, index) => {
        console.log(`Alert ${index + 1}:`, {
            classes: alert.className,
            content: alert.innerHTML.substring(0, 100) + '...',
            isDismissed: alert.classList.contains('alert-dismissed')
        });
    });

    console.groupEnd();
};

// Test function to simulate alerts (call from browser console)
window.testAlerts = function() {
    const testAlerts = [
        {
            type: 'danger',
            icon: 'bi-exclamation-triangle',
            title: 'Test Alert - Danger',
            message: 'This is a test danger alert',
            action_url: '#',
            action_text: 'Fix Issue'
        },
        {
            type: 'warning',
            icon: 'bi-exclamation-circle',
            title: 'Test Alert - Warning',
            message: 'This is a test warning alert',
            action_url: '#',
            action_text: 'Review'
        },
        {
            type: 'success',
            icon: 'bi-check-circle',
            title: 'Test Alert - Success',
            message: 'This is a test success alert',
            action_url: '#',
            action_text: 'Continue'
        }
    ];

    updateAlertsDisplay(testAlerts);
    showToast('Test alerts loaded', 'info');
};

// Reset alerts function (call from browser console)
window.resetAlerts = function() {
    const alertsContainer = document.getElementById('alertsContainer');
    alertsContainer.innerHTML = `
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Â¡Todo en orden!</strong> No hay alertas activas en este momento.
        </div>
    `;
    showToast('Alerts reset', 'success');
};

// Force refresh from server (call from browser console)
window.forceRefreshAlerts = function() {
    refreshAlerts();
};
</script>

{% endblock %}