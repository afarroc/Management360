{% load static %}
<!-- Panel flotante de chat para incluir en base.html -->
<!-- Botón flotante para restaurar chat -->
<button id="chat-restore-btn" style="display:none;position:fixed;bottom:20px;right:20px;z-index:10001;background:#007bff;color:#fff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:1.7rem;align-items:center;justify-content:center;cursor:pointer;">
    <i class="bi bi-chat-dots"></i>
</button>
<div id="chat-panel" class="docked" style="z-index:10000;background:#fff;box-shadow:0 4px 24px rgba(0,0,0,0.2);overflow:hidden;display:flex;flex-direction:column;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center chat-header" style="border-radius:1em 1em 0 0;cursor:pointer;">
        <span><i class="bi bi-chat-dots"></i> Chat
            <select id="chat-room-selector" class="form-select form-select-sm d-inline-block w-auto ms-2" style="font-size:0.95em;">
                <option value="" disabled selected>Selecciona una sala...</option>
            </select>
        </span>
        <div>
            <button id="go-chat-main-btn" class="btn btn-light btn-sm" title="Ir al chat principal" style="margin-right:5px;"><i class="bi bi-box-arrow-up-right"></i></button>
            <button id="toggle-dock-btn" class="btn btn-light btn-sm" title="Acoplar/desacoplar"><i class="bi bi-layout-sidebar-inset"></i></button>
            <button id="toggle-chat-panel" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&#8211;</button>
        </div>
    </div>
    <div id="chat-panel-body" class="chat-panel-body" style="flex:1;display:flex;flex-direction:column;min-height:0;height:100%;">
        <div id="chat-log" class="p-3" style="flex:1;min-height:0;height:100%;overflow-y:auto;background:#f8f9fa;">
            <div class="d-flex mb-2 justify-content-end">
                <div class="message-bubble px-3 py-2 outgoing text-white text-end" style="max-width: 75%; border-radius: 1.2em; background:#007bff;">
                    <div class="small fw-bold mb-1">You</div>
                    <div class="message-content">¡Bienvenido al chat!</div>
                    <div class="message-time small mt-1 text-muted">Ahora</div>
                </div>
            </div>
            <div id="typing-indicator" class="typing-indicator" style="display:none;">
                <span></span><span></span><span></span>
            </div>
        </div>
    </div>
    <div class="p-3 border-top bg-white d-flex flex-column gap-2 chat-info-containers" style="border-radius:0 0 1em 1em;">
        <div class="input-group flex-grow-1">
            <input id="chat-message-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off">
            <button id="chat-message-submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
        </div>
    </div>
</div>
<style>
    #chat-restore-btn {
        transition: opacity 0.2s;
    }
    #chat-panel.docked {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 320px;
        height: 340px;
        border-radius: 1em 1em 0 0;
        font-size: 0.92rem;
        max-width: 100vw;
        transition: all 0.3s;
    }
    #chat-panel.docked .chat-header {
        padding: 0.4em 0.7em;
        font-size: 1rem;
    }
    #chat-panel.docked .chat-panel-body {
        padding: 0.5em 0.3em;
        font-size: 0.98rem;
    }
    #chat-panel.docked .chat-info-containers {
        padding: 0.3em 0.2em;
        gap: 0.3em;
        font-size: 0.85rem;
    }
    #chat-panel.docked #chat-log {
        font-size: 1.05rem;
        padding: 0.5em 0.2em;
    }
    #chat-panel.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        border-radius: 0;
        max-width: 100vw;
        z-index: 10000;
        font-size: 1.1rem;
        transition: all 0.3s;
    }
    #chat-panel.fullscreen .chat-header {
        font-size: 1.2rem;
        padding: 1em 1.5em;
    }
    #chat-panel.fullscreen .chat-info-containers {
        display: block;
        font-size: 1rem;
        padding: 1em;
    }
    #chat-panel.fullscreen #chat-log {
        font-size: 1.1rem;
        padding: 1em;
    }
    #chat-panel.hidden {
        display: none !important;
    }
    @media (max-width: 600px) {
        #chat-panel.docked {
            width: 98vw;
            height: 340px;
            min-height: 60px;
            right: 1vw;
            bottom: 1vw;
            border-radius: 1em;
            font-size: 0.9rem;
        }
        #chat-panel.docked .chat-header {
            font-size: 0.95rem;
            padding: 0.2em 0.5em;
        }
        #chat-panel.docked .chat-panel-body,
        #chat-panel.docked .chat-info-containers {
            display: block;
        }
        #chat-panel.docked #toggle-chat-panel,
        #chat-panel.docked #toggle-dock-btn,
        #chat-panel.docked #toggle-fullscreen-btn {
            font-size: 1.1rem;
            padding: 0.1em 0.2em;
        }
    }
</style>
<script>
    function setPanelMode(mode) {
        const panel = document.getElementById('chat-panel');
        panel.classList.remove('fullscreen', 'docked');
        panel.classList.add(mode);
    }
    function isMobile() {
        return window.innerWidth <= 600;
    }
    document.addEventListener('DOMContentLoaded', async function() {
    const currentUserId = "{{ user_id|default:'' }}";
        const panel = document.getElementById('chat-panel');
        const toggleDockBtn = document.getElementById('toggle-dock-btn');
        const toggleChatPanelBtn = document.getElementById('toggle-chat-panel');
        const restoreBtn = document.getElementById('chat-restore-btn');
        const goChatMainBtn = document.getElementById('go-chat-main-btn');
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-message-input');
    const chatSubmit = document.getElementById('chat-message-submit');
    const roomSelector = document.getElementById('chat-room-selector');

        // Detecta si está en la página principal de chat
        function isChatMainPage() {
            return window.location.pathname.startsWith('/chat/room');
        }

        // Estado inicial del panel flotante
        let chatPanelState = localStorage.getItem('chatPanelState') || 'minimized';
        function applyPanelState(state) {
            if (isChatMainPage()) {
                setPanelMode('fullscreen');
                panel.classList.remove('hidden');
                restoreBtn.style.display = 'none';
            } else {
                setPanelMode('docked');
                if (state === 'minimized') {
                    panel.classList.add('hidden');
                    restoreBtn.style.display = 'flex';
                    restoreBtn.style.opacity = '1';
                } else {
                    panel.classList.remove('hidden');
                    restoreBtn.style.display = 'none';
                    restoreBtn.style.opacity = '0';
                }
            }
        }
        applyPanelState(chatPanelState);
        // Siempre mostrar funcionalidades completas en modo docked
        if (isMobile() && !isChatMainPage()) {
            setPanelMode('docked');
            document.querySelector('.chat-panel-body').style.display = 'flex';
            document.querySelector('.chat-info-containers').style.display = 'flex';
        }
        toggleDockBtn.addEventListener('click', function() {
            if (panel.classList.contains('docked')) {
                setPanelMode('fullscreen');
                localStorage.setItem('chatPanelState', 'maximized');
            } else {
                setPanelMode('docked');
                localStorage.setItem('chatPanelState', 'docked');
            }
        });
        toggleChatPanelBtn.addEventListener('click', function() {
            panel.classList.add('hidden');
            restoreBtn.style.display = 'flex';
            restoreBtn.style.opacity = '1';
            localStorage.setItem('chatPanelState', 'minimized');
        });
        restoreBtn.addEventListener('click', function() {
            panel.classList.remove('hidden');
            restoreBtn.style.display = 'none';
            restoreBtn.style.opacity = '0';
            // Si está en la página principal de chat, restaurar pantalla completa
            if (isChatMainPage()) {
                setPanelMode('fullscreen');
                localStorage.setItem('chatPanelState', 'maximized');
            } else {
                setPanelMode('docked');
                localStorage.setItem('chatPanelState', 'docked');
            }
        });
        window.addEventListener('resize', function() {
            if (isMobile() && !isChatMainPage()) {
                setPanelMode('docked');
                document.querySelector('.chat-panel-body').style.display = 'flex';
                document.querySelector('.chat-info-containers').style.display = 'flex';
            }
        });
        goChatMainBtn.addEventListener('click', function() {
            window.location.href = '/chat/room';
        });

        // --- Obtener sala por defecto según historial de último acceso ---
        async function getLastRoom() {
            try {
                const response = await fetch('/chat/api/chat/last-room/', { credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    return data.room_name || 'global';
                }
            } catch (e) {}
            return 'global';
        }

        let chatSocket = null;
        let reconnectTimeout = null;
        let intentionalClose = false;
    // let lastRoomId = null; // Eliminada declaración duplicada

        async function loadRoomsAndSelectLast() {
            let lastRoom = await getLastRoom();
            try {
                const response = await fetch('/chat/api/chat/room-list/', { credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    roomSelector.innerHTML = '<option value="" disabled>Selecciona una sala...</option>';
                    data.rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = room.name;
                        roomSelector.appendChild(option);
                    });
                    // Selecciona la sala por defecto si existe
                    roomSelector.value = lastRoom;
                    lastRoomId = lastRoom;
                }
            } catch (e) {}
        }

        await loadRoomsAndSelectLast();

        async function loadHistory(roomId) {
            chatLog.innerHTML = '';
            try {
                const response = await fetch(`/chat/api/chat/room-history/${roomId}/`, { credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data.history)) {
                        data.history.forEach(msg => {
                            const isCurrentUser = msg.user_id == currentUserId;
                            const msgHtml = `<div class="d-flex mb-2 justify-content-${isCurrentUser ? 'end' : 'start'}">
                                <div class="message-bubble px-3 py-2 ${isCurrentUser ? 'outgoing text-white text-end' : 'incoming text-dark text-start'}" style="max-width: 75%; border-radius: 1.2em; background:${isCurrentUser ? '#007bff' : '#f8f9fa'};">
                                    <div class="small fw-bold mb-1">${msg.display_name || 'Usuario'}</div>
                                    <div class="message-content">${msg.content}</div>
                                    <div class="message-time small mt-1 text-muted">${msg.timestamp ? msg.timestamp.substring(11,19) : ''}</div>
                                </div>
                            </div>`;
                            chatLog.insertAdjacentHTML('beforeend', msgHtml);
                        });
                        chatLog.scrollTop = chatLog.scrollHeight;
                    }
                }
            } catch (e) {}
        }

        let lastRoomId = null;
        async function connectSocketWithHistory(roomId) {
            if (roomId === lastRoomId) return; // No recargar si no cambió la sala
            lastRoomId = roomId;
            await loadHistory(roomId);
            if (chatSocket) {
                intentionalClose = true;
                chatSocket.close();
                intentionalClose = false;
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsPath = `${wsScheme}://${window.location.host}/ws/chat/${roomId}/`;
            chatSocket = new WebSocket(wsPath);
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if (data.message) {
                    const isCurrentUser = data.user_id == currentUserId;
                    const msgHtml = `<div class="d-flex mb-2 justify-content-${isCurrentUser ? 'end' : 'start'}">
                        <div class="message-bubble px-3 py-2 ${isCurrentUser ? 'outgoing text-white text-end' : 'incoming text-dark text-start'}" style="max-width: 75%; border-radius: 1.2em; background:${isCurrentUser ? '#007bff' : '#f8f9fa'};">
                            <div class="small fw-bold mb-1">${data.display_name || 'Usuario'}</div>
                            <div class="message-content">${data.message}</div>
                            <div class="message-time small mt-1 text-muted">${data.timestamp ? data.timestamp.substring(11,19) : ''}</div>
                        </div>
                    </div>`;
                    chatLog.insertAdjacentHTML('beforeend', msgHtml);
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
            };
            chatSocket.onclose = function(e) {
                // Solo reconectar si la sala sigue siendo la misma
                if (!intentionalClose && roomId === lastRoomId) {
                    reconnectTimeout = setTimeout(() => connectSocketWithHistory(roomId), 2000);
                }
            };
        }
        // Conectar al inicio
        connectSocketWithHistory(roomSelector.value);

        roomSelector.addEventListener('change', function() {
            connectSocketWithHistory(roomSelector.value);
        });
        chatSubmit.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({ 'message': message }));
                chatInput.value = '';
            }
        });
        chatInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                chatSubmit.click();
            }
        });
    });
</script>
