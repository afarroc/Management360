{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
<!-- Chat Panel -->
<!-- Botón flotante para restaurar chat -->
<button id="chat-restore-btn" style="display:none;position:fixed;bottom:20px;right:20px;z-index:10001;background:#007bff;color:#fff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:1.7rem;align-items:center;justify-content:center;cursor:pointer;">
    <i class="bi bi-chat-dots"></i>
</button>
<div id="chat-panel" style="background:#fff;box-shadow:0 4px 24px rgba(0,0,0,0.2);overflow:hidden;display:flex;flex-direction:column;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center chat-header" style="border-radius:1em 1em 0 0;cursor:pointer;">
        <span><i class="bi bi-chat-dots"></i> Chat Room #{{ room_name }}</span>
        <span class="badge bg-light text-primary">{{ current_user }}</span>
        <div>
            <button id="toggle-panel-mode-btn" class="btn btn-light btn-sm" title="Acoplar/desacoplar o pantalla completa" style="margin-right:5px;"><i class="bi bi-layout-sidebar-inset"></i></button>
            <button id="toggle-chat-panel" class="btn btn-light btn-sm" title="Minimizar a botón"><i class="bi bi-dash-circle"></i></button>
        </div>
    </div>
    <div id="chat-panel-body" class="chat-panel-body" style="flex:1;display:flex;flex-direction:column;min-height:0;height:100%;">
        <div id="chat-log" class="p-3" style="flex:1;min-height:0;height:100%;overflow-y:auto;background:#f8f9fa;">
                {% for msg in chat_history %}
                    <div class="d-flex mb-2 {% if msg.user_id|stringformat:'s' == user_id|stringformat:'s' %}justify-content-end{% else %}justify-content-start{% endif %}">
                        <div class="message-bubble px-3 py-2 {% if msg.user_id|stringformat:'s' == user_id|stringformat:'s' %}outgoing text-white text-end{% else %}incoming text-dark text-start{% endif %}" style="max-width: 75%; border-radius: 1.2em; background:{{ msg.color|default:'#f8f9fa' }};">
                            <div class="small fw-bold mb-1">{% if msg.user_id|stringformat:'s' == user_id|stringformat:'s' %}You{% else %}{{ msg.display_name }}{% endif %}</div>
                            <div class="message-content">{{ msg.content }}</div>
                            <div class="message-time small mt-1 text-muted">{{ msg.timestamp|date:"H:i:s d/m/Y" }}</div>
                        </div>
                    </div>
                {% endfor %}
                <div id="typing-indicator" class="typing-indicator" style="display:none;">
                    <span></span><span></span><span></span>
                </div>
            </div>
    </div>
    <div class="p-3 border-top bg-white d-flex flex-column gap-2 chat-info-containers" style="border-radius:0 0 1em 1em;">
                <div class="input-group flex-grow-1">
                    <input id="chat-message-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off">
                    <button id="chat-message-submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                </div>
                <form id="dummy-csrf-form" style="display:none;">{% csrf_token %}</form>
                <button id="clear-history-btn" class="btn btn-outline-danger" title="Borrar historial">
                    <i class="bi bi-trash"></i> Borrar historial
                </button>
                <div class="card mt-2">
<!-- Panel CSS -->
<style>
    #chat-restore-btn {
        transition: opacity 0.2s;
    }
    /* No floating/docked styles for maximized chat panel in main chat page */
    #chat-panel.docked .chat-header {
        padding: 0.4em 0.7em;
        font-size: 1rem;
    }
    #chat-panel.docked .chat-panel-body {
        padding: 0.5em 0.3em;
        font-size: 0.98rem;
    }
    #chat-panel.docked .chat-info-containers {
        padding: 0.3em 0.2em;
        gap: 0.3em;
        font-size: 0.85rem;
    }
    #chat-panel.docked .card, #chat-panel.docked .user-profile {
        display: none;
    }
    #chat-panel.docked #chat-log {
        font-size: 1.05rem;
        padding: 0.5em 0.2em;
    }
    #chat-panel.fullscreen {
        position: static;
        width: 100%;
        height: auto;
        border-radius: 1em;
        max-width: 100%;
        z-index: auto;
        font-size: 1.1rem;
        transition: all 0.3s;
    }
    #chat-panel.fullscreen .chat-header {
        font-size: 1.2rem;
        padding: 1em 1.5em;
    }
    #chat-panel.fullscreen .chat-info-containers {
        display: block;
        font-size: 1rem;
        padding: 1em;
    }
    #chat-panel.fullscreen .card, #chat-panel.fullscreen .user-profile {
        display: block;
    }
    #chat-panel.fullscreen #chat-log {
        font-size: 1.1rem;
        padding: 1em;
    }
    #chat-panel.hidden {
        display: none !important;
    }
    /* Responsive para móvil */
    @media (max-width: 600px) {
        #chat-panel.docked {
            width: 98vw;
            height: 60px;
            min-height: 60px;
            right: 1vw;
            bottom: 1vw;
            border-radius: 1em;
            font-size: 0.9rem;
        }
        #chat-panel.docked .chat-header {
            font-size: 0.95rem;
            padding: 0.2em 0.5em;
        }
        #chat-panel.docked .chat-panel-body,
        #chat-panel.docked .chat-info-containers {
            display: none;
        }
        #chat-panel.docked #toggle-chat-panel,
        #chat-panel.docked #toggle-dock-btn,
        #chat-panel.docked #toggle-fullscreen-btn {
            font-size: 1.1rem;
            padding: 0.1em 0.2em;
        }
    }
</style>
<!-- Panel JS -->
<script>
    function isChatMainPage() {
        // Detecta si está en la página principal de chat (ajusta la ruta si es necesario)
        return window.location.pathname.includes('/chat/room');
    }
    function setPanelMode(mode) {
        const panel = document.getElementById('chat-panel');
        panel.classList.remove('fullscreen', 'docked');
        panel.classList.add(mode);
    }
    function isMobile() {
        return window.innerWidth <= 600;
    }
    document.addEventListener('DOMContentLoaded', function() {
        const panel = document.getElementById('chat-panel');
    const togglePanelModeBtn = document.getElementById('toggle-panel-mode-btn');
        const toggleChatPanelBtn = document.getElementById('toggle-chat-panel');
        const restoreBtn = document.getElementById('chat-restore-btn');

        // Inicializa modo según página y dispositivo
        if (isChatMainPage()) {
            setPanelMode('fullscreen');
        } else {
            setPanelMode('docked');
        }
        // Responsive: si es móvil y no está en chat, minimiza
        if (!isChatMainPage() && isMobile()) {
            setPanelMode('docked');
        }

        // Botón acoplar/desacoplar
        togglePanelModeBtn.addEventListener('click', function() {
            if (panel.classList.contains('fullscreen')) {
                setPanelMode('docked');
            } else {
                setPanelMode('fullscreen');
            }
        });
        // Botón ocultar panel (minimizar)
        toggleChatPanelBtn.addEventListener('click', function() {
            panel.classList.add('hidden');
            restoreBtn.style.display = 'flex';
            restoreBtn.style.opacity = '1';
        });
        // Botón restaurar panel
        restoreBtn.addEventListener('click', function() {
            panel.classList.remove('hidden');
            restoreBtn.style.display = 'none';
            restoreBtn.style.opacity = '0';
        });

        // Minimizar automáticamente en móvil si cambia de app
        window.addEventListener('resize', function() {
            if (!isChatMainPage() && isMobile()) {
                setPanelMode('docked');
            }
        });
    });
</script>
                    <div class="card-body">
                        <h5 class="card-title">User Profile</h5>
                        <div class="user-profile mb-3">
                            <h6>{{ user_full_name }}</h6>
                            <p class="text-muted mb-1">{{ user_email }}</p>
                            <div class="small">
                                <i class="bi bi-person-badge"></i> ID: {{ user_id }}<br>
                                <i class="bi bi-clock"></i> Joined: {{ user_date_joined|date:"d/m/Y" }}<br>
                                {% if is_moderator %}<span class="badge bg-warning">Moderator</span>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-2">
                    <div class="card-body">
                        <h5 class="card-title">Connected Users <span id="connected-count" class="badge bg-primary">1</span></h5>
                        <div id="connected-users" class="list-group small">
                            <div class="list-group-item">{{ user_full_name }} <span class="badge bg-success">You</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                    {{ room_name|json_script:"room-name" }}
                    {{ user_id|json_script:"current-user" }}

                    <style>
                    .message-bubble.outgoing {
                        background: linear-gradient(45deg, #007bff, #0056b3) !important;
                        color: #fff !important;
                        border-radius: 1.2em 1.2em 0 1.2em !important;
                    }
                    .message-bubble.incoming {
                        background: #fff !important;
                        border: 1px solid #e9ecef !important;
                        border-radius: 1.2em 1.2em 1.2em 0 !important;
                    }
                    .typing-indicator span {
                        height: 8px;
                        width: 8px;
                        background: #007bff;
                        display: inline-block;
                        border-radius: 50%;
                        margin: 0 2px;
                        animation: bounce 1s infinite;
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-5px); }
                    }
                    </style>

<script>
// Docked chat panel toggle
const chatPanelBody = document.getElementById('chat-panel-body');
const toggleChatPanelBtn = document.getElementById('toggle-chat-panel');
let chatPanelMinimized = false;
toggleChatPanelBtn.onclick = function() {
    chatPanelMinimized = !chatPanelMinimized;
    chatPanelBody.style.display = chatPanelMinimized ? 'none' : 'flex';
    toggleChatPanelBtn.innerHTML = chatPanelMinimized ? '&#x25B2;' : '&#8211;';
};
const currentUser = String(JSON.parse(document.getElementById('current-user').textContent));
const roomName = String(JSON.parse(document.getElementById('room-name').textContent));
let chatSocket = null;
let reconnectAttempt = 0;
const maxReconnectAttempts = 5;
const maxReconnectDelay = 5000;
let reconnectTimeout = null;

function scrollToBottom() {
    const chatLog = document.getElementById('chat-log');
    chatLog.scrollTop = chatLog.scrollHeight;
}

const colorPalette = [
    '#007bff', '#28a745', '#dc3545', '#fd7e14', '#6610f2', '#20c997', '#6f42c1', '#e83e8c', '#17a2b8', '#ffc107', '#343a40'
];
function colorForUserId(userId) {
    let hash = 0;
    const str = String(userId);
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colorPalette[Math.abs(hash) % colorPalette.length];
}
function updateConnectedUsers(users) {
    const userList = document.getElementById('connected-users');
    userList.innerHTML = '';
    window.lastUsersList = users;
    users.forEach(function(user) {
        const isCurrentUser = String(user.id) === String(currentUser);
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `${user.display_name || user.username}${isCurrentUser ? ' <span class="badge bg-success">You</span>' : ''}`;
        userList.appendChild(item);
    });
    document.getElementById('connected-count').textContent = users.length;
}

function connect() {
    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
    }
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
    }
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsHost = window.location.host;
    const wsPath = `${wsScheme}://${wsHost}/ws/chat/${roomName}/`;
    try {
        chatSocket = new WebSocket(wsPath);
        chatSocket.onopen = function() {
            reconnectAttempt = 0;
        };
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'pong') return;
            if (data.type === 'users') {
                updateConnectedUsers(data.users);
                return;
            }
            if (data.error) {
                const errorHtml = `<div class='alert alert-danger p-2 mb-2'>${data.error}</div>`;
                document.getElementById('chat-log').insertAdjacentHTML('beforeend', errorHtml);
                scrollToBottom();
                return;
            }
            const isOutgoing = String(data.user_id) === String(currentUser);
            const color = colorForUserId(data.user_id);
            const messageHtml = `
                <div class="d-flex mb-2 ${isOutgoing ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="message-bubble px-3 py-2 ${isOutgoing ? 'outgoing text-white text-end' : 'incoming text-dark text-start'}" style="max-width: 75%; border-radius: 1.2em; background:${isOutgoing ? '#007bff' : color};">
                        <div class="small fw-bold mb-1">${isOutgoing ? 'You' : (data.display_name || 'User #' + data.user_id)}</div>
                        <div class="message-content">${formatMessage(data.message)}</div>
                        <div class="message-time small mt-1 text-muted">${data.timestamp ? new Date(data.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', hour12: true}) : ''}</div>
                    </div>
                </div>
            `;
            document.getElementById('chat-log').insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        };
        chatSocket.onclose = function(e) {
            if (reconnectAttempt < maxReconnectAttempts) {
                const timeout = Math.min(1000 * Math.pow(2, reconnectAttempt), maxReconnectDelay);
                reconnectAttempt++;
                reconnectTimeout = setTimeout(connect, timeout);
            }
        };
        chatSocket.onerror = function(e) {};
    } catch (error) {
        reconnectTimeout = setTimeout(connect, 1000);
    }
}

function formatMessage(message) {
    if (!message) return '';
    message = message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    message = message.replace(/:\)|:\(|:D|:P/gi, match => {
        const emojis = {':)': '😊', ':(': '😢', ':D': '😃', ':P': '😛'};
        return emojis[match] || match;
    });
    return message;
}

connect();
scrollToBottom();

document.getElementById('chat-message-input').focus();
document.getElementById('chat-message-input').onkeyup = function(e) {
    if (e.key === 'Enter') {
        document.getElementById('chat-message-submit').click();
    }
};

document.getElementById('chat-message-submit').onclick = function(e) {
    const messageInputDom = document.getElementById('chat-message-input');
    const message = messageInputDom.value.trim();
    if (!message) return;
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'message': message,
            'user_id': currentUser,
            'timestamp': new Date().toISOString()
        }));
        messageInputDom.value = '';
    }
};
// Borrar historial de chat
function getCSRFToken() {
    return document.querySelector('#dummy-csrf-form [name=csrfmiddlewaretoken]')?.value || '';
}
document.getElementById('clear-history-btn').onclick = function() {
    if (!confirm('¿Seguro que deseas borrar el historial de este chat?')) return;
    fetch(`/chat/clear_history/${roomName}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            // El historial se borrará por el evento WebSocket
        } else {
            alert(data.error || 'No se pudo borrar el historial.');
        }
    })
    .catch(() => alert('Error al borrar el historial.'));
};

// Escucha el evento de borrado de historial por WebSocket
function handleHistoryCleared() {
    document.getElementById('chat-log').innerHTML = '<div id="typing-indicator" class="typing-indicator" style="display:none;"><span></span><span></span><span></span></div>';
}

// Modifica el onmessage del WebSocket para manejar el evento
const originalOnMessage = chatSocket ? chatSocket.onmessage : null;
function customOnMessage(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'history_cleared') {
        handleHistoryCleared();
        return;
    }
    // ...resto de la lógica original...
    if (data.type === 'pong') return;
    if (data.type === 'users') {
        updateConnectedUsers(data.users);
        return;
    }
    const isOutgoing = String(data.user_id) === String(currentUser);
    const color = colorForUserId(data.user_id);
    const messageHtml = `
        <div class="d-flex mb-2 ${isOutgoing ? 'justify-content-end' : 'justify-content-start'}">
            <div class="message-bubble px-3 py-2 ${isOutgoing ? 'outgoing text-white text-end' : 'incoming text-dark text-start'}" style="max-width: 75%; border-radius: 1.2em; background:${isOutgoing ? '#007bff' : color};">
                <div class="small fw-bold mb-1">${isOutgoing ? 'You' : (data.display_name || 'User #' + data.user_id)}</div>
                <div class="message-content">${formatMessage(data.message)}</div>
                <div class="message-time small mt-1 text-muted">${data.timestamp ? new Date(data.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', hour12: true}) : ''}</div>
            </div>
        </div>
    `;
    document.getElementById('chat-log').insertAdjacentHTML('beforeend', messageHtml);
    scrollToBottom();
}

// Reemplaza el onmessage del WebSocket
function connect() {
    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
    }
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
    }
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsHost = window.location.host;
    const wsPath = `${wsScheme}://${wsHost}/ws/chat/${roomName}/`;
    try {
        chatSocket = new WebSocket(wsPath);
        chatSocket.onopen = function() {
            reconnectAttempt = 0;
        };
        chatSocket.onmessage = customOnMessage;
        chatSocket.onclose = function(e) {
            if (reconnectAttempt < maxReconnectAttempts) {
                const timeout = Math.min(1000 * Math.pow(2, reconnectAttempt), maxReconnectDelay);
                reconnectAttempt++;
                reconnectTimeout = setTimeout(connect, timeout);
            }
        };
        chatSocket.onerror = function(e) {};
    } catch (error) {
        reconnectTimeout = setTimeout(connect, 1000);
    }
}
</script>
{% endblock content %}