{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ title }} - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
    --light-bg: #f8fafc;
    --border-color: #e2e8f0;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.lesson-form-container {
    background: var(--light-bg);
    min-height: 100vh;
    padding: 2rem 0;
}

.form-card {
    background: white;
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    margin-bottom: 2rem;
    overflow: hidden;
    transition: all 0.3s ease;
}

.form-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.form-header {
    background: var(--primary-gradient);
    color: white;
    padding: 1.5rem 2rem;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.form-header i {
    font-size: 1.25rem;
    opacity: 0.9;
}

.form-header h4 {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
}

.form-body {
    padding: 2rem;
}

.form-section {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.form-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
}

.section-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
}

.section-icon.info { background: rgba(59, 130, 246, 0.1); color: var(--info-color); }
.section-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success-color); }
.section-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
.section-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }

.form-group {
    margin-bottom: 1.75rem;
    position: relative;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-label {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.625rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    letter-spacing: 0.025em;
}

.form-label .badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
}

.form-label .badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
}

.form-control, .form-select {
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 0.875rem 1.125rem;
    font-size: 0.875rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-gradient);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
    outline: none;
    transform: translateY(-2px);
    background: rgba(102, 126, 234, 0.02);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-gradient);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
    transform: translateY(-1px);
}

/* Date picker styling */
input[type="datetime-local"] {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
    padding-right: 2.5rem;
}

/* File upload styling */
.file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(248, 250, 252, 0.5);
    position: relative;
    overflow: hidden;
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--success-color);
    background: rgba(16, 185, 129, 0.1);
    transform: scale(1.02);
}

.file-upload-icon {
    font-size: 3rem;
    color: var(--border-color);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.file-upload-area:hover .file-upload-icon {
    color: var(--primary-color);
    transform: scale(1.1);
}

.file-upload-text {
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.file-upload-hint {
    font-size: 0.875rem;
    color: #9ca3af;
}

/* Custom checkbox styling */
.custom-checkbox {
    position: relative;
    display: inline-block;
}

.custom-checkbox input[type="checkbox"] {
    opacity: 0;
    position: absolute;
}

.custom-checkbox label {
    position: relative;
    padding-left: 2.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    color: #374151;
    transition: all 0.2s ease;
}

.custom-checkbox label:hover {
    color: #1f2937;
}

.custom-checkbox label:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1.375rem;
    height: 1.375rem;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    background: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.custom-checkbox input[type="checkbox"]:checked + label:before {
    background: var(--success-color);
    border-color: var(--success-color);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    transform: translateY(-50%) scale(1.05);
}

.custom-checkbox input[type="checkbox"]:checked + label:after {
    content: '✓';
    position: absolute;
    left: 0.3rem;
    top: 50%;
    transform: translateY(-50%);
    color: white;
    font-size: 0.875rem;
    font-weight: bold;
    animation: checkmark 0.3s ease;
}

@keyframes checkmark {
    0% {
        opacity: 0;
        transform: translateY(-50%) scale(0.8);
    }
    50% {
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
    }
    100% {
        opacity: 1;
        transform: translateY(-50%) scale(1);
    }
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-control.is-valid {
    border-color: var(--success-color);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.form-control.is-invalid {
    border-color: var(--danger-color);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.preview-panel {
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
}

.quiz-builder {
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    background: var(--light-bg);
}

.question-card {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    position: relative;
    transition: all 0.2s ease;
}

.question-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #667eea;
}

.question-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.question-number {
    background: var(--primary-gradient);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
}

.btn-remove {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    color: var(--danger-color);
    border-radius: 6px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.btn-remove:hover {
    background: var(--danger-color);
    color: white;
    transform: scale(1.05);
}

.btn-add-primary {
    background: var(--primary-gradient);
    border: none;
    border-radius: 12px;
    padding: 0.875rem 1.75rem;
    font-weight: 600;
    color: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    font-size: 0.875rem;
    letter-spacing: 0.025em;
}

.btn-add-primary:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
    transition: left 0.6s;
}

.btn-add-primary:hover:before {
    left: 100%;
}

.btn-add-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
}

.btn-add-primary:active {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
}

.btn-add-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
}

/* Loading state for buttons */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading:after {
    content: '';
    position: absolute;
    width: 1rem;
    height: 1rem;
    top: 50%;
    left: 50%;
    margin-left: -0.5rem;
    margin-top: -0.5rem;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.btn-save {
    background: var(--success-color);
    border: none;
    border-radius: 12px;
    padding: 0.875rem 2.5rem;
    font-weight: 600;
    color: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
    font-size: 0.875rem;
    letter-spacing: 0.025em;
    position: relative;
    overflow: hidden;
}

.btn-save:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s;
}

.btn-save:hover:before {
    left: 100%;
}

.btn-save:hover {
    background: #059669;
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
}

.btn-save:active {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
}

.progress-indicator {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    min-width: 250px;
    width: 100%;
    position: relative;
    top: auto;
    right: auto;
    z-index: auto;
    margin-bottom: 1rem;
}

.progress-bar {
    height: 8px;
    border-radius: 4px;
    background: #e2e8f0;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--primary-gradient);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.tooltip-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--info-color);
    color: white;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    cursor: help;
    margin-left: 0.25rem;
}

.content-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.content-type-indicator.video { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
.content-type-indicator.text { background: rgba(16, 185, 129, 0.1); color: #059669; }
.content-type-indicator.quiz { background: rgba(245, 158, 11, 0.1); color: #d97706; }
.content-type-indicator.assignment { background: rgba(59, 130, 246, 0.1); color: #2563eb; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Status indicators styling */
.status-indicators {
    flex-wrap: wrap;
}

/* Accessibility improvements */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Focus indicators for accessibility */
.form-control:focus,
.form-select:focus,
.section-nav-btn:focus,
.tooltip-icon:focus,
.custom-checkbox label:focus {
    outline: 3px solid var(--primary-color);
    outline-offset: 2px;
    box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.25);
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .form-control,
    .form-select,
    .section-nav-btn {
        border-width: 2px;
    }

    .status-item {
        border-width: 2px;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .form-card,
    .section-nav-btn,
    .form-control,
    .form-select {
        transition: none;
    }

    .fade-in {
        animation: none;
    }
}

/* Focus visible for better keyboard navigation */
.form-control:focus-visible,
.form-select:focus-visible,
.section-nav-btn:focus-visible {
    outline: 3px solid var(--primary-color);
    outline-offset: 2px;
}

/* Skip link for accessibility */
.skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: var(--primary-color);
    color: white;
    padding: 8px;
    text-decoration: none;
    border-radius: 4px;
    z-index: 1000;
    font-weight: 600;
}

.skip-link:focus {
    top: 6px;
}

/* Estilos adicionales para mejorar la apariencia del formulario */
.form-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
    backdrop-filter: blur(10px);
    border: 2px solid transparent;
    background-clip: padding-box;
    position: relative;
}

.form-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border-radius: 16px;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.form-section:hover::before {
    opacity: 1;
}

.form-section:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

/* Mejorar los inputs con efectos de foco más suaves */
.form-control:focus, .form-select:focus {
    border-color: var(--primary-gradient);
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 0 8px 24px rgba(102, 126, 234, 0.2);
    transform: translateY(-2px);
    background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(248, 250, 252, 0.8));
}

/* Efectos para los botones */
.btn-add-primary, .btn-save {
    position: relative;
    overflow: hidden;
}

.btn-add-primary::before, .btn-save::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.8s ease;
}

.btn-add-primary:hover::before, .btn-save:hover::before {
    left: 100%;
}

/* Mejorar las tarjetas de formulario */
.form-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.form-card:hover {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    transform: translateY(-4px);
}

/* Mejorar los indicadores de estado */
.status-item {
    backdrop-filter: blur(10px);
    border: 2px solid transparent;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
    background-clip: padding-box;
}

.status-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
    border-radius: 24px;
    z-index: -1;
}

.status-item.success::before {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.08));
}

.status-item.warning::before {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08));
}

.status-item.error::before {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
}

/* Mejorar los checkboxes */
.custom-checkbox label {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.custom-checkbox label:hover {
    transform: translateX(2px);
}

.custom-checkbox input[type="checkbox"]:checked + label:before {
    animation: checkPulse 0.6s ease;
}

@keyframes checkPulse {
    0% {
        transform: translateY(-50%) scale(1);
    }
    50% {
        transform: translateY(-50%) scale(1.2);
    }
    100% {
        transform: translateY(-50%) scale(1);
    }
}

/* Mejorar el área de carga de archivos */
.file-upload-area {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.6));
    border: 2px dashed rgba(102, 126, 234, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.file-upload-area:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
    border-color: var(--primary-gradient);
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(102, 126, 234, 0.2);
}

.file-upload-area.dragover {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
    border-color: var(--success-color);
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
}

/* Mejorar las tarjetas de preguntas del quiz */
.question-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    backdrop-filter: blur(10px);
    border: 2px solid rgba(226, 232, 240, 0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.question-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    border-color: rgba(102, 126, 234, 0.3);
}

/* Mejorar el panel de preview */
.preview-panel {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.6));
    backdrop-filter: blur(10px);
    border: 2px solid rgba(226, 232, 240, 0.6);
}

/* Mejorar la navegación por secciones */
.section-nav-btn {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.6));
    backdrop-filter: blur(10px);
    border: 2px solid rgba(226, 232, 240, 0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.section-nav-btn:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(102, 126, 234, 0.2);
}

.section-nav-btn.active {
    background: var(--primary-gradient);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

/* Mejorar el indicador de progreso */
.progress-indicator {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    backdrop-filter: blur(20px);
    border: 2px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

/* Mejorar el indicador de auto-guardado */
.auto-save-indicator {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    backdrop-filter: blur(20px);
    border: 2px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

/* Mejorar los shortcuts de teclado */
.keyboard-shortcuts {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    backdrop-filter: blur(20px);
    border: 2px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

/* Mejorar la navegación del formulario */
.form-navigation {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    backdrop-filter: blur(20px);
    border: 2px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

/* Animaciones de entrada mejoradas */
.fade-in {
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mejorar el contenedor principal */
.lesson-form-container {
    background: linear-gradient(135deg, rgba(248, 250, 252, 1), rgba(241, 245, 249, 0.8));
    min-height: 100vh;
    padding: 2rem 0;
    position: relative;
}

.lesson-form-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
        radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
    z-index: -1;
    pointer-events: none;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 1.125rem;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 24px;
    font-size: 0.875rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    font-weight: 500;
}

.status-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}

.status-item i {
    font-size: 1rem;
    opacity: 0.9;
}

.status-item.success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
    border-color: var(--success-color);
    color: var(--success-color);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
}

.status-item.warning {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
    border-color: var(--warning-color);
    color: var(--warning-color);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
}

.status-item.info {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
    border-color: var(--info-color);
    color: var(--info-color);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
}

.status-item.error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
    border-color: var(--danger-color);
    color: var(--danger-color);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
}

/* Section Navigation */
.section-navigation {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.section-nav-content {
    transition: all 0.3s ease;
}

.section-nav-btn {
    width: 100%;
    background: rgba(248, 250, 252, 0.5);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    text-align: left;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    text-decoration: none;
}

.section-nav-btn:hover {
    background: rgba(102, 126, 234, 0.05);
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.section-nav-btn.active {
    background: var(--primary-gradient);
    border-color: var(--primary-color);
    color: white;
}

.section-nav-btn.completed {
    background: rgba(16, 185, 129, 0.1);
    border-color: var(--success-color);
}

.section-nav-btn:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.section-nav-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.2);
    font-size: 1.1rem;
}

.section-nav-btn.active .section-nav-icon {
    background: rgba(255, 255, 255, 0.3);
}

.section-nav-text {
    flex: 1;
}

.section-nav-title {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.section-nav-status {
    font-size: 0.75rem;
    opacity: 0.8;
}

.section-nav-indicator {
    font-size: 0.8rem;
}

/* Form navigation */
.form-navigation {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    z-index: 100;
    display: none;
}

.form-nav-item {
    display: block;
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 8px;
    text-decoration: none;
    color: #6b7280;
    transition: all 0.2s ease;
    font-size: 0.875rem;
}

.form-nav-item:hover {
    background: rgba(102, 126, 234, 0.1);
    color: var(--primary-color);
}

.form-nav-item.active {
    background: var(--primary-gradient);
    color: white;
}

.form-nav-item i {
    width: 20px;
    text-align: center;
}

/* Keyboard shortcuts help */
.keyboard-shortcuts {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    z-index: 100;
    display: none;
    max-width: 300px;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
    font-size: 0.875rem;
}

.shortcut-key {
    background: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Auto-save indicator */
.auto-save-indicator {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    z-index: 1000;
    display: none;
    font-size: 0.875rem;
}

.auto-save-indicator.success {
    border-color: var(--success-color);
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.auto-save-indicator.error {
    border-color: var(--danger-color);
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
}

@media (max-width: 768px) {
    .lesson-form-container {
        padding: 1rem 0;
    }

    .form-body {
        padding: 1.5rem;
    }

    .form-card {
        margin-bottom: 1rem;
    }

    .progress-indicator {
        position: static;
        margin-bottom: 1rem;
    }

    .status-indicators {
        display: none;
    }

    .form-navigation,
    .keyboard-shortcuts {
        display: none !important;
    }
}
/* =========================
   UI Enhancements (UX Boost)
   ========================= */
:root {
    --card-radius: 16px;
    --section-radius: 12px;
}

/* Improve form header gradient and readability */
.form-header {
    background: linear-gradient(135deg, rgba(102,126,234,0.95) 0%, rgba(118,75,162,0.95) 100%);
    backdrop-filter: blur(6px);
}

/* Sharper input group appearance */
.input-group-text {
    border-radius: 10px 0 0 10px !important;
    border: 2px solid var(--border-color);
    background: #f8fafc;
    font-weight: 600;
}

/* Buttons polish */
.btn {
    border-radius: 10px;
}
.btn:hover {
    transform: translateY(-1px);
}
.btn:active {
    transform: translateY(0);
}
.btn-outline-secondary:hover,
.btn-outline-info:hover,
.btn-outline-primary:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

/* Cards refinement */
.form-card {
    border-radius: var(--card-radius);
    overflow: hidden;
}

/* Section polish */
.form-section {
    border-radius: var(--section-radius);
}

/* Sidebar spacing utilities */
.sidebar-stack > * + * {
    margin-top: 1rem;
}

/* Sticky Action Bar */
.sticky-action-bar {
    position: fixed;
    left: 0;
    right: 0;
    bottom: -120px;
    background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(248,250,252,0.98));
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -8px 24px rgba(0,0,0,0.08);
    padding: .65rem 0;
    z-index: 1050;
    transition: bottom .25s ease-in-out, opacity .2s ease-in-out;
    opacity: 0;
}
.sticky-action-bar.show {
    bottom: 0;
    opacity: 1;
}
.sticky-action-bar .container-fluid {
    max-width: 1140px;
}

/* Light button used in sticky bar for contrast */
.btn-outline-light {
    color: #1f2937;
    border-color: #e5e7eb;
    background: #fff;
}
.btn-outline-light:hover {
    background: #f3f4f6;
    color: #111827;
}

/* Progress indicator compact variant in sidebar */
.progress-indicator {
    border-radius: 12px;
}
.progress-indicator .badge {
    font-size: .75rem;
}

/* Better focus ring for interactive controls */
button:focus-visible, .btn:focus-visible, .form-select:focus-visible, .form-control:focus-visible {
    outline: 3px solid rgba(102,126,234,0.45);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(102,126,234,0.15);
}

/* Improve required asterisk visibility */
.badge.bg-danger {
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.15);
}
</style>
{% endblock %}

{% block content %}
<!-- Skip navigation link for accessibility -->
<a href="#main-content" class="skip-link">Saltar al contenido principal</a>

<div class="lesson-form-container">
    <div class="container-fluid" id="main-content">
        <!-- Enhanced Progress Indicator -->

        <!-- Enhanced Status Indicators with Accessibility -->
        <div class="status-indicators d-flex gap-2 mb-3" id="status-indicators" role="status" aria-live="polite" aria-label="Estado del formulario">
            <div class="status-item warning" id="course-status" role="status" aria-label="Estado del curso" tabindex="0">
                <i class="bi bi-journal-bookmark" aria-hidden="true"></i>
                <span>Curso no seleccionado</span>
                <div class="sr-only" id="course-status-description">Debe seleccionar un curso antes de continuar</div>
            </div>
            <div class="status-item info" id="module-status" role="status" aria-label="Estado del módulo" tabindex="0">
                <i class="bi bi-folder" aria-hidden="true"></i>
                <span>Módulo no seleccionado</span>
                <div class="sr-only" id="module-status-description">Seleccione un módulo del curso elegido</div>
            </div>
            <div class="status-item" id="content-status" role="status" aria-label="Estado del contenido" tabindex="0">
                <i class="bi bi-file-text" aria-hidden="true"></i>
                <span>Tipo de contenido no definido</span>
                <div class="sr-only" id="content-status-description">Elija el tipo de lección que desea crear</div>
            </div>
            <div class="status-item info" id="validation-status" role="status" aria-label="Estado de validación" tabindex="0">
                <i class="bi bi-check-circle" aria-hidden="true"></i>
                <span>Validando formulario...</span>
                <div class="sr-only" id="validation-status-description">El formulario se valida automáticamente</div>
            </div>
        </div>

        <!-- Section Navigation with Progress -->
        <div class="section-navigation mb-4" id="section-navigation" role="navigation" aria-label="Navegación por secciones del formulario">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-compass me-2" aria-hidden="true"></i>
                    Navegación del Formulario
                </h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-section-nav" aria-expanded="true" aria-controls="section-nav-content">
                    <i class="bi bi-chevron-up" aria-hidden="true"></i>
                    <span class="sr-only">Alternar navegación de secciones</span>
                </button>
            </div>
            <div id="section-nav-content" class="section-nav-content">
                <div class="row g-2">
                    <div class="col-md-3">
                        <button type="button" class="section-nav-btn active" data-section="basic-info" aria-current="step" role="tab">
                            <div class="section-nav-icon">
                                <i class="bi bi-info-circle" aria-hidden="true"></i>
                            </div>
                            <div class="section-nav-text">
                                <div class="section-nav-title">Información Básica</div>
                                <div class="section-nav-status">En progreso</div>
                            </div>
                            <div class="section-nav-indicator">
                                <i class="bi bi-check-circle-fill text-success" aria-hidden="true"></i>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="section-nav-btn" data-section="content-section" role="tab">
                            <div class="section-nav-icon">
                                <i class="bi bi-file-text" aria-hidden="true"></i>
                            </div>
                            <div class="section-nav-text">
                                <div class="section-nav-title">Contenido</div>
                                <div class="section-nav-status">Pendiente</div>
                            </div>
                            <div class="section-nav-indicator">
                                <span class="badge bg-secondary">2</span>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="section-nav-btn" data-section="quiz-section" role="tab">
                            <div class="section-nav-icon">
                                <i class="bi bi-question-circle" aria-hidden="true"></i>
                            </div>
                            <div class="section-nav-text">
                                <div class="section-nav-title">Quiz</div>
                                <div class="section-nav-status">Opcional</div>
                            </div>
                            <div class="section-nav-indicator">
                                <span class="badge bg-info">3</span>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="section-nav-btn" data-section="assignment-section" role="tab">
                            <div class="section-nav-icon">
                                <i class="bi bi-pencil-square" aria-hidden="true"></i>
                            </div>
                            <div class="section-nav-text">
                                <div class="section-nav-title">Tarea</div>
                                <div class="section-nav-status">Opcional</div>
                            </div>
                            <div class="section-nav-indicator">
                                <span class="badge bg-warning">4</span>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="section-progress mt-3">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" id="section-progress-bar"></div>
                    </div>
                    <small class="text-muted mt-1 d-block" id="section-progress-text">Sección 1 de 4 completada</small>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 fade-in">
            <div>
                <h1 class="h2 mb-2">
                    <i class="bi bi-journal-bookmark-fill me-3 text-primary"></i>{{ title }}
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="{% url 'courses:admin_dashboard' %}">
                                <i class="bi bi-house me-1"></i>Admin
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'courses:manage_lessons' %}">Lecciones</a>
                        </li>
                        <li class="breadcrumb-item active">{{ title }}</li>
                    </ol>
                </nav>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'courses:manage_lessons' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Volver
                </a>
                {% if lesson %}
                <a href="{% url 'courses:admin_lesson_detail' lesson.id %}" class="btn btn-outline-info">
                    <i class="bi bi-eye me-2"></i>Ver Detalles
                </a>
                {% endif %}
                <button type="button" class="btn btn-outline-primary" onclick="toggleNavigation()">
                    <i class="bi bi-compass me-2"></i>Navegación
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="showKeyboardShortcuts()">
                    <i class="bi bi-keyboard me-2"></i>Atajos
                </button>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="lesson-form">
            {% csrf_token %}

            <!-- Información Básica -->
            <div class="form-card fade-in">
                <div class="form-header">
                    <i class="bi bi-info-circle"></i>
                    <h4>Información Básica</h4>
                </div>
                <div class="form-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="form-group">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                     Título de la Lección
                                     <span class="badge bg-danger" role="status" aria-label="Campo requerido">
                                         <i class="bi bi-asterisk" aria-hidden="true"></i>
                                         Requerido
                                     </span>
                                     <span class="sr-only">Campo obligatorio</span>
                                 </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.title.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                                <label for="{{ form.lesson_type.id_for_label }}" class="form-label">
                                    Tipo de Lección
                                    <span class="badge bg-warning text-dark" role="status" aria-label="Campo importante">
                                        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                                        Importante
                                    </span>
                                    <i class="bi bi-question-circle tooltip-icon" title="Elige el formato de contenido de la lección" tabindex="0" role="button" aria-label="Ayuda sobre tipos de lección"></i>
                                </label>
                                {{ form.lesson_type }}
                                {% if form.lesson_type.errors %}
                                    <div class="invalid-feedback d-block" role="alert" aria-live="polite">
                                        {% for error in form.lesson_type.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div id="lesson-type-indicator" class="mt-2" role="status" aria-live="polite"></div>
                                <small class="form-text text-muted" id="lesson-type-help">
                                    Determina cómo se presentará el contenido a los estudiantes
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="course-select" class="form-label">
                                    Curso
                                    <span class="badge bg-danger" role="status" aria-label="Campo requerido">
                                        <i class="bi bi-asterisk" aria-hidden="true"></i>
                                        Requerido
                                    </span>
                                    <i class="bi bi-question-circle tooltip-icon" title="Selecciona el curso al que pertenece la lección" tabindex="0" role="button" aria-label="Ayuda sobre selección de curso"></i>
                                    <span class="sr-only">Campo obligatorio</span>
                                </label>
                                <select class="form-select" id="course-select" name="course" required
                                        aria-describedby="course-help course-error"
                                        aria-invalid="false"
                                        aria-required="true">
                                    <option value="">Seleccionar curso...</option>
                                    {% for course in courses %}
                                    <option value="{{ course.id }}" {% if selected_course == course.id|stringformat:"s" %}selected{% endif %}>
                                        {{ course.title }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted" id="course-help">
                                    El curso determina a qué estudiantes estará disponible la lección
                                </small>
                                <div class="invalid-feedback" id="course-error" role="alert" aria-live="polite">
                                    Debe seleccionar un curso válido
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_module" class="form-label">
                                    Módulo
                                    <span class="badge bg-danger" role="status" aria-label="Campo requerido">
                                        <i class="bi bi-asterisk" aria-hidden="true"></i>
                                        Requerido
                                    </span>
                                    <i class="bi bi-question-circle tooltip-icon" title="Selecciona el módulo dentro del curso" tabindex="0" role="button" aria-label="Ayuda sobre selección de módulo"></i>
                                    <span class="sr-only">Campo obligatorio</span>
                                </label>
                                {{ form.module }}
                                {% if form.module.errors %}
                                    <div class="invalid-feedback d-block" role="alert" aria-live="polite">
                                        {% for error in form.module.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted" id="module-help">
                                    Los módulos disponibles se filtrarán según el curso seleccionado
                                </small>
                                <div class="alert alert-info mt-2 d-none" id="module-loading" role="status" aria-live="polite">
                                    <i class="bi bi-arrow-repeat spinning me-2" aria-hidden="true"></i>
                                    Cargando módulos...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.order.id_for_label }}" class="form-label">
                                    Orden
                                    <i class="bi bi-question-circle tooltip-icon" title="Posición de la lección en el módulo"></i>
                                </label>
                                {{ form.order }}
                                {% if form.order.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.order.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.duration_minutes.id_for_label }}" class="form-label">
                                    Duración (minutos)
                                    <i class="bi bi-question-circle tooltip-icon" title="Tiempo estimado para completar la lección"></i>
                                </label>
                                {{ form.duration_minutes }}
                                {% if form.duration_minutes.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.duration_minutes.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">
                                    Estado de Publicación
                                    <i class="bi bi-question-circle tooltip-icon" title="Controla la visibilidad de la lección"></i>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="is-published-toggle">
                                        <label class="form-check-label" for="is-published-toggle">
                                            Publicada
                                        </label>
                                    </div>
                                    <small class="text-muted">Los estudiantes podrán ver esta lección</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-0">
                        {{ form.is_free }}
                        <label for="{{ form.is_free.id_for_label }}" class="form-check-label fw-semibold">
                            <i class="bi bi-eye me-2"></i>
                            Lección gratuita (preview para estudiantes)
                        </label>
                        <small class="form-text text-muted d-block mt-1">
                            Los estudiantes podrán ver esta lección sin estar inscritos en el curso
                        </small>
                    </div>
                </div>
            </div>

            <!-- Contenido de la Lección -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-card fade-in">
                        <div class="form-header">
                            <i class="bi bi-file-text"></i>
                            <h4>Contenido de la Lección</h4>
                        </div>
                        <div class="form-body">
                            <!-- Contenido de Texto -->
                            <div id="text-content" class="content-type-section">
                                <div class="form-section">
                                    <div class="section-header">
                                        <h5 class="section-title">
                                            <div class="section-icon success">
                                                <i class="bi bi-file-earmark-text"></i>
                                            </div>
                                            Contenido de Texto
                                        </h5>
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.content.id_for_label }}" class="form-label">
                                            Contenido
                                            <i class="bi bi-question-circle tooltip-icon" title="Escribe el contenido que verán los estudiantes"></i>
                                        </label>
                                        {{ form.content }}
                                        {% if form.content.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.content.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            Puedes usar formato Markdown básico para dar formato al texto
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Video URL -->
                            <div id="video-content" class="content-type-section" style="display: none;">
                                <div class="form-section">
                                    <div class="section-header">
                                        <h5 class="section-title">
                                            <div class="section-icon danger">
                                                <i class="bi bi-play-circle"></i>
                                            </div>
                                            Contenido de Video
                                        </h5>
                                    </div>
                                    <div class="form-group">
                                        <label for="{{ form.video_url.id_for_label }}" class="form-label">
                                            URL del Video
                                            <i class="bi bi-question-circle tooltip-icon" title="Pega la URL completa del video"></i>
                                        </label>
                                        {{ form.video_url }}
                                        {% if form.video_url.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.video_url.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="alert alert-info mt-2">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Soportado:</strong> YouTube, Vimeo, Dailymotion y otros servicios populares
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quiz Builder -->
                            <div id="quiz-content" class="content-type-section" style="display: none;">
                                <div class="form-section">
                                    <div class="section-header">
                                        <h5 class="section-title">
                                            <div class="section-icon warning">
                                                <i class="bi bi-question-circle"></i>
                                            </div>
                                            Constructor de Quiz
                                        </h5>
                                        <button type="button" class="btn btn-add-primary btn-sm" id="add-question-btn">
                                            <i class="bi bi-plus-circle me-1"></i>Agregar Pregunta
                                        </button>
                                    </div>

                                    <div class="alert alert-warning">
                                        <i class="bi bi-lightbulb me-2"></i>
                                        <strong>Consejo:</strong> Crea preguntas claras con 4 opciones. Solo una debe ser correcta.
                                    </div>

                                    <div id="quiz-builder">
                                        <div id="questions-container">
                                            <!-- Las preguntas se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>

                                    {{ form.quiz_questions }}
                                    {% if form.quiz_questions.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.quiz_questions.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Assignment -->
                            <div id="assignment-content" class="content-type-section" style="display: none;">
                                <div class="form-section">
                                    <div class="section-header">
                                        <h5 class="section-title">
                                            <div class="section-icon info">
                                                <i class="bi bi-pencil-square"></i>
                                            </div>
                                            Configuración de Tarea
                                        </h5>
                                    </div>

                                    <div class="form-group">
                                        <label for="{{ form.assignment_instructions.id_for_label }}" class="form-label">
                                            Instrucciones de la Tarea
                                            <i class="bi bi-question-circle tooltip-icon" title="Describe claramente qué deben hacer los estudiantes"></i>
                                        </label>
                                        {{ form.assignment_instructions }}
                                        {% if form.assignment_instructions.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.assignment_instructions.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.assignment_file.id_for_label }}" class="form-label">
                                                    Archivo de Ejemplo
                                                    <i class="bi bi-question-circle tooltip-icon" title="Sube un archivo de referencia para los estudiantes"></i>
                                                </label>
       
                                                <!-- Drag & Drop File Upload -->
                                                <div class="file-upload-area" id="file-upload-area">
                                                    <div class="file-upload-icon">
                                                        <i class="bi bi-cloud-upload"></i>
                                                    </div>
                                                    <div class="file-upload-text">
                                                        <strong>Arrastra y suelta tu archivo aquí</strong>
                                                    </div>
                                                    <div class="file-upload-hint">
                                                        o <span class="text-primary fw-semibold" style="cursor: pointer;" onclick="document.getElementById('{{ form.assignment_file.id_for_label }}').click()">haz clic para seleccionar</span>
                                                    </div>
                                                    <small class="form-text text-muted mt-2">
                                                        Formatos permitidos: PDF, DOCX, TXT (máx. 10MB)
                                                    </small>
                                                </div>
       
                                                {{ form.assignment_file }}
                                                {% if form.assignment_file.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.assignment_file.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
       
                                                <!-- File preview area -->
                                                <div id="file-preview" class="mt-3" style="display: none;">
                                                    <div class="alert alert-success d-flex align-items-center">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <div>
                                                            <strong id="file-name"></strong>
                                                            <div class="small text-muted" id="file-size"></div>
                                                        </div>
                                                        <button type="button" class="btn-close ms-auto" onclick="clearFile()"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.assignment_due_date.id_for_label }}" class="form-label">
                                                    Fecha Límite
                                                    <i class="bi bi-question-circle tooltip-icon" title="Fecha máxima para entregar la tarea"></i>
                                                </label>
                                                {{ form.assignment_due_date }}
                                                {% if form.assignment_due_date.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.assignment_due_date.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel lateral derecho -->
                <div class="col-lg-4">
                    <!-- Indicador de Progreso (movido aquí para mejor ubicación) -->
                    <div class="progress-indicator fade-in">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-semibold">Progreso del formulario</span>
                                <span class="badge bg-primary" id="progress-badge">0%</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted" id="fields-completed">0/0 campos completados</small>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleProgress()" title="Minimizar/Maximizar">
                                    <i class="bi bi-chevron-up" id="progress-toggle-icon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-details mt-2" id="progress-details" style="display: none;">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Completa todos los campos marcados como requeridos para guardar la lección
                            </small>
                        </div>
                    </div>

                    <!-- Panel de Preview -->
                    <div class="form-card fade-in" style="position: sticky; top: 20px;">
                        <div class="form-header">
                            <i class="bi bi-eye"></i>
                            <h4>Preview</h4>
                        </div>
                        <div class="form-body">
                            <div id="preview-panel" class="preview-panel">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-eye-slash fs-1 mb-3"></i>
                                    <p>La preview se actualizará automáticamente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="form-card fade-in">
                <div class="form-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <a href="{% url 'courses:manage_lessons' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                            <button type="button" class="btn btn-outline-info" onclick="resetForm()">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            {% if lesson %}
                            <button type="submit" class="btn btn-save">
                                <i class="bi bi-check-circle me-2"></i>Actualizar Lección
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-save">
                                <i class="bi bi-plus-circle me-2"></i>Crear Lección
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sticky Action Bar (quick save) -->
            <div class="sticky-action-bar d-none" id="sticky-action-bar" aria-live="polite">
                <div class="container-fluid d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-save2 me-1"></i>
                        <span class="small">Tienes cambios sin guardar</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-light btn-sm" id="discard-changes-btn">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Descartar
                        </button>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check-circle me-1"></i>Guardar cambios
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Form Navigation Sidebar -->
    <div class="form-navigation" id="form-navigation">
        <h6 class="mb-3">
            <i class="bi bi-compass me-2"></i>Navegación
        </h6>
        <a href="#basic-info" class="form-nav-item" data-section="basic-info">
            <i class="bi bi-info-circle"></i> Información Básica
        </a>
        <a href="#content-section" class="form-nav-item" data-section="content-section">
            <i class="bi bi-file-text"></i> Contenido
        </a>
        <a href="#quiz-section" class="form-nav-item" data-section="quiz-section">
            <i class="bi bi-question-circle"></i> Quiz
        </a>
        <a href="#assignment-section" class="form-nav-item" data-section="assignment-section">
            <i class="bi bi-pencil-square"></i> Tarea
        </a>
        <a href="#preview-section" class="form-nav-item" data-section="preview-section">
            <i class="bi bi-eye"></i> Preview
        </a>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="keyboard-shortcuts" id="keyboard-shortcuts">
        <h6 class="mb-3">
            <i class="bi bi-keyboard me-2"></i>Atajos de Teclado
        </h6>
        <div class="shortcut-item">
            <span>Guardar formulario</span>
            <span class="shortcut-key">Ctrl + S</span>
        </div>
        <div class="shortcut-item">
            <span>Limpiar formulario</span>
            <span class="shortcut-key">Ctrl + L</span>
        </div>
        <div class="shortcut-item">
            <span>Preview</span>
            <span class="shortcut-key">Ctrl + P</span>
        </div>
        <div class="shortcut-item">
            <span>Navegación</span>
            <span class="shortcut-key">Ctrl + N</span>
        </div>
        <div class="shortcut-item">
            <span>Ayuda</span>
            <span class="shortcut-key">F1</span>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="auto-save-indicator">
        <i class="bi bi-check-circle me-2"></i>
        <span id="auto-save-message">Guardado automáticamente</span>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos principales
    const lessonForm = document.getElementById('lesson-form');
    const lessonTypeSelect = document.getElementById('{{ form.lesson_type.id_for_label }}');
    const courseSelect = document.getElementById('course-select');
    const moduleSelect = document.getElementById('id_module'); // ID fijo definido en el formulario
    const contentSections = document.querySelectorAll('.content-type-section');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const previewPanel = document.getElementById('preview-panel');
    const lessonTypeIndicator = document.getElementById('lesson-type-indicator');

    // Debug: Verificar que los elementos existen
    console.log('[DEBUG] Elementos encontrados:');
    console.log('- lessonForm:', !!lessonForm);
    console.log('- lessonTypeSelect:', !!lessonTypeSelect);
    console.log('- courseSelect:', !!courseSelect);
    console.log('- moduleSelect:', !!moduleSelect);
    console.log('- moduleSelect ID:', moduleSelect ? moduleSelect.id : 'N/A');

    // Variables para el quiz
    let questionCount = 0;

    // Datos de módulos por curso (se cargarán dinámicamente)
    let modulesData = {};

    // Variables para navegación y estado
    let currentSection = 'basic-info';
    let autoSaveTimer = null;
    let isFormDirty = false;
    let progressCollapsed = false;

    // Sticky Action Bar helpers
    const stickyBar = document.getElementById('sticky-action-bar');
    const discardBtn = document.getElementById('discard-changes-btn');

    // Snapshot inicial del formulario para poder descartar cambios
    const initialSnapshot = (() => {
        const fd = new FormData(lessonForm);
        const obj = {};
        fd.forEach((v, k) => {
            // Evitar incluir archivos en snapshot
            if (!(lessonForm.elements[k] && lessonForm.elements[k].type === 'file')) {
                obj[k] = v;
            }
        });
        return obj;
    })();

    function restoreSnapshot() {
        Object.entries(initialSnapshot).forEach(([name, value]) => {
            const el = lessonForm.elements[name];
            if (!el) return;
            if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.value = value ?? '';
                // Disparar input para actualizar UI reactivamente
                el.dispatchEvent(new Event('input', { bubbles: true }));
                el.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        isFormDirty = false;
        updateStickyBar();
        updateProgress();
        updatePreview();
        updateStatusIndicators();
    }

    function updateStickyBar() {
        if (!stickyBar) return;
        // Mostrar solo cuando hay cambios
        const shouldShow = !!isFormDirty;
        stickyBar.classList.toggle('show', shouldShow);
        stickyBar.classList.toggle('d-none', !shouldShow);
    }

    if (discardBtn) {
        discardBtn.addEventListener('click', function() {
            if (confirm('¿Descartar cambios no guardados?')) {
                restoreSnapshot();
            }
        });
    }

    // Ocultar barra al guardar
    lessonForm.addEventListener('submit', function() {
        isFormDirty = false;
        updateStickyBar();
    });

    // Marcar sucio y actualizar barra en cambios
    lessonForm.addEventListener('input', function() {
        isFormDirty = true;
        updateStickyBar();
    });
    lessonForm.addEventListener('change', function() {
        isFormDirty = true;
        updateStickyBar();
    });

    // También en scroll (para animación fluida cuando hay movimiento)
    window.addEventListener('scroll', updateStickyBar);

    // Función para mostrar sección de contenido según el tipo
    function showContentSection(type) {
        contentSections.forEach(section => {
            section.style.display = 'none';
            section.style.opacity = '0';
        });

        const activeSection = document.getElementById(type + '-content');
        if (activeSection) {
            activeSection.style.display = 'block';
            setTimeout(() => {
                activeSection.style.opacity = '1';
            }, 50);
        }

        // Actualizar indicador de tipo
        updateLessonTypeIndicator(type);
    }

    // Función para actualizar el indicador de tipo de lección
    function updateLessonTypeIndicator(type) {
        const indicators = {
            'text': { icon: 'file-earmark-text', text: 'Texto', class: 'text' },
            'video': { icon: 'play-circle', text: 'Video', class: 'video' },
            'quiz': { icon: 'question-circle', text: 'Quiz', class: 'quiz' },
            'assignment': { icon: 'pencil-square', text: 'Tarea', class: 'assignment' }
        };

        const indicator = indicators[type];
        if (indicator && lessonTypeIndicator) {
            lessonTypeIndicator.innerHTML = `
                <span class="content-type-indicator ${indicator.class}">
                    <i class="bi bi-${indicator.icon} me-1"></i>${indicator.text}
                </span>
            `;
        }
    }

    // Función para calcular progreso del formulario
    function calculateProgress() {
        const requiredFields = lessonForm.querySelectorAll('input[required], select[required], textarea[required]');
        let filledFields = 0;
        let totalFields = requiredFields.length;

        requiredFields.forEach(field => {
            if (field.value.trim() !== '') {
                filledFields++;
            }
        });

        const progress = totalFields > 0 ? (filledFields / totalFields) * 100 : 0;
        return {
            percentage: Math.min(progress, 100),
            filled: filledFields,
            total: totalFields
        };
    }

    // Función para validar campos requeridos en tiempo real
    function validateRequiredFields() {
        const requiredFields = lessonForm.querySelectorAll('input[required], select[required], textarea[required]');
        let hasErrors = false;

        requiredFields.forEach(field => {
            const fieldContainer = field.closest('.form-group');
            const errorElement = fieldContainer.querySelector('.invalid-feedback');

            // Remover clases de error previas
            field.classList.remove('is-invalid');
            field.setAttribute('aria-invalid', 'false');

            if (field.value.trim() === '') {
                field.classList.add('is-invalid');
                field.setAttribute('aria-invalid', 'true');
                if (errorElement) {
                    errorElement.textContent = 'Este campo es obligatorio';
                    errorElement.style.display = 'block';
                }
                hasErrors = true;
            } else {
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            }
        });

        return !hasErrors;
    }

    // Función para validar selección de curso y módulo
    function validateCourseModuleSelection() {
        const courseSelect = document.getElementById('course-select');

        let hasErrors = false;

        // Validar curso
        if (!courseSelect || !courseSelect.value) {
            updateStatusIndicator('course-status', 'error', 'Debe seleccionar un curso');
            hasErrors = true;
        } else {
            updateStatusIndicator('course-status', 'success', 'Curso seleccionado correctamente');
        }

        // Validar módulo solo si moduleSelect existe
        if (moduleSelect) {
            if (!moduleSelect.value) {
                updateStatusIndicator('module-status', 'error', 'Debe seleccionar un módulo');
                hasErrors = true;
            } else {
                updateStatusIndicator('module-status', 'success', 'Módulo seleccionado correctamente');
            }
        } else {
            console.error('[ERROR] moduleSelect no encontrado con ID "id_module"');
            updateStatusIndicator('module-status', 'error', 'Error: Campo módulo no encontrado');
            hasErrors = true;
        }

        return !hasErrors;
    }

    // Función para actualizar el indicador de progreso
    function updateProgress() {
        const progressData = calculateProgress();
        const progress = progressData.percentage;

        if (progressFill && progressText) {
            progressFill.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
        }

        // Actualizar contador de campos
        const fieldsCompleted = document.getElementById('fields-completed');
        if (fieldsCompleted) {
            fieldsCompleted.textContent = `${progressData.filled}/${progressData.total} campos completados`;
        }

        // Actualizar progreso de secciones
        updateSectionProgress(progressData);
    }

    // Función para actualizar progreso de secciones
    function updateSectionProgress(progressData) {
        const sectionProgressBar = document.getElementById('section-progress-bar');
        const sectionProgressText = document.getElementById('section-progress-text');

        if (sectionProgressBar && sectionProgressText) {
            // Calcular progreso basado en secciones completadas
            let completedSections = 0;
            const totalSections = 4;

            // Sección 1: Información básica (siempre al menos parcialmente completa)
            if (progressData.filled > 0) completedSections++;

            // Sección 2: Contenido (si hay tipo de lección seleccionado)
            const lessonType = document.getElementById('{{ form.lesson_type.id_for_label }}');
            if (lessonType && lessonType.value) completedSections++;

            // Sección 3: Quiz (opcional)
            const quizQuestions = document.querySelectorAll('.question-card');
            if (quizQuestions.length > 0) completedSections++;

            // Sección 4: Assignment (opcional)
            const assignmentFile = document.getElementById('{{ form.assignment_file.id_for_label }}');
            if (assignmentFile && assignmentFile.files.length > 0) completedSections++;

            const sectionProgress = (completedSections / totalSections) * 100;
            sectionProgressBar.style.width = sectionProgress + '%';
            sectionProgressText.textContent = `Sección ${Math.min(completedSections + 1, totalSections)} de ${totalSections} completada`;
        }
    }

    // Función para actualizar indicadores de estado
    function updateStatusIndicator(indicatorId, status, message) {
        const indicator = document.getElementById(indicatorId);
        if (!indicator) return;

        // Remover clases anteriores
        indicator.classList.remove('success', 'warning', 'info', 'error');

        // Agregar nueva clase de estado
        indicator.classList.add(status);

        // Actualizar contenido
        const statusSpan = indicator.querySelector('span');
        if (statusSpan) {
            statusSpan.textContent = message;
        }

        // Actualizar descripción para lectores de pantalla
        const description = indicator.querySelector('.sr-only');
        if (description) {
            description.textContent = message;
        }

        // Actualizar ARIA live region
        indicator.setAttribute('aria-live', 'polite');
    }

    // Función para cargar módulos por curso usando AJAX
    function loadModulesForCourse(courseId) {
        console.log(`[DEBUG] loadModulesForCourse called with courseId: ${courseId}`);
        console.log(`[DEBUG] courseSelect value: ${courseSelect ? courseSelect.value : 'null'}`);
        console.log(`[DEBUG] moduleSelect exists: ${!!moduleSelect}`);

        if (!courseId) {
            console.log('[DEBUG] No hay courseId, reseteando select');
            // Reset module select
            if (moduleSelect) {
                moduleSelect.innerHTML = '<option value="">Primero selecciona un curso...</option>';
                moduleSelect.disabled = false;
            }
            return;
        }

        // Verificar que moduleSelect existe
        if (!moduleSelect) {
            console.error('[ERROR] moduleSelect no encontrado, no se pueden cargar módulos');
            showTemporaryMessage('Error: Elemento de módulos no encontrado', 'error');
            return;
        }

        // Mostrar indicador de carga
        moduleSelect.disabled = true;
        moduleSelect.innerHTML = '<option value="">Cargando módulos...</option>';

        // Mostrar indicador de carga en el DOM
        const moduleLoading = document.getElementById('module-loading');
        if (moduleLoading) {
            moduleLoading.classList.remove('d-none');
        }

        // Hacer petición AJAX
        fetch(`/courses/api/course/${courseId}/modules/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Respuesta AJAX:', data);

            if (data.success) {
                console.log('Módulos cargados exitosamente:', data.modules);
                updateModuleSelect(data.modules);

                // Ocultar indicador de carga
                if (moduleLoading) {
                    moduleLoading.classList.add('d-none');
                }

                // Mostrar mensaje de éxito temporal
                showTemporaryMessage('Módulos cargados correctamente', 'success');

                // Los módulos ya están cargados, intentar preseleccionar el módulo correcto
                console.log('[DEBUG] Módulos cargados exitosamente, intentando preseleccionar módulo...');

                // Intentar preseleccionar el módulo después de un breve delay
                setTimeout(() => {
                    const currentModuleValue = moduleSelect.getAttribute('data-initial-value') || moduleSelect.value;
                    console.log('[DEBUG] Intentando preseleccionar módulo con valor:', currentModuleValue);

                    if (currentModuleValue && currentModuleValue !== '') {
                        // Buscar la opción correspondiente
                        const optionToSelect = moduleSelect.querySelector(`option[value="${currentModuleValue}"]`);
                        if (optionToSelect) {
                            moduleSelect.value = currentModuleValue;
                            console.log(`[SUCCESS] Módulo ${currentModuleValue} preseleccionado correctamente`);

                            // Disparar evento change para actualizar validaciones
                            moduleSelect.dispatchEvent(new Event('change', { bubbles: true }));

                            // Actualizar indicadores de estado
                            updateStatusIndicators();
                        } else {
                            console.warn(`[WARNING] No se encontró opción para módulo ${currentModuleValue}`);
                        }
                    } else {
                        console.log('[DEBUG] No hay módulo para preseleccionar');
                    }
                }, 200);
            } else {
                console.error('Error en respuesta AJAX:', data.error);
                showTemporaryMessage('Error al cargar módulos: ' + (data.error || 'Error desconocido'), 'error');
            }

            // Habilitar el select
            if (moduleSelect) {
                moduleSelect.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error al cargar módulos vía AJAX:', error);

            // Mostrar mensaje de error
            showTemporaryMessage('Error de conexión al cargar módulos: ' + error.message, 'error');

            // Resetear select en caso de error
            moduleSelect.innerHTML = '<option value="">Error al cargar módulos</option>';
            moduleSelect.disabled = false;

            // Ocultar indicador de carga
            if (moduleLoading) {
                moduleLoading.classList.add('d-none');
            }
        });
    }

    // Función para actualizar el select de módulos
    function updateModuleSelect(modules) {
        if (!moduleSelect) {
            console.error('Elemento moduleSelect no encontrado');
            return;
        }

        console.log('Actualizando select de módulos con:', modules);

        // Guardar el valor actual del módulo (útil para edición)
        const currentModuleValue = moduleSelect.value;
        console.log('Valor actual del módulo:', currentModuleValue);

        let optionsHtml = '<option value="">Seleccionar módulo...</option>';

        if (modules && Array.isArray(modules) && modules.length > 0) {
            console.log(`Agregando ${modules.length} módulos al select`);
            modules.forEach(module => {
                if (module && module.id && module.title) {
                    const selected = (currentModuleValue && module.id == currentModuleValue) ? 'selected' : '';
                    optionsHtml += `<option value="${module.id}" ${selected}>${module.title}</option>`;
                    console.log(`Agregado módulo: ${module.title} (ID: ${module.id})`);
                } else {
                    console.warn('Módulo inválido encontrado:', module);
                }
            });
        } else {
            console.warn('No hay módulos válidos para mostrar');
            optionsHtml = '<option value="">No hay módulos disponibles</option>';
        }

        moduleSelect.innerHTML = optionsHtml;
        console.log('HTML del select actualizado:', optionsHtml);

        // Si había un módulo seleccionado y no se encontró en la lista, mostrar advertencia
        if (currentModuleValue && Array.isArray(modules) && !modules.some(module => module && module.id == currentModuleValue)) {
            console.warn(`Módulo con ID ${currentModuleValue} no encontrado en los módulos disponibles`);
        }

        // Forzar actualización del DOM
        moduleSelect.dispatchEvent(new Event('change', { bubbles: true }));

        // Habilitar el select después de actualizar
        moduleSelect.disabled = false;
    }

    // Función para actualizar preview
    function updatePreview() {
        const title = document.getElementById('{{ form.title.id_for_label }}').value;
        const content = document.getElementById('{{ form.content.id_for_label }}').value;
        const lessonType = lessonTypeSelect.value;
        const selectedCourse = courseSelect ? courseSelect.value : '';

        let previewHtml = '';

        if (title) {
            previewHtml += `<h5 class="mb-3">${title}</h5>`;
        }

        // Mostrar información del curso si está seleccionado
        if (selectedCourse) {
            const courseOption = courseSelect.querySelector(`option[value="${selectedCourse}"]`);
            if (courseOption) {
                previewHtml += `<div class="mb-2"><small class="text-muted">Curso: ${courseOption.textContent}</small></div>`;
            }
        }

        if (lessonType === 'text' && content) {
            previewHtml += `<div class="text-preview">${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</div>`;
        } else if (lessonType === 'video') {
            previewHtml += `
                <div class="text-center">
                    <i class="bi bi-play-circle text-primary fs-1 mb-2"></i>
                    <p class="text-muted">Vista previa no disponible para videos</p>
                </div>
            `;
        } else if (lessonType === 'quiz') {
            const questionCount = document.querySelectorAll('.question-card').length;
            previewHtml += `
                <div class="text-center">
                    <i class="bi bi-question-circle text-warning fs-1 mb-2"></i>
                    <p class="text-muted">${questionCount} pregunta${questionCount !== 1 ? 's' : ''} en el quiz</p>
                </div>
            `;
        }

        if (!previewHtml) {
            previewHtml = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-eye-slash fs-1 mb-3"></i>
                    <p>Completa los campos para ver la preview</p>
                </div>
            `;
        }

        if (previewPanel) {
            previewPanel.innerHTML = previewHtml;
        }
    }

    // Función para drag & drop de archivos
    function initializeDragDrop() {
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('{{ form.assignment_file.id_for_label }}');

        if (!fileUploadArea || !fileInput) return;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileUploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            fileUploadArea.classList.remove('dragover');
        }

        fileUploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        }

        fileInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });
    }

    // Función para manejar selección de archivo
    function handleFileSelect(file) {
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');

        if (filePreview && fileName && fileSize) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.style.display = 'block';
        }
    }

    // Función para formatear tamaño de archivo
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Función para limpiar archivo
    function clearFile() {
        const fileInput = document.getElementById('{{ form.assignment_file.id_for_label }}');
        const filePreview = document.getElementById('file-preview');

        if (fileInput) fileInput.value = '';
        if (filePreview) filePreview.style.display = 'none';
    }

    // Función para toggle de navegación
    function toggleNavigation() {
        const navigation = document.getElementById('form-navigation');
        if (navigation) {
            navigation.style.display = navigation.style.display === 'block' ? 'none' : 'block';
        }
    }

    // Función para mostrar shortcuts de teclado
    function showKeyboardShortcuts() {
        const shortcuts = document.getElementById('keyboard-shortcuts');
        if (shortcuts) {
            shortcuts.style.display = shortcuts.style.display === 'block' ? 'none' : 'block';
        }
    }

    // Función para toggle del progreso
    function toggleProgress() {
        const details = document.getElementById('progress-details');
        const icon = document.getElementById('progress-toggle-icon');

        if (details && icon) {
            progressCollapsed = !progressCollapsed;
            details.style.display = progressCollapsed ? 'block' : 'none';
            icon.className = progressCollapsed ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
        }
    }

    // Función para actualizar indicadores de estado
    function updateStatusIndicators() {
        validateCourseModuleSelection();

        const contentStatus = document.getElementById('content-status');

        // Actualizar estado del contenido
        if (lessonTypeSelect && lessonTypeSelect.value) {
            updateStatusIndicator('content-status', 'success', 'Tipo de contenido definido');
        } else {
            updateStatusIndicator('content-status', 'info', 'Selecciona el tipo de contenido');
        }

        // Actualizar estado de validación
        const validationStatus = document.getElementById('validation-status');
        if (validationStatus) {
            const isValid = validateRequiredFields();
            if (isValid) {
                updateStatusIndicator('validation-status', 'success', 'Formulario válido');
            } else {
                updateStatusIndicator('validation-status', 'warning', 'Complete los campos requeridos');
            }
        }
    }

    // Función para navegación por secciones
    function initializeSectionNavigation() {
        const sectionButtons = document.querySelectorAll('.section-nav-btn');
        const sections = {
            'basic-info': document.getElementById('basic-info'),
            'content-section': document.getElementById('content-section'),
            'quiz-section': document.getElementById('quiz-section'),
            'assignment-section': document.getElementById('assignment-section')
        };

        sectionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                const targetSection = sections[sectionId];

                if (targetSection) {
                    // Remover clase active de todos los botones
                    sectionButtons.forEach(btn => btn.classList.remove('active'));
                    sectionButtons.forEach(btn => btn.removeAttribute('aria-current'));

                    // Agregar clase active al botón actual
                    this.classList.add('active');
                    this.setAttribute('aria-current', 'step');

                    // Hacer scroll a la sección
                    targetSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });

                    // Actualizar navegación por teclado
                    updateKeyboardNavigation(sectionId);
                }
            });
        });

        // Toggle navegación de secciones
        const toggleBtn = document.getElementById('toggle-section-nav');
        const navContent = document.getElementById('section-nav-content');

        if (toggleBtn && navContent) {
            toggleBtn.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);
                navContent.style.display = isExpanded ? 'none' : 'block';

                const icon = this.querySelector('i');
                if (icon) {
                    icon.className = isExpanded ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
                }
            });
        }
    }

    // Función para navegación por teclado mejorada
    function initializeKeyboardNavigation() {
        // Manejar navegación con Enter y flechas
        document.addEventListener('keydown', function(e) {
            // Solo procesar si no estamos en un input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                // Permitir navegación normal en campos de formulario
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    // Mover al siguiente campo
                    const formFields = Array.from(lessonForm.querySelectorAll('input, select, textarea, button'));
                    const currentIndex = formFields.indexOf(e.target);
                    if (currentIndex < formFields.length - 1) {
                        formFields[currentIndex + 1].focus();
                    }
                }
                return;
            }

            // Navegación por secciones con flechas
            if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateSections(e.key === 'ArrowRight' ? 'next' : 'prev');
            }
        });

        // Agregar navegación por teclado a elementos interactivos
        const interactiveElements = document.querySelectorAll('button, [role="button"], .tooltip-icon');
        interactiveElements.forEach(element => {
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    }

    // Función para navegar entre secciones
    function navigateSections(direction) {
        const sections = ['basic-info', 'content-section', 'quiz-section', 'assignment-section'];
        const currentSection = sections.find(section => {
            const element = document.getElementById(section);
            if (element) {
                const rect = element.getBoundingClientRect();
                return rect.top <= 100 && rect.bottom >= 100;
            }
            return false;
        });

        if (currentSection) {
            const currentIndex = sections.indexOf(currentSection);
            let nextIndex;

            if (direction === 'next' && currentIndex < sections.length - 1) {
                nextIndex = currentIndex + 1;
            } else if (direction === 'prev' && currentIndex > 0) {
                nextIndex = currentIndex - 1;
            } else {
                return; // No hay sección siguiente/anterior
            }

            const nextSectionId = sections[nextIndex];
            const nextSection = document.getElementById(nextSectionId);

            if (nextSection) {
                nextSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // Actualizar navegación por secciones
                updateSectionNavigation(nextSectionId);
            }
        }
    }

    // Función para actualizar navegación por secciones
    function updateSectionNavigation(activeSectionId) {
        const sectionButtons = document.querySelectorAll('.section-nav-btn');

        sectionButtons.forEach(button => {
            button.classList.remove('active');
            button.removeAttribute('aria-current');

            if (button.getAttribute('data-section') === activeSectionId) {
                button.classList.add('active');
                button.setAttribute('aria-current', 'step');
            }
        });
    }

    // Función para actualizar navegación por teclado
    function updateKeyboardNavigation(activeSectionId) {
        // Actualizar el foco y navegación por teclado según la sección activa
        const sectionElement = document.getElementById(activeSectionId);
        if (sectionElement) {
            // Enfocar el primer elemento interactivo de la sección
            const firstInteractive = sectionElement.querySelector('input, select, textarea, button');
            if (firstInteractive) {
                setTimeout(() => firstInteractive.focus(), 500); // Pequeño delay para el scroll
            }
        }
    }

    // Función para navegación del formulario
    function initializeFormNavigation() {
        const navItems = document.querySelectorAll('.form-nav-item');

        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                scrollToSection(sectionId);
                updateActiveNavItem(sectionId);
            });
        });

        // Actualizar navegación activa al hacer scroll
        window.addEventListener('scroll', updateActiveNavigationOnScroll);
    }

    // Función para hacer scroll a sección
    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Función para actualizar item activo en navegación
    function updateActiveNavItem(activeSection) {
        const navItems = document.querySelectorAll('.form-nav-item');
        navItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-section') === activeSection) {
                item.classList.add('active');
            }
        });
        currentSection = activeSection;
    }

    // Función para actualizar navegación al hacer scroll
    function updateActiveNavigationOnScroll() {
        const sections = ['basic-info', 'content-section', 'quiz-section', 'assignment-section', 'preview-section'];

        for (const sectionId of sections) {
            const section = document.getElementById(sectionId);
            if (section) {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100 && rect.bottom >= 100) {
                    updateActiveNavItem(sectionId);
                    break;
                }
            }
        }
    }

    // Función para shortcuts de teclado
    function initializeKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
            // Solo procesar si no estamos en un input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        // Simular click en guardar
                        const saveBtn = document.querySelector('.btn-save');
                        if (saveBtn) saveBtn.click();
                        break;
                    case 'l':
                        e.preventDefault();
                        if (typeof resetForm === 'function') resetForm();
                        break;
                    case 'p':
                        e.preventDefault();
                        updatePreview();
                        break;
                    case 'n':
                        e.preventDefault();
                        toggleNavigation();
                        break;
                }
            }

            if (e.key === 'F1') {
                e.preventDefault();
                showKeyboardShortcuts();
            }
        });
    }

    // Función para auto-guardado
    function initializeAutoSave() {
        // Auto-guardar cada 30 segundos si hay cambios
        setInterval(function() {
            if (isFormDirty) {
                autoSaveForm();
            }
        }, 30000);

        // Marcar formulario como "sucio" cuando hay cambios
        lessonForm.addEventListener('input', function() {
            isFormDirty = true;
        });
    }

    // Función para auto-guardar
    function autoSaveForm() {
        const formData = new FormData(lessonForm);
        const autoSaveIndicator = document.getElementById('auto-save-indicator');
        const autoSaveMessage = document.getElementById('auto-save-message');

        // Mostrar indicador de guardado
        if (autoSaveIndicator) {
            autoSaveIndicator.className = 'auto-save-indicator';
            autoSaveIndicator.style.display = 'flex';
            autoSaveMessage.textContent = 'Guardando...';
        }

        // Simular auto-guardado (en producción, esto sería una llamada AJAX)
        setTimeout(function() {
            if (autoSaveIndicator) {
                autoSaveIndicator.classList.add('success');
                autoSaveMessage.textContent = 'Guardado automáticamente';
                isFormDirty = false;

                // Ocultar después de 3 segundos
                setTimeout(function() {
                    autoSaveIndicator.style.display = 'none';
                }, 3000);
            }
        }, 1000);
    }

    // Función mejorada para agregar pregunta al quiz
    function addQuestion(questionData = null) {
        questionCount++;
        // Compatibilidad con estructura persistida (correct o correct_answer)
        const correctKey = questionData ? (questionData.correct ?? questionData.correct_answer ?? '') : '';
        const safeOptions = questionData && Array.isArray(questionData.options) ? questionData.options : ['', '', '', ''];
        const qTextValue = questionData ? (questionData.question || '') : '';

        const questionHtml = `
            <div class="question-card fade-in" data-question-id="${questionCount}">
                <div class="question-header">
                    <div class="question-number">${questionCount}</div>
                    <button type="button" class="btn-remove remove-question" data-question-id="${questionCount}" title="Eliminar pregunta">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>

                <div class="mb-3">
                    <input type="text" class="form-control" name="question_${questionCount}_text"
                           placeholder="Escribe la pregunta aquí..." value="${qTextValue}" required>
                </div>

                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group mb-2">
                            <span class="input-group-text">A</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_a"
                                   placeholder="Opción A" value="${safeOptions[0] || ''}" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">B</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_b"
                                   placeholder="Opción B" value="${safeOptions[1] || ''}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group mb-2">
                            <span class="input-group-text">C</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_c"
                                   placeholder="Opción C" value="${safeOptions[2] || ''}" required>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">D</span>
                            <input type="text" class="form-control" name="question_${questionCount}_option_d"
                                   placeholder="Opción D" value="${safeOptions[3] || ''}" required>
                        </div>
                    </div>
                </div>

                <div class="mb-0">
                    <label class="form-label fw-semibold">Respuesta Correcta:</label>
                    <select class="form-select" name="question_${questionCount}_correct" required>
                        <option value="">Seleccionar respuesta correcta...</option>
                        <option value="a" ${correctKey === 'a' ? 'selected' : ''}>A - Opción A</option>
                        <option value="b" ${correctKey === 'b' ? 'selected' : ''}>B - Opción B</option>
                        <option value="c" ${correctKey === 'c' ? 'selected' : ''}>C - Opción C</option>
                        <option value="d" ${correctKey === 'd' ? 'selected' : ''}>D - Opción D</option>
                    </select>
                </div>
            </div>
        `;

        document.getElementById('questions-container').insertAdjacentHTML('beforeend', questionHtml);
        updateProgress();
        updateQuizHiddenField();
    }

    // Serializa el constructor de quiz al campo oculto JSON
    function serializeQuizQuestions() {
        const cards = document.querySelectorAll('#questions-container .question-card');
        const data = [];
        cards.forEach((card) => {
            // No depender del índice en el nombre; buscar por sufijo
            const qText = card.querySelector('input[name$="_text"]')?.value?.trim() || '';
            const a = card.querySelector('input[name$="_option_a"]')?.value?.trim() || '';
            const b = card.querySelector('input[name$="_option_b"]')?.value?.trim() || '';
            const c = card.querySelector('input[name$="_option_c"]')?.value?.trim() || '';
            const d = card.querySelector('input[name$="_option_d"]')?.value?.trim() || '';
            const correct = card.querySelector('select[name$="_correct"]')?.value || '';

            if (qText || a || b || c || d || correct) {
                data.push({
                    question: qText,
                    options: [a, b, c, d],
                    correct_answer: correct
                });
            }
        });
        return data;
    }

    function updateQuizHiddenField() {
        const quizHidden = document.getElementById('{{ form.quiz_questions.id_for_label }}');
        if (!quizHidden) return;

        const type = lessonTypeSelect ? lessonTypeSelect.value : '';
        if (type === 'quiz') {
            const payload = serializeQuizQuestions();
            try {
                quizHidden.value = JSON.stringify(payload);
            } catch (e) {
                console.warn('[QUIZ] Error serializando preguntas:', e);
            }
        } else {
            quizHidden.value = '';
        }
    }

    // Carga preguntas desde el hidden JSON al constructor (modo edición o reintento)
    function loadQuizFromHidden() {
        const quizHidden = document.getElementById('{{ form.quiz_questions.id_for_label }}');
        if (!quizHidden || !quizHidden.value) return;

        try {
            const data = JSON.parse(quizHidden.value);
            if (Array.isArray(data) && data.length) {
                const container = document.getElementById('questions-container');
                if (container) container.innerHTML = '';
                questionCount = 0;
                data.forEach(q => addQuestion(q));
                updateQuizHiddenField();
                updateProgress();
                updatePreview();
            }
        } catch (e) {
            console.warn('[QUIZ] JSON inválido en quiz_questions:', e);
        }
    }

    // Función para resetear formulario
    window.resetForm = function() {
        if (confirm('¿Estás seguro de que quieres limpiar todos los campos?')) {
            lessonForm.reset();
            document.getElementById('questions-container').innerHTML = '';
            questionCount = 0;
            updateProgress();
            updatePreview();
            if (lessonTypeSelect.value) {
                showContentSection(lessonTypeSelect.value);
            }
        }
    };

    // Event Listeners mejorados
    if (courseSelect) {
        console.log('[DEBUG] courseSelect found, adding event listener');
        courseSelect.addEventListener('change', function() {
            console.log('[DEBUG] courseSelect change event fired');
            const courseId = this.value;
            console.log(`[DEBUG] Selected courseId: ${courseId}`);
            loadModulesForCourse(courseId);
            updateProgress();
            updatePreview();
            updateStatusIndicators();

            // Validar en tiempo real
            validateCourseModuleSelection();
        });

        // Verificar si ya hay un valor seleccionado al cargar
        console.log(`[DEBUG] courseSelect initial value: ${courseSelect.value}`);
        if (courseSelect.value) {
            console.log('[DEBUG] courseSelect has initial value, loading modules');
            loadModulesForCourse(courseSelect.value);
        }
    } else {
        console.error('[DEBUG] courseSelect not found!');
    }

    // Agregar event listeners adicionales para courseSelect
    if (courseSelect) {
        courseSelect.addEventListener('blur', function() {
            validateCourseModuleSelection();
        });

        // Cargar módulos iniciales si hay un curso preseleccionado
        if (courseSelect.value) {
            loadModulesForCourse(courseSelect.value);
        }
    }

    // Agregar event listeners para moduleSelect solo si existe
    if (moduleSelect) {
        moduleSelect.addEventListener('change', function() {
            updateProgress();
            updatePreview();
            updateStatusIndicators();
            validateCourseModuleSelection();
        });

        moduleSelect.addEventListener('blur', function() {
            validateCourseModuleSelection();
        });
    } else {
        console.warn('moduleSelect no encontrado, algunos event listeners no se pudieron agregar');
    }

    // Inicialización especial para modo edición
    function initializeEditMode() {
        if (isInitializing) {
            console.log('[DEBUG] initializeEditMode - Ya se está inicializando, omitiendo...');
            return;
        }

        if (!courseSelect) {
            console.warn('courseSelect no encontrado, no se puede inicializar modo edición');
            return;
        }

        const currentCourseValue = courseSelect.value;
        console.log('[DEBUG] initializeEditMode - currentCourseValue:', currentCourseValue);

        // Si hay un curso preseleccionado
        if (currentCourseValue) {
            console.log('Curso preseleccionado detectado - Inicializando módulos...');

            // Cargar módulos del curso actual
            loadModulesForCourse(currentCourseValue);

            // Si moduleSelect existe, intentar preseleccionar el módulo
            if (moduleSelect) {
                const currentModuleValue = moduleSelect.value;
                console.log('[DEBUG] initializeEditMode - currentModuleValue:', currentModuleValue);

                if (currentModuleValue) {
                    // Asegurar que el módulo actual esté seleccionado después de cargar
                    setTimeout(() => {
                        console.log('[DEBUG] initializeEditMode - Verificando preselección del módulo...');
                        console.log('[DEBUG] moduleSelect options length:', moduleSelect.options.length);

                        // Verificar si la opción existe
                        const optionExists = moduleSelect.querySelector(`option[value="${currentModuleValue}"]`);
                        console.log('[DEBUG] Opción del módulo existe:', !!optionExists);

                        if (optionExists) {
                            moduleSelect.value = currentModuleValue;
                            console.log(`Módulo ${currentModuleValue} seleccionado correctamente`);

                            // Forzar actualización del DOM
                            moduleSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        } else {
                            console.warn(`Módulo ${currentModuleValue} no encontrado en las opciones disponibles`);

                            // Mostrar todas las opciones disponibles para debug
                            console.log('[DEBUG] Opciones disponibles:');
                            for (let i = 0; i < moduleSelect.options.length; i++) {
                                console.log(`  ${moduleSelect.options[i].value}: ${moduleSelect.options[i].text}`);
                            }
                        }

                        updateStatusIndicators();
                        updateProgress();
                    }, 300); // Aumentar el timeout para dar más tiempo a la carga AJAX
                } else {
                    console.log('[DEBUG] No hay módulo preseleccionado, solo cargar módulos del curso');
                }
            } else {
                console.warn('[DEBUG] moduleSelect no encontrado en initializeEditMode');
            }
        } else {
            console.log('[DEBUG] No hay curso preseleccionado');
        }
    }

    // Función para mostrar mensajes temporales
    function showTemporaryMessage(message, type = 'info') {
        const existingMessage = document.querySelector('.temp-message');
        if (existingMessage) {
            existingMessage.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show temp-message`;
        messageDiv.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Insertar después del título
        const titleElement = document.querySelector('h1');
        if (titleElement && titleElement.parentNode) {
            titleElement.parentNode.insertBefore(messageDiv, titleElement.nextSibling);
        }

        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 5000);
    }

    // Variable para evitar bucles infinitos
    let isInitializing = false;

    // Función para inicializar el formulario
    function initializeForm() {
        if (isInitializing) {
            console.log('[DEBUG] Inicialización ya en progreso, omitiendo...');
            return;
        }

        isInitializing = true;
        console.log('Inicializando formulario de lección...');

        // Si hay un curso seleccionado y moduleSelect existe pero no tiene opciones, cargar módulos
        const courseSelect = document.getElementById('course-select');
        if (courseSelect && courseSelect.value && moduleSelect) {
            if (moduleSelect.options.length <= 1) { // Solo la opción por defecto
                console.log('Intentando cargar módulos para curso preseleccionado...');
                loadModulesForCourse(courseSelect.value);
            } else {
                // Si ya hay opciones, intentar inicializar modo edición
                console.log('Módulos ya cargados, inicializando modo edición...');
                initializeEditMode();
            }
        } else {
            // No hay curso preseleccionado, inicializar normalmente
            console.log('No hay curso preseleccionado, inicializando normalmente...');
        }

        // Configurar validaciones iniciales
        updateStatusIndicators();
        updateProgress();

        console.log('Inicialización del formulario completada.');
        isInitializing = false;
    }


    if (lessonTypeSelect) {
        // Mostrar sección inicial
        if (lessonTypeSelect.value) {
            showContentSection(lessonTypeSelect.value);
        }

        // Cambiar sección cuando cambia el tipo
        lessonTypeSelect.addEventListener('change', function() {
            showContentSection(this.value);
            updatePreview();
            updateStatusIndicators();
        });

        lessonTypeSelect.addEventListener('blur', function() {
            updateStatusIndicators();
        });
    }

    // Validación en tiempo real para campos requeridos
    const requiredFields = lessonForm.querySelectorAll('input[required], select[required], textarea[required]');
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateRequiredFields();
            updateProgress();
        });

        field.addEventListener('input', function() {
            // Solo actualizar progreso para campos de texto
            if (this.tagName === 'INPUT' || this.tagName === 'TEXTAREA') {
                updateProgress();
            }
        });
    });

    // Validación antes del envío del formulario
    lessonForm.addEventListener('submit', function(e) {
        // Sincronizar preguntas del quiz al hidden antes de validar/enviar
        try { updateQuizHiddenField(); } catch (err) { console.warn('[QUIZ] No se pudo sincronizar antes de enviar:', err); }

        const isValid = validateRequiredFields() && validateCourseModuleSelection();

        if (!isValid) {
            e.preventDefault();

            // Mostrar mensaje de error
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger alert-dismissible fade show';
            errorAlert.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Error de validación:</strong> Complete todos los campos requeridos antes de guardar.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Insertar al inicio del formulario
            const formCard = lessonForm.querySelector('.form-card');
            if (formCard) {
                formCard.parentNode.insertBefore(errorAlert, formCard);
            }

            // Hacer scroll al primer error
            const firstError = lessonForm.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }

            return false;
        }

        // Mostrar indicador de carga
        const submitBtn = lessonForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.classList.add('btn-loading');
            submitBtn.disabled = true;
        }
    });

    // Agregar pregunta al quiz
    const addQuestionBtn = document.getElementById('add-question-btn');
    if (addQuestionBtn) {
        addQuestionBtn.addEventListener('click', function() {
            addQuestion();
        });
    }

    // Remover pregunta
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-question') || e.target.closest('.remove-question')) {
            const questionId = e.target.closest('.remove-question').getAttribute('data-question-id');
            document.querySelector(`[data-question-id="${questionId}"]`).remove();
            updateProgress();
            updatePreview();
            updateQuizHiddenField();
        }
    });

    // Actualizar progreso y preview en tiempo real
    lessonForm.addEventListener('input', function() {
        updateProgress();
        updatePreview();
        updateQuizHiddenField();
    });

    lessonForm.addEventListener('change', function() {
        updateProgress();
        updatePreview();
        updateQuizHiddenField();
    });

    // Inicializar todas las funcionalidades avanzadas
    initializeDragDrop();
    initializeFormNavigation();
    initializeKeyboardShortcuts();
    initializeAutoSave();
    initializeSectionNavigation();
    updateStatusIndicators();

    // Inicializar
    updateProgress();
    updatePreview();

    // Llamar a la inicialización del formulario
    initializeForm();

    // Cargar preguntas desde el campo oculto al constructor (si existe contenido)
    loadQuizFromHidden();

    // Agregar clases de accesibilidad al body
    document.body.classList.add('js-enabled');

    // Anunciar carga completa para lectores de pantalla
    setTimeout(() => {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = 'Formulario de creación de lección cargado completamente. Use Tab para navegar entre campos.';
        document.body.appendChild(announcement);

        setTimeout(() => document.body.removeChild(announcement), 1000);
    }, 500);

    // Tooltips mejorados
    const tooltipElements = document.querySelectorAll('.tooltip-icon');
    tooltipElements.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            showTooltip(this, this.title);
        });
        element.addEventListener('mouseleave', function(e) {
            hideTooltip();
        });
    });

    // Función para mostrar tooltips personalizados
    function showTooltip(element, text) {
        const existingTooltip = document.querySelector('.custom-tooltip');
        if (existingTooltip) existingTooltip.remove();

        const tooltip = document.createElement('div');
        tooltip.className = 'custom-tooltip';
        tooltip.textContent = text;
        tooltip.style.cssText = `
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 10000;
            pointer-events: none;
            max-width: 200px;
            word-wrap: break-word;
        `;

        document.body.appendChild(tooltip);

        const rect = element.getBoundingClientRect();
        tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
    }

    // Función para ocultar tooltips
    function hideTooltip() {
        const tooltip = document.querySelector('.custom-tooltip');
        if (tooltip) tooltip.remove();
    }
});
</script>
{% endblock %}