{% extends "courses/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block course_content %}
<style>
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-success {
    background-color: #198754;
    border-color: #198754;
}

.btn-success:hover {
    background-color: #157347;
    border-color: #146c43;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: none;
}

.alert {
    border-radius: 0.5rem;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

@media (max-width: 576px) {
    .card-body {
        padding: 1rem !important;
    }

    .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }

    .d-flex.justify-content-end {
        flex-direction: column;
    }
}
</style>
<div class="pagetitle">
    <h1><i class="bi bi-tag me-2"></i>{{ title }}</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'courses:dashboard' %}">Cursos</a></li>
            <li class="breadcrumb-item"><a href="{% url 'courses:manage_categories' %}">Categorías</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-11 col-md-10 col-lg-8 col-xl-7">
            <div class="card">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h5 class="card-title mb-1">
                                <i class="bi bi-tag me-2"></i>Información de la Categoría
                            </h5>
                            <p class="text-muted mb-0">Complete los detalles de la nueva categoría</p>
                        </div>
                        <a href="{% url 'courses:manage_categories' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Volver
                        </a>
                    </div>

                    <form method="post">
                        {% csrf_token %}

                        <!-- Campo Nombre -->
                        <div class="mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-tag me-1 text-primary" aria-hidden="true"></i>
                                Nombre de la Categoría
                                <span class="text-danger" aria-label="Campo obligatorio">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small mt-1" role="alert" aria-live="polite">
                                    {{ form.name.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="invalid-feedback" id="name-feedback" role="alert" aria-live="polite">
                                El nombre es obligatorio y debe tener al menos 2 caracteres.
                            </div>
                            <div class="form-text">
                                <small class="text-muted" id="name-counter" aria-live="polite">0/50 caracteres</small>
                            </div>
                        </div>

                        <!-- Campo Descripción -->
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-card-text me-1 text-primary" aria-hidden="true"></i>
                                Descripción
                                <small class="text-muted fw-normal">(opcional)</small>
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger small mt-1" role="alert" aria-live="polite">
                                    {{ form.description.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="invalid-feedback" id="description-feedback" role="alert" aria-live="polite">
                                La descripción no puede exceder 200 caracteres.
                            </div>
                            <div class="form-text">
                                Describe brevemente el propósito y alcance de esta categoría
                                <small class="text-muted" id="description-counter" aria-live="polite">0/200 caracteres</small>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                            <a href="{% url 'courses:manage_categories' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <span class="spinner-border spinner-border-sm d-none me-2" role="status" id="submit-spinner"></span>
                                <i class="bi bi-check-circle me-1" id="submit-icon"></i>
                                <span id="submit-text">{% if category %}Actualizar{% else %}Crear{% endif %} Categoría</span>
                            </button>
                        </div>

                        <!-- Mensajes de éxito/error para AJAX -->
                        <div id="ajax-messages" class="mt-3 d-none">
                            <div class="alert alert-success alert-dismissible fade show" role="alert" id="success-alert">
                                <i class="bi bi-check-circle me-2"></i>
                                <span id="success-message"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            <div class="alert alert-danger alert-dismissible fade show d-none" role="alert" id="error-alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <span id="error-message"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    const submitBtn = document.getElementById('submit-btn');
    const submitSpinner = document.getElementById('submit-spinner');
    const submitIcon = document.getElementById('submit-icon');
    const submitText = document.getElementById('submit-text');
    const nameFeedback = document.getElementById('name-feedback');
    const descriptionFeedback = document.getElementById('description-feedback');
    const nameCounter = document.getElementById('name-counter');
    const descriptionCounter = document.getElementById('description-counter');
    const ajaxMessages = document.getElementById('ajax-messages');
    const successAlert = document.getElementById('success-alert');
    const errorAlert = document.getElementById('error-alert');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');

    // Función de validación del nombre
    function validateName() {
        const value = nameField.value.trim();
        const isValid = value.length >= 2 && value.length <= 50;

        nameField.classList.toggle('is-valid', isValid && value.length > 0);
        nameField.classList.toggle('is-invalid', !isValid && value.length > 0);

        if (value.length > 0 && !isValid) {
            nameFeedback.textContent = value.length < 2 ?
                'El nombre debe tener al menos 2 caracteres.' :
                'El nombre no puede exceder 50 caracteres.';
        }

        nameCounter.textContent = `${value.length}/50 caracteres`;
        return isValid;
    }

    // Función de validación de la descripción
    function validateDescription() {
        const value = descriptionField.value;
        const isValid = value.length <= 200;

        descriptionField.classList.toggle('is-valid', isValid && value.length > 0);
        descriptionField.classList.toggle('is-invalid', !isValid);

        descriptionCounter.textContent = `${value.length}/200 caracteres`;
        return isValid;
    }

    // Función para actualizar el estado del botón submit
    function updateSubmitButton() {
        const nameValid = validateName();
        const descriptionValid = validateDescription();
        const nameValue = nameField.value.trim();

        const isFormValid = nameValid && descriptionValid && nameValue.length > 0;
        submitBtn.disabled = !isFormValid;

        // Cambiar apariencia del botón
        submitBtn.classList.toggle('btn-success', isFormValid);
        submitBtn.classList.toggle('btn-primary', !isFormValid);
    }

    // Función para mostrar estado de carga
    function setLoadingState(loading) {
        submitBtn.disabled = loading;
        submitSpinner.classList.toggle('d-none', !loading);
        submitIcon.classList.toggle('d-none', loading);
        submitText.textContent = loading ? 'Creando...' : '{% if category %}Actualizar{% else %}Crear{% endif %} Categoría';
    }

    // Función para mostrar mensajes
    function showMessage(type, message) {
        ajaxMessages.classList.remove('d-none');
        if (type === 'success') {
            successMessage.textContent = message;
            successAlert.classList.remove('d-none');
            errorAlert.classList.add('d-none');
        } else {
            errorMessage.textContent = message;
            errorAlert.classList.remove('d-none');
            successAlert.classList.add('d-none');
        }
    }

    // Función para ocultar mensajes
    function hideMessages() {
        ajaxMessages.classList.add('d-none');
    }

    // Función para enviar formulario vía AJAX
    function submitForm(formData) {
        return fetch('{% url "courses:create_category" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
    }

    // Event listeners
    nameField.addEventListener('input', function() {
        validateName();
        updateSubmitButton();
        hideMessages();
    });

    nameField.addEventListener('blur', function() {
        validateName();
        updateSubmitButton();
    });

    descriptionField.addEventListener('input', function() {
        validateDescription();
        updateSubmitButton();
        hideMessages();
    });

    descriptionField.addEventListener('blur', function() {
        validateDescription();
        updateSubmitButton();
    });

    // Manejar envío del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!validateName() || !validateDescription()) {
            return false;
        }

        const formData = new FormData(this);
        setLoadingState(true);
        hideMessages();

        submitForm(formData)
            .then(response => response.json())
            .then(data => {
                setLoadingState(false);

                if (data.success) {
                    showMessage('success', data.message);

                    // Limpiar formulario
                    nameField.value = '';
                    descriptionField.value = '';
                    nameField.classList.remove('is-valid', 'is-invalid');
                    descriptionField.classList.remove('is-valid', 'is-invalid');
                    updateSubmitButton();

                    // Redirigir después de 2 segundos
                    setTimeout(() => {
                        window.location.href = '{% url "courses:manage_categories" %}';
                    }, 2000);
                } else {
                    // Mostrar errores del servidor
                    let errorText = 'Error al crear la categoría:';
                    for (const [field, errors] of Object.entries(data.errors)) {
                        errorText += `\n${field}: ${errors.join(', ')}`;
                    }
                    showMessage('error', errorText);
                }
            })
            .catch(error => {
                setLoadingState(false);
                showMessage('error', 'Error de conexión. Por favor, intenta nuevamente.');
                console.error('Error:', error);
            });

        return false;
    });

    // Validación inicial
    updateSubmitButton();
});
</script>
