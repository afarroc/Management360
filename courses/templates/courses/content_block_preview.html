{% extends "courses/base.html" %}
{% load static lesson_tags %}

{% block title %}{{ title }} - CMS{% endblock %}

{% block extra_head %}
<style>
.preview-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 2rem 0;
}

.preview-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
}

.preview-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
}

.preview-header h1 {
    margin: 0;
    font-weight: 600;
}

.preview-content {
    padding: 2rem;
}

.block-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.block-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.meta-label {
    font-weight: 600;
    color: #2d3748;
}

.meta-value {
    color: #718096;
}

.block-description {
    color: #4a5568;
    line-height: 1.6;
}

.content-preview {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 2rem;
    background: white;
    min-height: 300px;
}

.content-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.content-preview-title {
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}

.content-type-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.content-type-html { background: #e3f2fd; color: #1565c0; }
.content-type-bootstrap { background: #e1f5fe; color: #0277bd; }
.content-type-markdown { background: #e8f5e8; color: #2e7d32; }
.content-type-json { background: #fff3e0; color: #ef6c00; }
.content-type-text { background: #f3e5f5; color: #7b1fa2; }

.rendered-content {
    line-height: 1.6;
}

/* Estilos para contenido renderizado */
.rendered-content h1,
.rendered-content h2,
.rendered-content h3,
.rendered-content h4,
.rendered-content h5,
.rendered-content h6 {
    color: #2d3748;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}

.rendered-content h1 { font-size: 2rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
.rendered-content h2 { font-size: 1.75rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
.rendered-content h3 { font-size: 1.5rem; }
.rendered-content h4 { font-size: 1.25rem; }

.rendered-content p {
    margin-bottom: 1rem;
}

.rendered-content ul,
.rendered-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.rendered-content li {
    margin-bottom: 0.5rem;
}

.rendered-content blockquote {
    border-left: 4px solid #667eea;
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #718096;
}

.rendered-content code {
    background: #f1f3f4;
    padding: 0.125rem 0.25rem;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

.rendered-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.rendered-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.rendered-content th,
.rendered-content td {
    border: 1px solid #e9ecef;
    padding: 0.75rem;
    text-align: left;
}

.rendered-content th {
    background: #f8f9fa;
    font-weight: 600;
}

.rendered-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1rem 0;
}

.rendered-content .alert {
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.rendered-content .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.5rem;
    border-radius: 4px;
}

.raw-content {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 300px;
    overflow-y: auto;
}

.preview-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.btn-preview-action {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-preview-action:hover {
    text-decoration: none;
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .preview-header {
        padding: 1.5rem;
    }

    .preview-content {
        padding: 1.5rem;
    }

    .block-meta {
        grid-template-columns: 1fr;
    }

    .content-preview {
        padding: 1.5rem;
    }

    .preview-actions {
        flex-direction: column;
        align-items: center;
    }

    .btn-preview-action {
        width: 100%;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block course_content %}
<div class="preview-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="preview-card">
                    <div class="preview-header">
                        <h1><i class="bi bi-eye me-3"></i>{{ title }}</h1>
                    </div>

                    <div class="preview-content">
                        <!-- Información del bloque -->
                        <div class="block-info">
                            <div class="block-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Tipo:</span>
                                    <span class="meta-value">{{ content_block.get_content_type_display }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Autor:</span>
                                    <span class="meta-value">{{ content_block.author.get_full_name|default:content_block.author.username }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Categoría:</span>
                                    <span class="meta-value">{{ content_block.category|default:"Sin categoría" }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Usos:</span>
                                    <span class="meta-value">{{ content_block.usage_count }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Creado:</span>
                                    <span class="meta-value">{{ content_block.created_at|date:"d M Y" }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Actualizado:</span>
                                    <span class="meta-value">{{ content_block.updated_at|date:"d M Y H:i" }}</span>
                                </div>
                            </div>

                            {% if content_block.description %}
                            <div class="block-description">
                                <strong>Descripción:</strong> {{ content_block.description }}
                            </div>
                            {% endif %}

                            {% if content_block.tags %}
                            <div class="mt-2">
                                <strong>Etiquetas:</strong>
                                {% for tag in content_block.get_tags_list %}
                                <span class="badge bg-secondary me-1">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <div class="mt-2">
                                {% if content_block.is_featured %}
                                <span class="badge bg-warning me-2">
                                    <i class="bi bi-star-fill me-1"></i>Destacado
                                </span>
                                {% endif %}
                                {% if content_block.is_public %}
                                <span class="badge bg-success">
                                    <i class="bi bi-globe me-1"></i>Público
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-lock me-1"></i>Privado
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Contenido renderizado -->
                        <div class="content-preview">
                            <div class="content-preview-header">
                                <h3 class="content-preview-title">Contenido Renderizado</h3>
                                <span class="content-type-badge content-type-{{ content_block.content_type }}">
                                    {{ content_block.get_content_type_display }}
                                </span>
                            </div>

                            <div class="rendered-content">
                                {% if content_block.content_type == 'html' or content_block.content_type == 'bootstrap' %}
                                    {{ content_block.html_content|safe }}
                                {% elif content_block.content_type == 'markdown' %}
                                     {{ content_block.markdown_content|markdown|safe }}
                                {% elif content_block.content_type == 'json' %}
                                    <pre><code>{{ content_block.json_content|safe }}</code></pre>
                                {% elif content_block.content_type == 'text' %}
                                    <p>{{ content_block.html_content|linebreaks }}</p>
                                {% elif content_block.content_type == 'image' %}
                                    {% if content_block.json_content.url %}
                                        <img src="{{ content_block.json_content.url }}" alt="{{ content_block.json_content.alt|default:content_block.title }}" class="img-fluid rounded">
                                        {% if content_block.json_content.caption %}
                                            <p class="text-muted mt-2"><small>{{ content_block.json_content.caption }}</small></p>
                                        {% endif %}
                                    {% else %}
                                        <div class="text-center text-muted">
                                            <i class="bi bi-image fs-1"></i>
                                            <p>Imagen no configurada</p>
                                        </div>
                                    {% endif %}
                                {% elif content_block.content_type == 'video' %}
                                    {% if content_block.json_content.url %}
                                        <div class="ratio ratio-16x9">
                                            <iframe src="{{ content_block.json_content.url }}" frameborder="0" allowfullscreen></iframe>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted">
                                            <i class="bi bi-play-circle fs-1"></i>
                                            <p>Video no configurado</p>
                                        </div>
                                    {% endif %}
                                {% elif content_block.content_type == 'quote' %}
                                    <blockquote class="blockquote">
                                        <p class="mb-0">{{ content_block.json_content.text|default:"Cita no especificada" }}</p>
                                        {% if content_block.json_content.author %}
                                            <footer class="blockquote-footer">{{ content_block.json_content.author }}</footer>
                                        {% endif %}
                                    </blockquote>
                                {% elif content_block.content_type == 'code' %}
                                    <pre><code class="language-{{ content_block.json_content.language|default:'text' }}">{{ content_block.json_content.code|default:"Código no especificado" }}</code></pre>
                                {% elif content_block.content_type == 'list' %}
                                    {% if content_block.json_content.type == 'ordered' %}
                                        <ol>
                                            {% for item in content_block.json_content.items %}
                                                <li>{{ item }}</li>
                                            {% endfor %}
                                        </ol>
                                    {% else %}
                                        <ul>
                                            {% for item in content_block.json_content.items %}
                                                <li>{{ item }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                {% elif content_block.content_type == 'table' %}
                                    <table class="table table-striped">
                                        {% if content_block.json_content.headers %}
                                            <thead>
                                                <tr>
                                                    {% for header in content_block.json_content.headers %}
                                                        <th>{{ header }}</th>
                                                    {% endfor %}
                                                </tr>
                                            </thead>
                                        {% endif %}
                                        <tbody>
                                            {% for row in content_block.json_content.rows %}
                                                <tr>
                                                    {% for cell in row %}
                                                        <td>{{ cell }}</td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                {% elif content_block.content_type == 'card' %}
                                    <div class="card">
                                        {% if content_block.json_content.header %}
                                            <div class="card-header">{{ content_block.json_content.header }}</div>
                                        {% endif %}
                                        <div class="card-body">
                                            {% if content_block.json_content.title %}
                                                <h5 class="card-title">{{ content_block.json_content.title }}</h5>
                                            {% endif %}
                                            {% if content_block.json_content.text %}
                                                <p class="card-text">{{ content_block.json_content.text }}</p>
                                            {% endif %}
                                            {% if content_block.json_content.button %}
                                                <a href="{{ content_block.json_content.button.url|default:'#' }}" class="btn btn-primary">{{ content_block.json_content.button.text|default:'Ver más' }}</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% elif content_block.content_type == 'alert' %}
                                    <div class="alert alert-{{ content_block.json_content.type|default:'info' }} alert-dismissible fade show" role="alert">
                                        {{ content_block.json_content.message|default:"Mensaje de alerta" }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% elif content_block.content_type == 'button' %}
                                    <a href="{{ content_block.json_content.url|default:'#' }}" class="btn btn-{{ content_block.json_content.style|default:'primary' }} btn-{{ content_block.json_content.size|default:'md' }}">
                                        {% if content_block.json_content.icon %}
                                            <i class="bi bi-{{ content_block.json_content.icon }}"></i>
                                        {% endif %}
                                        {{ content_block.json_content.text|default:'Botón' }}
                                    </a>
                                {% elif content_block.content_type == 'form' %}
                                    <form method="post" action="{{ content_block.json_content.action|default:'#' }}">
                                        {% csrf_token %}
                                        {% for field in content_block.json_content.fields %}
                                            <div class="mb-3">
                                                <label class="form-label">{{ field.label }}</label>
                                                {% if field.type == 'textarea' %}
                                                    <textarea class="form-control" name="{{ field.name }}" placeholder="{{ field.placeholder }}"></textarea>
                                                {% else %}
                                                    <input type="{{ field.type|default:'text' }}" class="form-control" name="{{ field.name }}" placeholder="{{ field.placeholder }}">
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                        <button type="submit" class="btn btn-primary">{{ content_block.json_content.submit_text|default:'Enviar' }}</button>
                                    </form>
                                {% elif content_block.content_type == 'divider' %}
                                    <hr class="my-4">
                                {% elif content_block.content_type == 'icon' %}
                                    <div class="text-center">
                                        <i class="bi bi-{{ content_block.json_content.icon|default:'star' }} fs-1 text-{{ content_block.json_content.color|default:'primary' }}"></i>
                                        {% if content_block.json_content.text %}
                                            <p class="mt-2">{{ content_block.json_content.text }}</p>
                                        {% endif %}
                                    </div>
                                {% elif content_block.content_type == 'progress' %}
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-{{ content_block.json_content.color|default:'primary' }}" role="progressbar" style="width: {{ content_block.json_content.value|default:50 }}%" aria-valuenow="{{ content_block.json_content.value|default:50 }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ content_block.json_content.value|default:50 }}%
                                        </div>
                                    </div>
                                {% elif content_block.content_type == 'badge' %}
                                    <span class="badge bg-{{ content_block.json_content.color|default:'primary' }} fs-6">
                                        {% if content_block.json_content.icon %}
                                            <i class="bi bi-{{ content_block.json_content.icon }}"></i>
                                        {% endif %}
                                        {{ content_block.json_content.text|default:'Insignia' }}
                                    </span>
                                {% elif content_block.content_type == 'timeline' %}
                                    <div class="timeline">
                                        {% for item in content_block.json_content.items %}
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-{{ item.color|default:'primary' }}"></div>
                                                <div class="timeline-content">
                                                    <h6>{{ item.title }}</h6>
                                                    <p>{{ item.description }}</p>
                                                    <small class="text-muted">{{ item.date }}</small>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Contenido crudo (opcional) -->
                        <details class="mt-3">
                            <summary class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-code-slash me-1"></i>Ver Código Fuente
                            </summary>
                            <div class="raw-content mt-2">
{% if content_block.content_type == 'html' or content_block.content_type == 'bootstrap' %}
{{ content_block.html_content }}
{% elif content_block.content_type == 'markdown' %}
{{ content_block.markdown_content }}
{% elif content_block.content_type == 'json' %}
{{ content_block.json_content }}
{% elif content_block.content_type == 'text' %}
{{ content_block.html_content }}
{% endif %}
                            </div>
                        </details>

                        <!-- Acciones -->
                        <div class="preview-actions">
                            {% if content_block.author == user %}
                            <a href="{% url 'courses:edit_content_block' content_block.slug %}" class="btn btn-primary btn-preview-action">
                                <i class="bi bi-pencil me-1"></i>Editar Bloque
                            </a>
                            <a href="{% url 'courses:duplicate_content_block' content_block.slug %}" class="btn btn-warning btn-preview-action">
                                <i class="bi bi-copy me-1"></i>Duplicar
                            </a>
                            {% else %}
                            <a href="{% url 'courses:duplicate_content_block' content_block.slug %}" class="btn btn-warning btn-preview-action">
                                <i class="bi bi-copy me-1"></i>Usar este Bloque
                            </a>
                            {% endif %}

                            <a href="{% url 'courses:content_manager' %}" class="btn btn-outline-secondary btn-preview-action">
                                <i class="bi bi-arrow-left me-1"></i>Volver al Gestor
                            </a>

                            {% if content_block.author == user %}
                            <a href="{% url 'courses:delete_content_block' content_block.slug %}" class="btn btn-danger btn-preview-action">
                                <i class="bi bi-trash me-1"></i>Eliminar
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}